<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyStation</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isoWeek.js"></script>

    <style>

/* ===== STILE.CSS ===== */
/* ============================================
   STILE.CSS - STILI COMUNI E GLOBALI
   Contiene solo gli stili condivisi tra tutte le sezioni
   ============================================ */

/* ============================================
   RESET E CONFIGURAZIONE BASE
   ============================================ */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html {
    scroll-behavior: smooth;
}

/* ============================================
   SCROLLBAR PERSONALIZZATA
   ============================================ */
::-webkit-scrollbar {
    width: 12px;
    height: 12px;
}

::-webkit-scrollbar-track {
    background: transparent;
}

::-webkit-scrollbar-thumb {
    background-color: var(--accent-primary);
    border-radius: 20px;
}

::-webkit-scrollbar-thumb:hover {
    background-color: var(--accent-hover);
}

/* ============================================
   VARIABILI CSS E TEMI
   ============================================ */
:root {
    /* Colori Tema Chiaro (Default) */
    --bg-primary: #F5F7FA;
    --bg-secondary: #FFFFFF;
    --bg-tertiary: #E8ECF1;
    --text-primary: #1A1D26;
    --text-secondary: #4A5568;
    --text-muted: #718096;
    --accent-primary: #1D62EC;
    --accent-hover: #1E4FBF;
    --accent-success: #2ECC71;
    --accent-danger: #DC2626;
    --accent-warning: #FFC300;
    --accent-info: #3498DB;
    --accent-confirm: #FF9500;
    --border-color: #E2E8F0;
    
    /* Ombreggiature per Tema Chiaro */
    --shadow-color-rgb: 100, 116, 139;
    --shadow-sm: 0 2px 4px rgba(var(--shadow-color-rgb), 0.1);
    --shadow-md: 0 4px 12px rgba(var(--shadow-color-rgb), 0.1);
    --shadow-lg: 0 10px 25px rgba(var(--shadow-color-rgb), 0.1);
}

body.dark-theme {
    /* Colori Tema Scuro */
    --bg-primary: #0A0D14;
    --bg-secondary: #10141D;
    --bg-tertiary: #191C24;
    --text-primary: #EEEFF3;
    --text-secondary: #9498AC;
    --text-muted: #61667A;
    --accent-confirm: #FF9500;
    --border-color: #191C24;

    /* Ombreggiature per Tema Scuro */
    --shadow-color-rgb: 0, 0, 0;
    --shadow-sm: 0 2px 4px rgba(var(--shadow-color-rgb), 0.2);
    --shadow-md: 0 4px 12px rgba(var(--shadow-color-rgb), 0.25);
    --shadow-lg: 0 10px 25px rgba(var(--shadow-color-rgb), 0.3);
}

/* ============================================
   STILI GLOBALI BODY
   ============================================ */
body {
    font-family: 'Fredoka', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    overflow-x: hidden;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    transition: background-color 0.3s ease, color 0.3s ease;
    scrollbar-width: thin;
    scrollbar-color: var(--accent-primary) var(--bg-secondary);
}

/* ============================================
   LAYOUT PRINCIPALE
   ============================================ */
.app {
    display: flex;
    min-height: 100vh;
    position: relative;
}

.main-content {
    flex: 1;
    margin-left: 280px;
    padding: 40px;
    background: var(--bg-primary);
    transition: margin-left 0.3s ease, background-color 0.3s ease;
}

/* ============================================
   HEADER PAGINA
   ============================================ */
.page-header {
    margin-bottom: 32px;
}

.page-title {
    font-size: 48px;
    font-weight: 800;
    color: var(--text-primary);
    margin-bottom: 16px;
    line-height: 1.2;
}

.page-subtitle {
    font-size: 20px;
    color: var(--text-secondary);
    line-height: 1.5;
    max-width: 600px;
}

/* ============================================
   SEZIONI E CONTENITORI BASE
   ============================================ */
.page-section {
    width: 100%;
}

.content-section {
    background: var(--bg-secondary);
    border-radius: 20px;
    padding: 32px;
    border: 1px solid var(--border-color);
    margin-bottom: 24px;
    box-shadow: var(--shadow-sm);
}

/* ============================================
   TOOLBAR GENERALE
   ============================================ */
.floating-toolbar {
    margin-bottom: 24px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 12px;
    box-shadow: var(--shadow-sm);
}

.floating-toolbar.space-between {
    justify-content: space-between;
}

.toolbar-buttons {
    display: flex;
    align-items: center;
    gap: 12px;
}

.toolbar-group-left {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
}

/* ============================================
   PULSANTI TOOLBAR
   ============================================ */
.toolbar-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 16px;
    height: 48px;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    font-weight: 500;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    text-decoration: none;
}

.toolbar-btn:hover {
    background: var(--accent-primary);
    color: white;
    border-color: var(--accent-primary);
}

.toolbar-btn.active {
    background: var(--accent-primary);
    color: white;
    border-color: var(--accent-primary);
}

.toolbar-btn.success:hover {
    background: var(--accent-success);
    border-color: var(--accent-success);
    color: white;
}

.toolbar-btn.danger:hover {
    background: var(--accent-danger);
    border-color: var(--accent-danger);
    color: white;
}

.toolbar-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

.toolbar-btn i {
    width: 18px;
    height: 18px;
}

/* ============================================
   SEARCH CONTAINER
   ============================================ */
.search-container {
    position: relative;
    display: flex;
    align-items: center;
    min-width: 200px;
    max-width: 300px;
    height: 48px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0 12px;
    transition: all 0.2s ease;
}

.search-container:hover {
    border-color: var(--accent-primary);
}

.search-container:focus-within {
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(29, 98, 236, 0.1);
}

.search-container .search-input {
    background: transparent;
    border: none;
    outline: none;
    width: 100%;
    color: var(--text-primary);
    font-size: 16px;
}

.search-icon {
    color: var(--text-muted);
    margin-right: 8px;
    width: 18px;
    height: 18px;
    flex-shrink: 0;
}

.clear-search {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 6px;
    margin-left: 4px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.clear-search:hover {
    color: var(--accent-danger);
}

.clear-search i {
    width: 18px;
    height: 18px;
}

/* ============================================
   GRIGLIA SUMMARY
   ============================================ */
.summary-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
}

.summary-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 24px;
    text-align: center;
}

.summary-label {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 8px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.summary-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ============================================
   MODALI
   ============================================ */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1001;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(8px);
    opacity: 0;
    animation: fadeIn 0.3s ease forwards;
}

@keyframes fadeIn {
    to {
        opacity: 1;
    }
}

.modal-content {
    background: var(--bg-secondary);
    padding: 32px;
    border-radius: 20px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 16px;
    margin-bottom: 24px;
}

.modal-title {
    font-size: 24px;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 12px;
}

.close-btn {
    color: var(--text-secondary);
    font-size: 16px;
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    border: 1px solid var(--border-color);
    background-color: var(--bg-tertiary);
    transition: all 0.2s ease;
}

.close-btn:hover {
    background: var(--accent-danger);
    border-color: var(--accent-danger);
    color: white;
}

.modal-body {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.modal-footer {
    margin-top: 24px;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

/* ============================================
   FORM BASE
   ============================================ */
.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
}

input[type="text"],
input[type="number"],
input[type="email"],
input[type="tel"],
input[type="date"],
input[type="time"],
textarea,
select {
    width: 100%;
    padding: 12px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 16px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

:is(input, textarea, select):not(.search-input):hover {
    border-color: var(--accent-primary);
}

input[type="number"] {
    -moz-appearance: textfield;
}

input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

textarea {
    resize: vertical;
}

/* ============================================
   FOCUS STATES
   ============================================ */
:is(a, button, input, select, textarea):focus-visible {
    outline: 2px solid var(--accent-primary);
    outline-offset: 2px;
}

:is(input, textarea, select):not(.search-input):focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(29, 98, 236, 0.1);
}

:is(input, textarea, select):not(.search-input):focus-visible {
    box-shadow: none;
}

/* ============================================
   TABS GENERALI
   ============================================ */
.tab-container {
    display: flex;
    background-color: var(--bg-primary);
    border-radius: 10px;
    padding: 4px;
    border: 1px solid var(--border-color);
    height: 40px;
}

.tab-btn {
    padding: 8px 16px;
    border: none;
    background-color: transparent;
    color: var(--text-secondary);
    font-weight: 500;
    cursor: pointer;
    border-radius: 7px;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.tab-btn:hover {
    background-color: var(--bg-tertiary);
}

.tab-btn.active {
    background-color: var(--accent-primary);
    color: white;
}

/* ============================================
   PULSANTI AZIONE CIRCOLARI (per tabelle/liste)
   ============================================ */
.action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 34px;
    height: 34px;
    border: none;
    background-color: transparent;
    border-radius: 50%;
    cursor: pointer;
    color: var(--text-muted);
    transition: all 0.2s ease-in-out;
    margin: 0 2px;
}

.action-btn svg {
    width: 16px;
    height: 16px;
}

.action-btn:hover {
    background-color: var(--bg-tertiary);
}

.action-btn.edit-btn:hover {
    background-color: rgba(29, 98, 236, 0.1);
    color: var(--accent-primary);
}

.action-btn.delete-btn:hover {
    background-color: rgba(220, 38, 38, 0.1);
    color: var(--accent-danger);
}

/* Stile unificato per i campi input dei prezzi (centrati) */
.price-input-grid input,
.competition-grid input {
    text-align: center;
}

/* ============================================
   UTILITÀ
   ============================================ */
.no-data-message {
    text-align: center;
    color: var(--text-muted);
    padding: 40px 20px;
    font-style: italic;
}

.text-center {
    text-align: center;
}

.text-left {
    text-align: left;
}

.text-right {
    text-align: right;
}

/* ============================================
   RESPONSIVE
   ============================================ */
/* Adatta il contenuto principale alla sidebar contratta */
@media (max-width: 1400px) {
    .main-content {
        margin-left: 88px;
    }
}

@media (max-width: 768px) {
    .main-content {
        margin-left: 0;
        padding: 20px;
    }
    
    .page-title {
        font-size: 32px;
    }
    
    .page-subtitle {
        font-size: 16px;
    }
    
    .content-section {
        padding: 20px;
    }
    
    .floating-toolbar {
        padding: 12px 16px;
        flex-direction: column;
        align-items: stretch;
    }
    
    .toolbar-buttons {
        justify-content: center;
    }
}

@media (max-width: 480px) {
    .toolbar-btn {
        padding: 10px 12px;
        font-size: 13px;
    }
    
    .modal-content {
        width: 95%;
        padding: 24px;
    }
}

/* ===== SIDEBAR.CSS ===== */
/* ============================================
   SIDEBAR.CSS
   Stili specifici per la sidebar e navigazione
   ============================================ */

/* ============================================
   SIDEBAR CONTAINER
   ============================================ */
.sidebar {
    width: 280px;
    height: 100vh;
    position: fixed;
    left: 0;
    top: 0;
    background: var(--bg-secondary);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    transition: width 0.3s ease;
    z-index: 1001;
}

/* ============================================
   SIDEBAR HEADER
   ============================================ */
.sidebar-header {
    padding: 24px;
    border-bottom: 1px solid var(--border-color);
    transition: padding 0.3s ease;
}

.logo {
    display: flex;
    align-items: center;
    gap: 12px;
}

.logo-icon {
    width: 40px;
    height: 40px;
    background: var(--accent-primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.logo-text {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
}

/* ============================================
   SIDEBAR NAVIGATION
   ============================================ */
.sidebar-nav {
    flex: 1;
    padding: 24px 16px;
    overflow-y: auto;
    transition: padding 0.3s ease;
}

.nav-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 8px;
    transition: gap 0.3s ease;
}

.nav-item {
    width: 100%;
}

.nav-link {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-radius: 10px;
    border: none;
    background: transparent;
    width: 100%;
    text-align: left;
    color: var(--text-secondary);
    font-weight: 500;
    font-size: 16px;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s ease;
}

.nav-link:hover {
    background: var(--accent-primary);
    color: white;
}

.nav-link.active {
    background: var(--accent-primary);
    color: white;
    font-weight: 600;
}

.nav-icon {
    width: 18px;
    height: 18px;
    margin-right: 16px;
    transition: margin 0.3s ease;
}

.nav-text {
    font-size: 16px;
}

/* ============================================
   SIDEBAR FOOTER
   ============================================ */
.sidebar-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border-color);
    transition: padding 0.3s ease;
}

.footer-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 8px;
    transition: all 0.3s ease;
}

.theme-toggle-btn,
.fullscreen-btn,
.info-btn {
    width: auto;
    min-width: 40px;
    height: 40px;
    border-radius: 8px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 0 8px;
    transition: all 0.2s ease;
    flex-shrink: 0;
    font-size: 14px;
    font-weight: 500;
}

.theme-toggle-btn,
.fullscreen-btn {
    width: 40px;
}

.theme-toggle-btn:hover,
.fullscreen-btn:hover,
.info-btn:hover {
    background: var(--accent-primary);
    color: white;
    border-color: var(--accent-primary);
}

.info-btn span {
    font-size: 13px;
}

.theme-toggle-btn {
    position: relative;
}

.theme-icon {
    position: absolute;
    width: 18px;
    height: 18px;
    transition: opacity 0.3s ease, transform 0.3s ease;
}

.theme-icon.sun-icon {
    opacity: 1;
    transform: rotate(0deg);
}

.theme-icon.moon-icon {
    opacity: 0;
    transform: rotate(180deg);
}

body.dark-theme .theme-icon.sun-icon {
    opacity: 0;
    transform: rotate(-180deg);
}

body.dark-theme .theme-icon.moon-icon {
    opacity: 1;
    transform: rotate(0deg);
}

/* Correzione per l'allineamento dei pulsanti nel footer */
.footer-controls .info-btn {
    margin-left: auto;
}

/* ============================================
   MODALE INFO
   ============================================ */
.info-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(8px);
    z-index: 2000;
    display: none;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.info-modal.show {
    opacity: 1;
}

.info-modal-content {
    background: linear-gradient(135deg, #f5f7fa 0%, #e4eaf5 100%);
    border-radius: 20px;
    padding: 32px;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
}

.info-modal .modal-header {
    border-bottom-color: rgba(30, 64, 175, 0.2);
}

.info-modal .modal-title {
    color: #1e40af;
}

.info-logo-container,
.info-title,
.info-subtitle,
.info-card {
    opacity: 0;
}

.info-logo-container {
    margin-bottom: 2rem;
}

.info-logo {
    width: 120px;
    height: 120px;
    background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 auto;
    box-shadow: 0 10px 25px rgba(30, 64, 175, 0.2);
}

.info-logo svg {
    width: 80px !important;
    height: 80px !important;
    color: white !important;
    stroke: white !important;
    fill: none !important;
    stroke-width: 2.5 !important;
}

.info-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: #1e40af;
    margin-bottom: 1rem;
}

.info-subtitle {
    font-size: 1.1rem;
    font-weight: 500;
    color: #64748b;
    margin-bottom: 2rem;
    line-height: 1.4;
}

.info-cards {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    margin-top: 2rem;
}

.info-card {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 15px;
    display: flex;
    align-items: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    flex: 1;
    text-decoration: none;
    color: #1e40af;
    transition: all 0.2s ease;
}

.info-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

.info-card-icon {
    width: 24px;
    height: 24px;
    margin-right: 10px;
    color: #1e40af;
}

.info-card-text {
    font-size: 0.9rem;
    font-weight: 500;
}

.info-card .heart-icon {
    width: 16px;
    height: 16px;
    margin: 0 3px;
    color: #f97316;
    vertical-align: middle;
}

/* Tema scuro standardizzato per Modale Info */
body.dark-theme .info-modal-content {
    background: var(--bg-secondary);
    box-shadow: var(--shadow-lg);
}

body.dark-theme .info-modal .modal-header {
    border-bottom-color: var(--border-color);
}

body.dark-theme .info-modal .modal-title {
    color: var(--text-primary);
}

body.dark-theme .info-title {
    color: var(--text-primary);
}

body.dark-theme .info-subtitle {
    color: var(--text-secondary);
}

body.dark-theme .info-card {
    background: var(--bg-primary);
    color: var(--text-primary);
    box-shadow: var(--shadow-sm);
}

body.dark-theme .info-card:hover {
    box-shadow: var(--shadow-md);
}

body.dark-theme .info-card-icon {
    color: var(--text-primary);
}

/* ============================================
   MOBILE MENU BUTTON
   ============================================ */
.mobile-menu-btn {
    display: none;
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1003;
    width: 48px;
    height: 48px;
    border-radius: 10px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    cursor: pointer;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.mobile-menu-btn:hover {
    background: var(--accent-primary);
    color: white;
    border-color: var(--accent-primary);
}

/* ============================================
   SIDEBAR CONTRATTA (per schermi < 1400px)
   ============================================ */
@media (max-width: 1400px) {
    /* Nascondi l'header del logo */
    .sidebar-header {
        display: none;
    }

    /* 1. Riduci la larghezza della sidebar */
    .sidebar {
        width: 88px;
    }

    /* 2. Nascondi tutti i testi */
    .logo-text,
    .nav-text,
    .info-btn span {
        display: none;
    }

    /* 3. Centra le icone di navigazione */
    .nav-link {
        justify-content: center;
    }
    .nav-icon {
        margin-right: 0;
    }

    /* 4. Riduci il padding verticale tra i link di navigazione */
    .sidebar-nav {
        padding: 24px 12px;
    }
    .nav-list {
        gap: 4px;
    }

    /* 5. Riorganizza i pulsanti del footer in colonna */
    .sidebar-footer {
        padding: 8px 16px;
    }
    .footer-controls {
        flex-direction: column;
        gap: 8px;
        background: transparent;
        border: none;
    }
    .footer-controls .info-btn {
        margin-left: 0; /* Annulla la regola che spingeva i pulsanti a destra */
    }
    .info-btn {
        width: 40px; /* Rende il pulsante Progetto della stessa larghezza degli altri */
    }
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
    }
    
    .sidebar.open {
        transform: translateX(0);
    }
    
    .mobile-menu-btn {
        display: flex !important;
    }
}

@media (max-width: 480px) {
    .sidebar {
        width: 260px;
    }
    
    .sidebar-header {
        padding: 20px;
    }
    
    .logo-text {
        font-size: 20px;
    }
    
    .nav-link {
        padding: 10px 14px;
    }
    
    .nav-text {
        font-size: 14px;
    }
}

/* ===== HOME.CSS ===== */
/* ============================================
   HOME.CSS
   Stili specifici per la sezione Home/Dashboard
   ============================================ */

/* ============================================
   LAYOUT DASHBOARD
   ============================================ */
#home-content .content-section {
    padding: 40px;
    text-align: center;
}

/* ============================================
   SEZIONE BENVENUTO
   ============================================ */
.section-content {
    max-width: 800px;
    margin: 0 auto;
}

.section-content h2 {
    font-size: 36px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 20px;
}

.section-content p {
    font-size: 18px;
    line-height: 1.6;
    color: var(--text-secondary);
    margin-bottom: 16px;
}

/* ============================================
   ICONA DECORATIVA HOME
   ============================================ */
#home-content .lucide {
    width: 64px;
    height: 64px;
    color: var(--accent-primary);
    margin-bottom: 24px;
}

/* ============================================
   LISTA FEATURES
   ============================================ */
.features-list {
    list-style: none;
    padding: 0;
    margin-top: 32px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    text-align: left;
}

.feature-item {
    background: var(--bg-primary);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.feature-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--accent-primary);
}

.feature-icon {
    width: 32px;
    height: 32px;
    color: var(--accent-primary);
    margin-bottom: 12px;
}

.feature-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
}

.feature-description {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.5;
}

/* ============================================
   QUICK STATS (Future Dashboard Widgets)
   ============================================ */
.dashboard-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 32px;
}

.stat-card {
    background: var(--bg-primary);
    padding: 24px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    text-align: center;
}

.stat-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--accent-primary);
    margin-bottom: 8px;
}

.stat-label {
    font-size: 14px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 768px) {
    .section-content h2 {
        font-size: 28px;
    }
    
    .section-content p {
        font-size: 16px;
    }
    
    .features-list {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    #home-content .content-section {
        padding: 24px;
    }
    
    .dashboard-stats {
        grid-template-columns: 1fr;
    }
}

/* ===== ANAGRAFICA.CSS ===== */
/* ============================================
   ANAGRAFICA.CSS
   Stili specifici per la sezione Anagrafica
   ============================================ */

/* ============================================
   GRIGLIA E LAYOUT CONTATTI
   ============================================ */

/* Griglia principale che contiene tutte le card dei contatti */
.contacts-grid {
    display: grid;
    gap: 24px;
    margin-top: 24px;
    grid-template-columns: repeat(3, 1fr); /* Tre colonne su desktop */
}

/* ============================================
   CARD SINGOLO CONTATTO
   ============================================ */

/* Container principale per ogni contatto */
.contact-box {
    background: var(--bg-secondary);
    border-radius: 16px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-sm);
    transition: border-color 0.3s ease, background-color 0.3s ease;
    padding: 24px;
    position: relative; /* Per posizionare il pulsante edit */
}

/* Effetto hover sulla card contatto */
.contact-box:hover {
    border-color: rgba(29, 98, 236, 0.4);
}

/* Header della card: icona + dettagli principali */
.contact-header {
    display: flex;
    align-items: center;
    gap: 16px;
}

/* Container per l'icona del contatto con colore categoria */
.contact-icon-container {
    width: 56px;
    height: 56px;
    min-width: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    box-shadow: var(--shadow-sm);
}

/* Dettagli principali: nome e organizzazione */
.contact-details {
    flex: 1;
    min-width: 0; /* Permette il troncamento del testo */
}

/* Nome del contatto */
.contact-name {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Organizzazione del contatto */
.contact-org {
    font-size: 14px;
    color: var(--text-secondary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Lista delle informazioni aggiuntive (telefono, email, note) */
.contact-info-list {
    list-style: none;
    padding-top: 16px;
    margin-top: 16px;
    border-top: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* Singola informazione di contatto */
.contact-info-item {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    color: var(--text-secondary);
    word-break: break-all; /* Evita overflow su testi lunghi */
}

/* Icone nelle informazioni di contatto */
.contact-info-item i {
    color: var(--accent-primary);
}

/* Pulsante per modificare il contatto standardizzato */
.contact-edit-btn {
    position: absolute;
    bottom: 16px;
    right: 16px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 34px;
    height: 34px;
    background-color: transparent;
    border: none;
    border-radius: 50%;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.contact-edit-btn:hover {
    background-color: rgba(29, 98, 236, 0.1);
    color: var(--accent-primary);
}

.contact-edit-btn svg {
    width: 16px;
    height: 16px;
}

/* ============================================
   SISTEMA CATEGORIE NEI MODALI
   ============================================ */

/* Container per la selezione categoria nei modali */
.category-selection {
    margin-top: 16px;
}

/* Label categoria (nascosta per design pulito) */
.category-label {
    display: none;
}

/* Container per le opzioni radio delle categorie */
.category-options {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 0;
}

/* Singola opzione categoria (stile card) */
.category-option {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background: var(--bg-primary);
    transition: all 0.2s ease;
    min-width: 80px;
}

/* Hover generico sulle opzioni categoria */
.category-option:hover {
    border-color: var(--accent-primary);
}

/* Radio button della categoria */
.category-option input[type="radio"] {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    width: 16px;
    height: 16px;
    border: 2px solid var(--border-color);
    border-radius: 50%;
    margin-right: 8px;
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
    background: var(--bg-primary);
}

/* Stato hover del radio button */
.category-option input[type="radio"]:hover {
    border-color: var(--accent-primary);
}

/* Stato checked del radio button - solo il centro si riempie */
.category-option input[type="radio"]:checked {
    border-color: var(--accent-primary);
    background: var(--bg-primary);
}

/* Punto centrale quando selezionato */
.category-option input[type="radio"]:checked::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--accent-primary);
}

/* Testo del nome categoria */
.category-name {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-primary);
}

/* Stili specifici per categoria selezionata */
.category-option.selected-clienti {
    background-color: rgba(168, 85, 247, 0.1);
    border-color: #A855F7;
    color: #A855F7;
}

.category-option.selected-autisti {
    background-color: rgba(46, 204, 113, 0.1);
    border-color: #2ECC71;
    color: #2ECC71;
}

.category-option.selected-enilive {
    background-color: rgba(6, 182, 212, 0.1);
    border-color: #06B6D4;
    color: #06B6D4;
}

/* ============================================
   TOOLBAR ANAGRAFICA (RICERCA + FILTRI)
   ============================================ */

/* GRUPPI DELLA TOOLBAR */

/* Gruppo SINISTRA: ricerca + filtri categoria */
#anagrafica-content .toolbar-group-left {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
}

/* ============================================
   FILTRI CATEGORIA (CLIENTI/AUTISTI/ENILIVE)
   ============================================ */

/* Container dei filtri categoria */
#anagrafica-content .category-filters {
    display: flex;
    gap: 6px;
    flex-shrink: 0;
}

/* Pulsanti filtri categoria - dimensioni ottimali */
#anagrafica-content .category-filter-btn {
    padding: 12px;
    min-width: 48px;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 16px;
}

/* Hover generico per filtri categoria */
#anagrafica-content .category-filter-btn:hover {
    color: white;
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    box-shadow: var(--shadow-sm);
}

/* Hover e stato attivo CLIENTI (viola) */
#anagrafica-content .category-filter-btn[data-category="clienti"]:hover,
#anagrafica-content .category-filter-btn[data-category="clienti"].active {
    background: #A855F7;
    border-color: #A855F7;
    color: white;
    box-shadow: var(--shadow-sm);
}

/* Hover e stato attivo AUTISTI (verde) */
#anagrafica-content .category-filter-btn[data-category="autisti"]:hover,
#anagrafica-content .category-filter-btn[data-category="autisti"].active {
    background: #2ECC71;
    border-color: #2ECC71;
    color: white;
    box-shadow: var(--shadow-sm);
}

/* Hover e stato attivo ENILIVE (azzurro) */
#anagrafica-content .category-filter-btn[data-category="enilive"]:hover,
#anagrafica-content .category-filter-btn[data-category="enilive"].active {
    background: #06B6D4;
    border-color: #06B6D4;
    color: white;
    box-shadow: var(--shadow-sm);
}

/* ============================================
   PULSANTI AZIONE (NUOVO/IMPORTA/ESPORTA/ETC)
   ============================================ */

/* Gruppo DESTRA: pulsanti azione */
#anagrafica-content .toolbar-buttons {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
}

/* Pulsanti toolbar - dimensioni ottimali */
#anagrafica-content .toolbar-buttons .toolbar-btn:not(#new-contact-btn):not(#delete-all-btn) {
    padding: 12px;
    width: 48px;
    justify-content: center;
}

/* ============================================
   ACCESSIBILITÀ E STATI FOCUS
   ============================================ */

/* Stati di focus per accessibilità keyboard */
#anagrafica-content .category-filter-btn:focus-visible,
#anagrafica-content .toolbar-buttons .toolbar-btn:focus-visible {
    outline: 2px solid var(--accent-primary);
    outline-offset: 2px;
}

/* Dimensioni icone nei pulsanti */
#anagrafica-content .category-filter-btn i,
#anagrafica-content .toolbar-buttons .toolbar-btn i {
    width: 20px;
    height: 20px;
    flex-shrink: 0; /* Icone non si rimpiccioliscono */
}

/* ============================================
   STILI PER STAMPA ORIZZONTALE
   ============================================ */

@media print {
    /* Layout di pagina orizzontale */
    @page {
        size: landscape;
        margin: 1cm;
    }
    
    /* Nascondi elementi non necessari alla stampa */
    .floating-toolbar,
    .contact-edit-btn,
    nav,
    .sidebar,
    .modal {
        display: none !important;
    }
    
    /* Assicura che il contenuto si adatti al layout orizzontale */
    body {
        font-size: 10px;
        line-height: 1.3;
    }
    
    .contacts-grid {
        display: block;
        columns: 3;
        column-gap: 20px;
        column-fill: balance;
    }
    
    .contact-box {
        break-inside: avoid;
        page-break-inside: avoid;
        margin-bottom: 15px;
        border: 1px solid #333;
        padding: 10px;
    }
    
    .contact-name {
        font-size: 12px;
        font-weight: bold;
        color: #000 !important;
    }
    
    .contact-org,
    .contact-info-item {
        font-size: 9px;
        color: #666 !important; /* Colore secondario per stampa */
    }
    
    /* Forza i colori in stampa */
    * {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
}

/* ============================================
   RESPONSIVE DESIGN
   ============================================ */

/* TABLET (1024px e sotto) */
@media (max-width: 1024px) {
    /* Griglia contatti: ridurre a 2 colonne su tablet */
    .contacts-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }
    
    /* Toolbar più compatta su tablet */
    #anagrafica-content .floating-toolbar {
        padding: 12px 16px;
        gap: 8px;
    }
    
    /* Campo ricerca più piccolo */
    #anagrafica-content .search-container {
        min-width: 160px;
        max-width: 200px;
    }
}

/* MOBILE (768px e sotto) */
@media (max-width: 768px) {
    /* Griglia contatti: una sola colonna */
    .contacts-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    /* Toolbar verticale su mobile */
    #anagrafica-content .floating-toolbar {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 16px;
    }
    
    /* Gruppo search/filtri su mobile */
    #anagrafica-content .toolbar-group {
        flex-direction: column;
        gap: 12px;
        width: 100%;
    }
    
    /* Campo ricerca full-width su mobile */
    #anagrafica-content .search-container {
        min-width: 100%;
        max-width: 100%;
    }
    
    /* Bottoni toolbar full-width su mobile */
    #anagrafica-content .toolbar-btn {
        width: 100%;
        justify-content: center;
        padding: 12px;
    }
}

/* MOBILE PICCOLO (480px e sotto) */
@media (max-width: 480px) {
    /* Card contatto più compatta */
    .contact-box {
        padding: 16px;
    }
    
    /* Icona più piccola */
    .contact-icon-container {
        width: 48px;
        height: 48px;
        min-width: 48px;
    }
    
    /* Nome contatto più piccolo */
    .contact-name {
        font-size: 16px;
    }
    
    /* Lista info più compatta */
    .contact-info-list {
        gap: 6px;
        padding-top: 12px;
        margin-top: 12px;
    }
    
    .contact-info-item {
        font-size: 13px;
    }
}

/* ===== CALENDARIO.CSS ===== */
/* ============================================
   CALENDARIO.CSS - MODIFICATO
   ============================================ */

.calendar-layout { display: grid; grid-template-columns: 60% 40%; gap: 20px; height: calc(100vh - 200px); min-height: 600px; }
.calendar-container { background: var(--bg-secondary); border-radius: 16px; padding: 16px; border: 1px solid var(--border-color); overflow: hidden; display: flex; flex-direction: column; }
.calendar-internal-header { display: flex; align-items: center; justify-content: space-between; padding: 8px; margin-bottom: 12px; background: var(--bg-primary); border-radius: 12px; border: 1px solid var(--border-color); gap: 12px; }
.calendar-navigation { display: flex; align-items: center; gap: 8px; }
.calendar-internal-header .toolbar-btn { padding: 8px 12px; height: 40px; font-size: 13px; }
.calendar-internal-header .toolbar-btn i { width: 16px; height: 16px; }
.calendar-nav-btn { width: 40px; height: 40px; border: 1px solid var(--border-color); background: var(--bg-secondary); border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; color: var(--text-secondary); }
.calendar-nav-btn:hover { border-color: var(--accent-primary); background: var(--bg-tertiary); color: var(--accent-primary); }
.calendar-nav-btn i { width: 16px; height: 16px; }
.calendar-month-title { font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0 auto; flex: 1; text-align: center; white-space: nowrap; }

.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; flex: 1; }
.calendar-header { padding: 6px 2px; text-align: center; font-size: 10px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; background: var(--bg-primary); border-radius: 4px; margin-bottom: 4px; }

.calendar-day { display: flex; flex-direction: column; background: var(--bg-primary); border: 1px solid transparent; border-radius: 4px; cursor: pointer; transition: all 0.2s ease; position: relative; padding: 4px; aspect-ratio: 1; }
.calendar-day:hover { background: var(--bg-tertiary); }
.calendar-day.other-month { opacity: 0.4; }
.calendar-day-number { font-size: 14px; font-weight: 500; line-height: 1; width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s ease; z-index: 1; }
.calendar-day.selected { background-color: var(--accent-primary) !important; color: white; border-color: var(--accent-primary); }
.calendar-day.selected .calendar-day-number { background-color: white; color: var(--accent-primary); }
.calendar-day.today .calendar-day-number { background-color: var(--accent-primary); color: white; }
.calendar-day.holiday .calendar-day-number { color: var(--accent-danger); }
.calendar-day.multiday-event-bg { background-color: var(--bg-tertiary); }
.appointment-dots { display: flex; gap: 4px; justify-content: center; position: absolute; bottom: 5px; left: 0; right: 0; }
.appointment-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent-primary); }
.calendar-day.selected .appointment-dot { background: white; }

.appointments-container { background: var(--bg-secondary); border-radius: 16px; padding: 20px; border: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; }
.selected-date-info { margin-bottom: 20px; padding: 14px; background: var(--bg-primary); border-radius: 12px; border: 1px solid var(--border-color); }
#selected-date-title { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
#selected-date-subtitle { font-size: 13px; color: var(--text-secondary); }
.tab-container { display: flex; background: var(--bg-primary); border-radius: 8px; padding: 4px; gap: 2px; border: 1px solid var(--border-color); margin-bottom: 14px; }
.tab-btn { flex: 1; padding: 8px 12px; border: none; background: transparent; color: var(--text-secondary); border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s ease; text-align: center; }
.tab-btn.active { background: var(--accent-primary); color: white; }
.tab-btn:hover:not(.active) { background: var(--bg-tertiary); color: var(--text-primary); }
.appointments-content { flex: 1; overflow-y: auto; }
#appointments-list { display: flex; flex-direction: column; gap: 10px; }
.appointment-item { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; cursor: pointer; transition: all 0.2s ease; position: relative; padding-left: 20px; }
.appointment-item::before { content: ''; position: absolute; left: 6px; top: 50%; transform: translateY(-50%); width: 3px; height: calc(100% - 12px); border-radius: 2px; background: var(--accent-primary); }
.appointment-item:hover { background: var(--bg-tertiary); border-color: var(--accent-primary); }
.appointment-time { font-size: 11px; color: var(--text-muted); margin-bottom: 3px; }
.appointment-title { font-size: 14px; font-weight: 600; margin-bottom: 3px; }
.appointment-description { font-size: 12px; color: var(--text-secondary); line-height: 1.3; }
.no-appointments { text-align: center; color: var(--text-muted); padding: 30px 15px; font-style: italic; font-size: 13px; }

/* ============================================
   STILI MODALI
   ============================================ */
#new-appointment-modal .modal-content, #edit-appointment-modal .modal-content { max-width: 600px; }
.appointment-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px 20px; }
.form-group-span-2 { grid-column: 1 / -1; }
.modal-body .form-group label { font-size: 14px; font-weight: 500; color: var(--text-secondary); }
.modal-body .form-group input, .modal-body .form-group textarea { font-size: 16px; font-weight: 400; }
.form-group-compound { grid-column: 1 / -1; display: flex; align-items: flex-start; gap: 12px; flex-wrap: nowrap; }
.form-group-compound .form-group { flex: 1 1 auto; }
.form-group-compound .form-group:last-child { flex-grow: 0; flex-shrink: 0; }
.time-inputs-container { display: flex; align-items: center; gap: 4px; }
.time-inputs-container input { width: 55px; text-align: center; padding-left: 4px; padding-right: 4px; }
.time-inputs-container span { font-weight: bold; color: var(--text-secondary); }
.time-inputs-container input:disabled { background-color: var(--bg-tertiary); opacity: 0.6; cursor: not-allowed; border-color: var(--border-color); }
.custom-checkbox-container { width: 80px; height: 45px; }
.all-day-checkbox { display: none; }
.checkbox-visual { display: block; width: 100%; height: 100%; background-color: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative; }
.checkbox-visual::before { content: ''; position: absolute; top: 50%; left: 4px; transform: translateY(-50%); width: 30px; height: 37px; background-color: var(--text-secondary); border-radius: 4px; transition: all 0.2s ease; }
.all-day-checkbox:checked + .checkbox-visual::before { background-color: var(--accent-primary); transform: translate(38px, -50%); }

.recurrence-label { margin-bottom: 12px; font-weight: 500; }
.recurrence-options { display: flex; flex-wrap: wrap; gap: 16px; }
.recurrence-options label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
.recurrence-options span { font-weight: 500; }
.recurrence-options input[type="radio"] { appearance: none; width: 16px; height: 16px; border: 2px solid var(--border-color); border-radius: 50%; position: relative; cursor: pointer; transition: all 0.2s ease; background: var(--bg-primary); }
.recurrence-options input[type="radio"]:checked { border-color: var(--accent-primary); }
.recurrence-options input[type="radio"]:checked::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; border-radius: 50%; background: var(--accent-primary); }

@media (max-width: 1200px) { .calendar-layout { grid-template-columns: 55% 45%; } }
@media (max-width: 1024px) { .calendar-layout { grid-template-columns: 1fr; height: auto; gap: 16px; } .appointments-container { min-height: 350px; } }
@media (max-width: 500px) { .form-group-compound { flex-wrap: wrap; } .form-group-compound .form-group { flex-basis: calc(50% - 8px); } .custom-checkbox-container { width: 100%; flex-basis: 100%; } }

/* ===== AMMINISTRAZIONE.CSS ===== */
/* ============================================
   AMMINISTRAZIONE.CSS
   Stili specifici per la sezione Amministrazione
   ============================================ */

/* ============================================
   SUMMARY CARDS
   ============================================ */
.admin-summary {
    margin-bottom: 24px;
}

.admin-summary .summary-row {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
}

.admin-summary .summary-value {
    transition: color 0.3s ease;
    text-overflow: clip; /* FIX DEFINITIVO: Annulla l'ellipsis dal file stile.css */
}

.admin-summary .summary-value.debt {
    color: var(--accent-danger);
}

.admin-summary .summary-value.credit {
    color: var(--accent-success);
}

.admin-summary .summary-sub-value {
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 500;
    margin-top: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ============================================
   TOOLBAR AMMINISTRAZIONE
   ============================================ */
#amministrazione-content .floating-toolbar.space-between {
    display: flex;
    flex-direction: row !important;
    align-items: center;
    justify-content: space-between;
    flex-wrap: nowrap;
    gap: 12px;
    padding: 16px 24px;
}

#amministrazione-content .toolbar-group-left {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
}

/* ============================================
   GRIGLIA CLIENTI
   ============================================ */
.clients-grid {
    display: grid;
    gap: 24px;
    margin-top: 24px;
    grid-template-columns: repeat(3, 1fr);
}

/* ============================================
   CARD CLIENTE
   ============================================ */
.client-box {
    background: var(--bg-secondary);
    border-radius: 16px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-sm);
    transition: border-color 0.3s ease, background-color 0.3s ease;
    padding: 24px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    position: relative;
}

.client-box:hover {
    border-color: rgba(29, 98, 236, 0.4);
}

.client-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
}

.client-icon-container {
    width: 56px;
    height: 56px;
    min-width: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    box-shadow: var(--shadow-sm);
}

.client-details {
    flex: 1;
    min-width: 0;
}

.client-name {
    font-weight: 600;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 18px;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.client-info {
    font-size: 14px;
    color: var(--text-secondary);
}

.client-total-grid {
    font-size: 24px;
    font-weight: 600;
    transition: color 0.3s ease;
}

.client-total-grid.client-debt {
    color: var(--accent-danger);
}

.client-total-grid.client-credit {
    color: var(--accent-success);
}

.client-open-modal-btn {
    position: absolute;
    bottom: 16px;
    right: 16px;
    width: 34px;
    height: 34px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease-in-out;
    background-color: transparent;
    border: none;
    color: var(--text-muted);
}

.client-open-modal-btn:hover {
    background-color: rgba(29, 98, 236, 0.1);
    color: var(--accent-primary);
}

.client-open-modal-btn svg {
    width: 16px;
    height: 16px;
}

/* ============================================
   MODALE TRANSAZIONE
   ============================================ */
#transaction-modal .modal-content.modal-content-medium {
    max-width: 700px;
}

.modal-title #edit-client-name {
    width: 100%;
    font-size: 22px;
    font-weight: 600;
    color: var(--text-primary);
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--border-color);
    padding: 8px 4px;
    outline: none;
    transition: border-color 0.2s ease;
}

.client-balance-display {
    background-color: var(--bg-tertiary);
    border-radius: 12px;
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    margin-top: 16px;
}

.balance-label {
    font-size: 16px;
    color: var(--text-secondary);
    font-weight: 500;
}

.balance-amount {
    font-size: 24px;
    font-weight: 500;
}

.balance-amount.balance-debt {
    color: var(--accent-danger);
}

.balance-amount.balance-credit {
    color: var(--accent-success);
}

.transaction-form-inline {
    display: flex;
    gap: 12px;
    align-items: center;
}

.transaction-form-inline input {
    height: 48px;
    padding: 0 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 14px;
}

.transaction-form-inline .date-input-text {
    width: 100px;
}

.transaction-form-inline .description-input {
    flex: 1;
}

.transaction-form-inline .amount-input {
    width: 100px;
}

.btn-confirm-transaction {
    width: 48px;
    height: 48px;
    min-width: 48px;
    border-radius: 8px;
    background-color: var(--bg-tertiary);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.btn-confirm-transaction:hover {
    background-color: var(--accent-primary);
    color: white;
    border-color: var(--accent-primary);
}

.transaction-actions-compact {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
    margin-top: 24px;
}

.transaction-actions-compact .toolbar-btn {
    width: auto;
    height: auto;
    padding: 12px 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-size: 13px;
    font-weight: 500;
    border-radius: 10px;
}

/* ============================================
   MODALE STORICO TRANSAZIONI
   ============================================ */
.history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.history-filters {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}

.history-table-wrapper {
    max-height: 60vh;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 12px;
}

.history-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
}

.history-table th {
    background-color: var(--bg-primary);
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: var(--text-secondary);
    border-bottom: 2px solid var(--border-color);
}

.history-table td {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-secondary);
}

.history-table tr:hover td {
    background: var(--bg-primary);
}

/* Input inline nella tabella storico */
.history-input {
    width: 100%;
    padding: 4px 8px;
    font-size: 14px;
    background: transparent;
    border: 1px solid transparent;
    color: var(--text-primary);
    transition: all 0.2s ease;
}

.history-input:hover {
    background: var(--bg-primary);
    border-color: var(--border-color);
}

/* ============================================
   MODALE STORICO - LARGHEZZA COLONNE
   ============================================ */
.history-table th:nth-child(1),
.history-table td:nth-child(1) {
    width: 120px; 
}

.history-table th:nth-child(3),
.history-table td:nth-child(3) {
    width: 130px;
    text-align: right;
}

.history-table td:nth-child(3) .history-input {
    text-align: right;
}

.history-table th:nth-child(4),
.history-table td:nth-child(4) {
    width: 110px;
}

.history-table th:nth-child(5),
.history-table td:nth-child(5) {
    width: 80px;
    text-align: center;
}

/* ============================================
   RESPONSIVE E NUOVE REGOLE
   ============================================ */

/* Riduzione larghezza modale storico */
#history-modal .modal-content-xlarge {
    max-width: 900px;
}

@media (max-width: 1024px) {
    /* Griglia clienti: ridurre a 2 colonne su tablet */
    .clients-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .admin-summary .summary-row {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
}

@media (max-width: 768px) {
    .clients-grid {
        grid-template-columns: 1fr;
    }
    
    .admin-summary .summary-row {
        grid-template-columns: 1fr;
    }

    #amministrazione-content .floating-toolbar.space-between {
        padding: 12px 16px;
        gap: 8px;
    }
}

@media (max-width: 480px) {
    .client-box {
        padding: 16px;
    }
    
    .client-icon-container {
        width: 48px;
        height: 48px;
        min-width: 48px;
    }
    
    .client-name {
        font-size: 16px;
    }
    
    .client-total-grid {
        font-size: 20px;
    }
}

#amministrazione-content .toolbar-btn:not(#new-client-btn) {
    width: 48px;
    padding: 12px;
    justify-content: center;
}

/* ===== REGISTRO.CSS ===== */
/* ============================================
   REGISTRO.CSS
   Stili specifici per la sezione Registro di Carico
   ============================================ */

/* ============================================
   LAYOUT GENERALE
   ============================================ */
#registro-content .floating-toolbar {
    justify-content: center;
}

.registro-summary {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 24px;
}

.summary-row {
    display: grid;
    gap: 20px;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
}

.summary-card {
    background: var(--bg-secondary);
    border-radius: 16px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-sm);
    transition: border-color 0.3s ease, background-color 0.3s ease;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
}

.summary-card:hover {
    border-color: rgba(29, 98, 236, 0.4);
}

.summary-icon {
    width: 48px;
    height: 48px;
    min-width: 48px;
    background: var(--accent-primary);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
}

.summary-label {
    font-size: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
}

.summary-value {
    font-size: 24px;
    font-weight: 500;
    color: var(--text-primary);
}

/* Colori specifici per prodotto */
.summary-card.product-benzina .summary-icon {
    background-color: var(--accent-success);
}
.summary-card.product-gasolio .summary-icon {
    background-color: var(--accent-warning);
}
.summary-card.product-diesel .summary-icon {
    background-color: #fb8500;
}
.summary-card.product-hvolution .summary-icon {
    background-color: #42bfdd;
}

/* ============================================
   MODALE NUOVA/MODIFICA CONSEGNA
   ============================================ */
#new-load-modal .modal-content-medium {
    max-width: 650px;
    max-height: none;
}

.form-grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 24px;
}

.product-grid {
    display: grid;
    grid-template-columns: repeat(4, 100px); /* Colonne a larghezza fissa */
    justify-content: center; /* Centra la griglia */
    gap: 20px 16px;
    background: var(--bg-primary);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
}

.product-grid .form-group {
    text-align: center;
}

/* ============================================
   TABELLA RIEPILOGO TOTALI
   ============================================ */
.summary-table-container {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 24px;
    box-shadow: var(--shadow-sm);
    margin-bottom: 24px;
    overflow: hidden;
}

.summary-table-container .summary-table-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
}

#totale-carburanti {
    width: 100%;
    border-collapse: collapse;
    border-radius: 16px; /* Modificato */
    overflow: hidden;
    border: 1px solid var(--border-color); /* Modificato */
}

#totale-carburanti thead th {
    background-color: var(--accent-primary);
    color: #ffffff;
    font-weight: 600;
    font-size: 0.85rem;
    padding: 14px 16px;
    text-align: center;
    text-transform: uppercase;
}

#totale-carburanti tbody td {
    padding: 8px 16px;
    text-align: center;
    font-size: 0.95rem;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-color-light);
    vertical-align: middle;
}

#totale-carburanti tbody td:first-child {
    text-align: left;
}

#totale-carburanti tbody tr:last-child td {
    border-bottom: none;
}

#totale-carburanti .rimanenza-input {
    max-width: 110px;
    margin: 0 auto;
}

/* ============================================
   SEZIONE STORICO CARICO
   ============================================ */
.prices-header .toolbar-group-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.filter-select {
    height: 40px;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 0.9rem;
    color: var(--text-primary);
    -webkit-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 16px;
    padding-right: 32px;
}

.filter-select:disabled {
    background-color: var(--bg-tertiary);
    color: var(--text-muted);
    cursor: not-allowed;
    opacity: 0.7;
}

#print-registro-table-btn {
    padding: 10px;
    width: 40px;
    height: 40px;
    justify-content: center;
    flex-shrink: 0;
}

#registro-table-container {
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-sm);
    margin-top: -1px;
}

.history-table {
    width: 100%;
    border-collapse: collapse;
}

.history-table thead th {
    background-color: var(--accent-primary);
    color: #ffffff;
    font-weight: 600;
    font-size: 0.85rem;
    padding: 14px 16px;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.history-table thead th:first-child,
.history-table thead th:nth-child(2) {
    text-align: left;
}

.history-table tbody td {
    padding: 14px 16px;
    text-align: center;
    font-size: 0.95rem;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-color-light);
    vertical-align: middle;
}

.history-table tbody td:first-child,
.history-table tbody td:nth-child(2) {
    text-align: left;
}

.history-table tbody tr:last-child td {
    border-bottom: none;
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 768px) {
    .form-grid-2 {
        grid-template-columns: 1fr;
    }
    
    .summary-row {
        grid-template-columns: 1fr;
    }
}

/* ===== GESTIONE-PREZZI.CSS ===== */
/* ============================================
   GESTIONE-PREZZI.CSS
   Stili specifici per la sezione Gestione Prezzi
   ============================================ */

/* ============================================
   LAYOUT GENERALE E HEADER
   ============================================ */

#gestione-prezzi-content .floating-toolbar {
    justify-content: center;
}

.prices-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
}

.prices-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
}

.prices-date {
    font-size: 14px;
    color: var(--text-secondary);
    background-color: var(--bg-primary);
    padding: 6px 12px;
    border-radius: 8px;
}

/* ============================================
   GRIGLIE PREZZI (APPLICATI E CONCORRENZA)
   ============================================ */

.dual-card-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
}

.price-unified-card {
    background-color: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 24px;
}

.price-columns-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
}

.price-columns-container.competition-columns {
    grid-template-columns: repeat(3, 1fr);
    gap: 16px 24px;
}

.price-column-unified {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.price-column-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
    text-align: center;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
}

/* ============================================
   ELEMENTI PREZZO INDIVIDUALI
   ============================================ */

.price-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background-color: var(--bg-secondary);
    border-radius: 8px;
    border: 1px solid var(--border-color-light);
    transition: all 0.2s ease;
}

.price-item:hover {
    background-color: var(--bg-tertiary);
}

/* Nasconde AdBlue in Iperself mantenendo lo spazio per l'allineamento */
.price-item.invisible-price {
    visibility: hidden;
}

.price-item.disabled-price {
    opacity: 0.6;
    background-color: transparent;
}

.price-product-name {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
}

.price-value,
.adblue-editable-input {
    font-size: 14px;
    font-weight: 600;
    color: var(--accent-primary);
    text-align: right; /* Allinea a destra tutti i valori */
}

.adblue-editable-input {
    width: 70px !important;
    height: auto;
    padding: 4px;
    border-radius: 6px;
    border: 1px solid transparent;
    background-color: transparent;
    transition: all 0.2s ease;
    cursor: pointer;
}

.adblue-editable-input:hover {
    border-color: var(--border-color);
    background-color: var(--bg-primary);
}

.adblue-editable-input::placeholder {
    color: var(--text-muted);
    font-weight: normal;
}

.price-value.price-zero {
    color: var(--text-muted);
    font-style: italic;
}

.no-prices-message {
    text-align: center;
    color: var(--text-muted);
    padding: 40px 20px;
    font-style: italic;
    font-size: 16px;
}

/* ============================================
   DIVISORE CONCORRENZA
   ============================================ */

.competition-divider {
    width: 100%;
    height: 1px;
    background: var(--border-color);
    margin: 48px 0 36px 0; /* Gap aumentati */
    position: relative;
}

.competition-divider::before {
    content: 'DIFFERENZE PREZZI';
    position: absolute;
    left: 50%;
    top: -10px;
    transform: translateX(-50%);
    background: var(--bg-primary);
    padding: 0 12px;
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* ============================================
   STILI DIFFERENZE PREZZI
   ============================================ */

/* Elemento differenza prezzi */
.price-item.price-difference {
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-color-light);
}

.price-item.price-difference:hover {
    background-color: var(--bg-secondary);
}

/* Colori delle differenze */
.price-value.diff-positive {
    color: var(--accent-success) !important; /* Verde per differenze positive */
    font-weight: 700;
}

.price-value.diff-negative {
    color: var(--accent-danger) !important; /* Rosso per differenze negative */
    font-weight: 700;
}

.price-value.diff-neutral {
    color: var(--text-muted) !important; /* Grigio per neutro */
    font-weight: 500;
}

/* ============================================
   TABELLA STORICO PREZZI - ARROTONDATA
   ============================================ */

/* Contenitore della tabella arrotondato */
.history-list-container {
    border-radius: 16px !important;
    overflow: hidden !important;
    border: 1px solid var(--border-color) !important;
    box-shadow: var(--shadow-sm) !important;
    margin-top: 24px !important;
}

.history-list-container .history-table {
    width: 100% !important;
    border-collapse: collapse !important;
    margin: 0 !important;
    border: none !important;
}

.history-list-container .history-table thead th {
    background-color: var(--accent-primary) !important;
    color: #ffffff !important;
    font-weight: 600 !important;
    font-size: 0.85rem !important;
    padding: 14px 16px !important;
    text-align: center !important;
    text-transform: uppercase !important;
    border: none !important;
}

.history-list-container .history-table tbody td {
    padding: 14px 16px !important;
    text-align: center !important;
    font-size: 0.95rem !important;
    color: var(--text-secondary) !important;
    border-bottom: 1px solid var(--border-color-light) !important;
    border-left: none !important;
    border-right: none !important;
    vertical-align: middle !important;
}

.history-list-container .history-table thead th:first-child,
.history-list-container .history-table tbody td:first-child {
    text-align: left !important;
}

.history-list-container .history-table tbody tr:last-child td {
    border-bottom: none !important;
}

.history-list-container .history-table tbody tr:hover {
    background-color: var(--bg-tertiary) !important;
}

/* ============================================
   FILTRI STORICO PREZZI
   ============================================ */

/* Menu a discesa per i filtri dello storico */
.filter-select {
    height: 40px;
    min-width: 120px;
    padding: 8px 12px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 14px;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%239498AC' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 12px;
    transition: all 0.2s ease;
}

/* Pulsante stampa standardizzato per la toolbar dello storico */
#print-history-btn {
    padding: 10px;
    width: 40px;
    height: 40px;
    justify-content: center;
    flex-shrink: 0;
}

/* ============================================
   STILE MODALE NUOVO LISTINO PREZZI
   ============================================ */

/* Layout e dimensioni generali del modale */
#new-price-modal .modal-content {
    max-width: 480px; /* Ridotto per ottimizzare lo spazio */
}

#new-price-modal .modal-body {
    display: flex;
    flex-direction: column;
    gap: 32px;
}

/* Stile e centratura del gruppo data */
.price-date-group {
    align-items: center;
    gap: 12px;
}

.price-date-group input {
    max-width: 180px;
    text-align: center;
}

/* Griglia per i 4 prezzi (ottimizzata per la nuova larghezza) */
.price-input-grid {
    display: grid;
    grid-template-columns: repeat(2, 150px); /* Ridotto per adattarsi alla nuova larghezza */
    gap: 20px 20px; /* Ridotto gap orizzontale */
    justify-content: center;
}

.price-input-grid .form-group {
    text-align: center;
}

.price-input-grid .form-group input {
    text-align: center;
}

/* Stile del footer con il divisore */
#new-price-modal .modal-footer {
    border-top: 1px solid var(--border-color);
    margin-top: 16px;
    padding-top: 24px;
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 1024px) {
    .dual-card-container {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .prices-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .price-columns-container,
    .price-columns-container.competition-columns {
        grid-template-columns: 1fr;
    }
    
    .filter-select {
        min-width: 100%;
    }
    
    /* Gap divisore concorrenza ridotti per mobile */
    .competition-divider {
        margin: 36px 0 28px 0;
    }
    
    .competition-divider::before {
        font-size: 11px;
        padding: 0 8px;
    }
    
    /* Modale listino ridotto per mobile */
    #new-price-modal .modal-content {
        max-width: 95%;
    }
    
    .price-input-grid {
        grid-template-columns: repeat(2, 140px);
        gap: 18px;
    }
}

/* ===== CONCORRENZA.CSS ===== */
/* ============================================
   CONCORRENZA.CSS
   Stili specifici per il modale Concorrenza
   ============================================ */

/* ============================================
   GRIGLIA E COLONNE
   ============================================ */
.competition-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px; /* Ridotto per avvicinare le colonne */
    padding: 20px 0;
}

.competition-column {
    display: flex;
    flex-direction: column;
    gap: 16px;
    padding: 20px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    align-items: center; /* Aggiunto: Centra il contenuto della colonna */
}

/* ============================================
   TITOLI CONCORRENTI (con divisori colorati)
   ============================================ */
.competition-column-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    text-align: center;
    padding-bottom: 12px;
    margin-bottom: 8px;
    border-bottom: 2px solid; /* Bordo generico */
    width: 100%; /* Occupa tutta la larghezza della colonna */
}

/* Colori specifici per ogni concorrente */
.competition-column:nth-child(1) .competition-column-title {
    border-bottom-color: #FFB703; /* MyOil - Giallo */
}

.competition-column:nth-child(2) .competition-column-title {
    border-bottom-color: #DC2626; /* Esso - Rosso */
}

.competition-column:nth-child(3) .competition-column-title {
    border-bottom-color: #3498DB; /* Q8 - Blu */
}

/* ============================================
   FORM E INPUT (Stile simile al modale listino)
   ============================================ */
.competition-grid .form-group {
    text-align: center; /* Centra le etichette */
    width: 100%;
}

.competition-grid .form-group label {
    font-size: 13px;
    margin-bottom: 6px;
    color: var(--text-secondary);
}

.competition-grid .form-group input {
    max-width: 160px; /* Imposta una larghezza massima per stringere il campo */
    margin: 0 auto;   /* Centra l'input nel suo contenitore */
}

/* ============================================
   CORREZIONE ALLINEAMENTO PREZZI CONCORRENZA
   ============================================ */

/* Le colonne della concorrenza mantengono il layout standard */
.price-columns-container.competition-columns {
    grid-template-columns: repeat(3, 1fr);
    gap: 16px 24px;
}

/* Divisore orizzontale tra le due griglie */
.competition-divider {
    width: 100%;
    height: 1px;
    background: var(--border-color);
    margin: 48px 0 36px 0; /* Aumentato ulteriormente i gap */
    position: relative;
}

.competition-divider::before {
    content: 'DIFFERENZE PREZZI';
    position: absolute;
    left: 50%;
    top: -10px;
    transform: translateX(-50%);
    background: var(--bg-primary);
    padding: 0 12px;
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* ============================================
   STILI DIFFERENZE PREZZI
   ============================================ */

/* Elemento differenza prezzi */
.price-item.price-difference {
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-color-light);
}

.price-item.price-difference:hover {
    background-color: var(--bg-secondary);
}

/* Colori delle differenze */
.price-value.diff-positive {
    color: var(--accent-success) !important; /* Verde per differenze positive */
    font-weight: 700;
}

.price-value.diff-negative {
    color: var(--accent-danger) !important; /* Rosso per differenze negative */
    font-weight: 700;
}

.price-value.diff-neutral {
    color: var(--text-muted) !important; /* Grigio per neutro */
    font-weight: 500;
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 768px) {
    .competition-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .price-columns-container.competition-columns {
        grid-template-columns: 1fr;
    }
    
    .competition-divider {
        margin: 36px 0 28px 0; /* Aumentato ulteriormente anche per mobile */
    }
    
    .competition-divider::before {
        font-size: 11px;
        padding: 0 8px;
    }
}

/* ===== VIRTUALSTATION.CSS ===== */
/* ============================================
   VIRTUALSTATION.CSS
   Stili specifici per la sezione VirtualStation
   ============================================ */

/* ============================================
   TOOLBAR VIRTUALSTATION
   ============================================ */
#virtualstation-content .floating-toolbar {
    display: flex;
    justify-content: center;
}

#virtualstation-content .floating-toolbar .toolbar-btn {
    padding: 12px 16px;
    gap: 8px;
    justify-content: center;
}

/* =======================================================
   STILI HEADER E CONTENITORE TABELLA
   ======================================================= */
#virtualstation-content .prices-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border-color);
}

/* ============================================
   CONTENITORE TABELLA STORICO PREZZI ARROTONDATO
   ============================================ */
#turns-history-container {
    border-radius: 12px !important;
    overflow: hidden !important;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-sm);
    margin-top: -1px;
    max-height: none !important;
    height: auto !important;
}

/* ============================================
   TABELLA TURNI SEMPRE ESPANSA
   ============================================ */
#turns-history-container .history-table {
    width: 100%;
    border-collapse: collapse;
    max-height: none !important;
    overflow: visible !important;
}

/* Assicura che la tabella sia sempre visibile completamente anche in edit mode */
#turns-history-container.edit-mode {
    overflow: hidden !important;
    max-height: none !important;
    height: auto !important;
}

#turns-history-container .history-table thead th {
    background-color: var(--accent-primary);
    color: #ffffff;
    font-weight: 600;
    font-size: 0.85rem;
    padding: 14px 16px;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

#turns-history-container .history-table tbody td {
    padding: 14px 16px;
    text-align: center;
    font-size: 0.95rem;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-color-light);
    vertical-align: middle;
}

#turns-history-container .history-table thead th:first-child,
#turns-history-container .history-table tbody td:first-child {
    text-align: left;
}

/* Allineamento specifico per la colonna Modalità */
#turns-history-container .history-table tbody .mode-cell {
    text-align: center !important;
}

#turns-history-container .history-table tbody tr:nth-child(odd) {
    background-color: var(--bg-secondary);
}

#turns-history-container .history-table tbody tr:nth-child(even) {
    background-color: var(--bg-primary);
}

#turns-history-container .history-table tbody tr:last-child td {
    border-bottom: none;
}

/* Stile per la riga del piè di pagina (Totale) */
.history-table .table-footer {
    display: contents; /* Fa comportare il div come un gruppo di celle */
}

.history-table .table-footer > div {
    padding: 14px 16px;
    text-align: center;
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-primary);
    background-color: var(--bg-tertiary);
    vertical-align: middle;
}

.history-table .table-footer > div:first-child,
.history-table .table-footer > div:nth-child(2) {
     text-align: left;
}

/* ============================================
   EDIT MODE
   ============================================ */
.virtualstation-edit-input {
    width: 80px;
    padding: 4px;
    text-align: center;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    color: var(--text-primary);
    font-size: 0.95rem !important; /* Mantiene la stessa dimensione del testo normale della tabella */
}

/* ============================================
   MODAL NUOVO TURNO E MODIFICA TURNO
   ============================================ */
#new-turn-modal .form-grid-3,
#edit-turn-modal .form-grid-3 {
    display: grid;
    grid-template-columns: 2fr 1.5fr 0.8fr;
    gap: 16px;
}

#new-turn-modal .group-title {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    margin-top: 24px;
    margin-bottom: 12px;
    letter-spacing: 0.5px;
}

#new-turn-modal .product-inputs-grid.iperself {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
}
#new-turn-modal .product-inputs-grid.servito {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
}

#new-turn-modal .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding-top: 24px;
    margin-top: 24px;
    border-top: 1px solid var(--border-color-light);
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 768px) {
    #turns-history-container {
        overflow-x: auto;
        overflow-y: hidden;
    }
    
    #turns-history-container .history-table {
        min-width: 800px;
    }
    
    #new-turn-modal .form-grid-3,
    #edit-turn-modal .form-grid-3 {
        grid-template-columns: 1fr;
    }

    #new-turn-modal .product-inputs-grid.iperself,
    #new-turn-modal .product-inputs-grid.servito {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 480px) {
    .virtualstation-edit-input {
        width: 60px;
        font-size: 0.85rem !important; /* Ridotto proporzionalmente per mobile */
    }
}

/* ===== STATISTICHE.CSS ===== */
/* ============================================
   STATISTICHE.CSS
   Stili specifici per la sezione Statistiche
   ============================================ */

/* ============================================
   LAYOUT STATISTICHE
   ============================================ */
#statistiche-content .content-section {
    margin-bottom: 24px;
}

/* ============================================
   CARDS METRICHE
   ============================================ */
.stats-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.metric-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--accent-primary);
}

.metric-icon {
    width: 40px;
    height: 40px;
    margin: 0 auto 12px;
    color: var(--accent-primary);
}

.metric-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.metric-label {
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.metric-sublabel {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 4px;
}

/* ============================================
   CONTAINER GRAFICI
   ============================================ */
.chart-container {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
}

.chart-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 20px;
}

.chart-wrapper {
    position: relative;
    height: 300px;
    width: 100%;
}

/* Grafici a torta più piccoli */
.chart-wrapper.pie-chart {
    height: 250px;
    max-width: 250px;
    margin: 0 auto;
}

/* ============================================
   GRIGLIA GRAFICI
   ============================================ */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 24px;
    margin-bottom: 24px;
}

.charts-grid.single-column {
    grid-template-columns: 1fr;
}

/* ============================================
   TOOLBAR STATISTICHE
   ============================================ */
#statistiche-content .toolbar-group-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

#stats-period-tabs {
    margin-right: 12px;
}

#stats-value-filter {
    min-width: 120px;
}

/* ============================================
   TABELLA DETTAGLI
   ============================================ */
.stats-table-container {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 24px;
    overflow-x: auto;
}

.stats-table {
    width: 100%;
    border-collapse: collapse;
}

.stats-table th,
.stats-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.stats-table th {
    background: var(--bg-primary);
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
    font-weight: 600;
}

.stats-table tbody tr:hover {
    background: var(--bg-primary);
}

/* ============================================
   INDICATORI PERFORMANCE
   ============================================ */
.performance-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.performance-indicator.positive {
    background: rgba(46, 204, 113, 0.1);
    color: var(--accent-success);
}

.performance-indicator.negative {
    background: rgba(220, 38, 38, 0.1);
    color: var(--accent-danger);
}

.performance-indicator.neutral {
    background: rgba(148, 152, 172, 0.1);
    color: var(--text-secondary);
}

/* ============================================
   LEGENDA GRAFICI
   ============================================ */
.chart-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border-color);
    justify-content: center;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--text-secondary);
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
}

/* ============================================
   LOADING STATE
   ============================================ */
.chart-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 300px;
    color: var(--text-muted);
    font-style: italic;
}

.chart-loading::after {
    content: '';
    display: inline-block;
    width: 20px;
    height: 20px;
    margin-left: 12px;
    border: 2px solid var(--border-color);
    border-top-color: var(--accent-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 1024px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .stats-metrics {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .chart-wrapper {
        height: 250px;
    }
    
    #statistiche-content .toolbar-group-left {
        flex-direction: column;
        align-items: stretch;
        width: 100%;
    }
    
    #stats-period-tabs {
        margin-right: 0;
        margin-bottom: 12px;
    }
}

@media (max-width: 480px) {
    .stats-metrics {
        grid-template-columns: 1fr;
    }
    
    .metric-value {
        font-size: 24px;
    }
    
    .chart-container {
        padding: 16px;
    }
    
    .chart-wrapper {
        height: 200px;
    }
    
    .stats-table {
        font-size: 13px;
    }
    
    .stats-table th,
    .stats-table td {
        padding: 8px;
    }
}

/* ===== ANIMAZIONI.CSS ===== */
/* animazioni.css (SEQUENZA INVERTITA: LOGO PER ULTIMO) */

/* 1. Definizione delle animazioni (Keyframes) */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(30, 64, 175, 0.4); }
    70% { box-shadow: 0 0 0 20px rgba(30, 64, 175, 0); }
    100% { box-shadow: 0 0 0 0 rgba(30, 64, 175, 0); }
}

/* 2. Preparazione degli elementi all'animazione */
.info-modal .info-logo-container,
.info-modal .info-title,
.info-modal .info-subtitle,
.info-modal .info-card {
    opacity: 0;
}

/* 3. Applicazione delle animazioni */

/* Testi e card appaiono per primi con una dissolvenza più lenta */
.info-modal.show .info-title {
    animation: fadeIn 1.2s ease-out 0.2s forwards;
}

.info-modal.show .info-subtitle {
    animation: fadeIn 1.2s ease-out 0.2s forwards;
}

.info-modal.show .info-card:nth-child(1) {
    animation: fadeIn 0.8s ease-out 0.8s forwards;
}

.info-modal.show .info-card:nth-child(2) {
    animation: fadeIn 0.8s ease-out 1.0s forwards;
}

/* Il contenitore del logo appare per ultimo con una dissolvenza */
.info-modal.show .info-logo-container {
    animation: fadeIn 1.0s ease-out 1.4s forwards;
}

/* L'animazione pulse del logo inizia dopo che è diventato visibile */
.info-modal.show .info-logo {
    animation: pulse 2s infinite;
    animation-delay: 2.4s; /* Ritardo aumentato per partire dopo il fadeIn del logo */
}

    </style>
</head>

<body>
    <div class="app">
        
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon"><i data-lucide="bolt"></i></div>
                    <div class="logo-text">MyStation</div>
                </div>
            </div>
<nav class="sidebar-nav">
                <ul class="nav-list">
                    <li class="nav-item">
                        <button type="button" class="nav-link active" data-page="home">
                            <i data-lucide="home" class="nav-icon"></i>
                            <span class="nav-text">Home</span>
                        </button>
                    </li>
                    <li class="nav-item">
                        <button type="button" class="nav-link" data-page="anagrafica">
                            <i data-lucide="user-round-search" class="nav-icon"></i>
                            <span class="nav-text">Anagrafica</span>
                        </button>
                    </li>
                    <li class="nav-item">
                        <button type="button" class="nav-link" data-page="calendario">
                            <i data-lucide="calendar-days" class="nav-icon"></i>
                            <span class="nav-text">Calendario</span>
                        </button>
                    </li>
                    <li class="nav-item">
                        <button type="button" class="nav-link" data-page="amministrazione">
                            <i data-lucide="handshake" class="nav-icon"></i>
                            <span class="nav-text">Amministrazione</span>
                        </button>
                    </li>
                    <li class="nav-item">
                        <button type="button" class="nav-link" data-page="registro">
                            <i data-lucide="truck" class="nav-icon"></i>
                            <span class="nav-text">Registro di carico</span>
                        </button>
                    </li>
                    <li class="nav-item">
                        <button type="button" class="nav-link" data-page="gestione-prezzi">
                            <i data-lucide="euro" class="nav-icon"></i>
                            <span class="nav-text">Gestione prezzi</span>
                        </button>
                    </li>
                    <li class="nav-item">
                        <button type="button" class="nav-link" data-page="virtualstation">
                            <i data-lucide="monitor-dot" class="nav-icon"></i>
                            <span class="nav-text">VirtualStation</span>
                        </button>
                    </li>
                    <li class="nav-item">
                        <button type="button" class="nav-link" data-page="statistiche">
                            <i data-lucide="pie-chart" class="nav-icon"></i>
                            <span class="nav-text">Statistiche</span>
                        </button>
                    </li>
                </ul>
            </nav>

<div class="sidebar-footer">
                <div class="footer-controls">
                    <button class="theme-toggle-btn" id="theme-toggle">
                        <i data-lucide="sun" class="theme-icon sun-icon"></i>
                        <i data-lucide="moon" class="theme-icon moon-icon"></i>
                    </button>
                    <button class="info-btn" id="info-toggle" title="Informazioni">
                        <i data-lucide="info"></i>
                        <span>Progetto</span>
                    </button>
                    <button class="fullscreen-btn" id="fullscreen-toggle" title="Schermo intero">
                        <i data-lucide="maximize" class="maximize-icon"></i>
                        <i data-lucide="minimize" class="minimize-icon" style="display: none;"></i>
                    </button>
                </div>
            </div>
        </aside>

        <main class="main-content" id="main-content">
            <header class="page-header">
                <h1 class="page-title" id="page-title">Home</h1>
                <p class="page-subtitle" id="page-subtitle">Contenuto della sezione Home.</p>
            </header>

            <div id="home-content" class="page-section">
                <div class="content-section">
                    <div class="section-content">Benvenuto in MyStation.</div>
                </div>
            </div>

            <div id="anagrafica-content" class="page-section" style="display:none;">
                <div class="floating-toolbar space-between">
                    <div class="toolbar-group-left">
                        <div class="search-container">
                            <i data-lucide="search" class="search-icon"></i>
                            <input type="text" class="search-input" id="search-input" placeholder="Cerca contatti...">
                            <button class="clear-search" id="clear-search-btn" style="display:none;"><i data-lucide="circle-x"></i></button>
                        </div>
                        <div class="category-filters">
                            <button class="toolbar-btn category-filter-btn" data-category="clienti" title="Clienti">
                                <i data-lucide="users"></i>
                            </button>
                            <button class="toolbar-btn category-filter-btn" data-category="autisti" title="Autisti">
                                <i data-lucide="truck"></i>
                            </button>
                            <button class="toolbar-btn category-filter-btn" data-category="enilive" title="Enilive">
                                <i data-lucide="fuel"></i>
                            </button>
                        </div>
                    </div>
                    <div class="toolbar-buttons">
                        <button class="toolbar-btn success" id="new-contact-btn" title="Nuovo contatto">
                            <i data-lucide="user-plus"></i>
                            <span>Nuovo Contatto</span>
                        </button>
                        <button class="toolbar-btn" id="import-vcf-btn" title="Importa"><i data-lucide="file-input"></i></button>
                        <button class="toolbar-btn" id="export-vcf-btn" title="Esporta"><i data-lucide="file-output"></i></button>
                        <button class="toolbar-btn" id="print-contacts-btn" title="Stampa"><i data-lucide="printer"></i></button>
                        <button class="toolbar-btn danger" id="delete-all-btn" title="Elimina rubrica">
                            <i data-lucide="trash-2"></i>
                            <span>Elimina</span>
                        </button>
                    </div>
                </div>
                <div class="content-section">
                    <div class="contacts-grid" id="contacts-grid"></div>
                </div>
            </div>

            <div id="calendario-content" class="page-section" style="display:none;">
                <div class="floating-toolbar" style="justify-content: center;">
                    <div class="toolbar-buttons">
                        <button class="toolbar-btn success" id="new-appointment-btn-toolbar" title="Nuovo appuntamento">
                            <i data-lucide="plus"></i>
                            <span>Nuovo Appuntamento</span>
                        </button>
                        <button class="toolbar-btn" id="import-calendar-btn" title="Importa">
                            <i data-lucide="file-input"></i>
                            <span>Importa</span>
                        </button>
                        <button class="toolbar-btn" id="export-calendar-btn" title="Esporta">
                            <i data-lucide="file-output"></i>
                            <span>Esporta</span>
                        </button>
                        <button class="toolbar-btn" id="print-calendar-btn" title="Stampa">
                            <i data-lucide="printer"></i>
                            <span>Stampa</span>
                        </button>
                        <button class="toolbar-btn danger" id="delete-all-calendar-btn" title="Elimina calendario">
                            <i data-lucide="calendar-x"></i>
                            <span>Elimina Tutto</span>
                        </button>
                    </div>
                </div>

                <div class="calendar-layout">
                    <div class="calendar-container">
                        <div class="calendar-internal-header">
                            <div class="calendar-navigation">
                                <button class="calendar-nav-btn" id="prev-month-btn" title="Mese precedente">
                                    <i data-lucide="chevron-left"></i>
                                </button>
                                <button class="calendar-nav-btn" id="next-month-btn" title="Mese successivo">
                                    <i data-lucide="chevron-right"></i>
                                </button>
                                <button class="toolbar-btn" id="today-btn" title="Oggi">
                                    <i data-lucide="calendar-check"></i>
                                    <span>Oggi</span>
                                </button>
                            </div>
                            <h3 class="calendar-month-title" id="calendar-title">Gennaio 2025</h3>
                        </div>
                        <div class="calendar-grid" id="calendar-grid"></div>
                    </div>

                    <div class="appointments-container">
                        <div class="appointments-header">
                            <div class="tab-container" id="appointments-tabs">
                                <button class="tab-btn active" data-view="day">Giorno</button>
                                <button class="tab-btn" data-view="week">Settimana</button>
                                <button class="tab-btn" data-view="month">Mese</button>
                                <button class="tab-btn" data-view="all">Tutti</button>
                            </div>
                        </div>
                        <div class="appointments-content" id="appointments-content">
                            <div class="selected-date-info" id="selected-date-info">
                                <h3 id="selected-date-title">Oggi</h3>
                                <p id="selected-date-subtitle">Seleziona un giorno</p>
                            </div>
                            <div class="appointments-list" id="appointments-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="amministrazione-content" class="page-section" style="display:none;">
                 <div class="floating-toolbar space-between">
                    <div class="toolbar-group-left">
                        <div class="search-container">
                            <i data-lucide="search" class="search-icon"></i>
                            <input type="text" class="search-input" id="search-client-input" placeholder="Cerca cliente...">
                            <button class="clear-search" id="clear-client-search-btn" style="display:none;"><i data-lucide="circle-x"></i></button>
                        </div>
                        <button class="toolbar-btn" id="show-hide-clients-btn" title="Mostra/Nascondi schede">
                            <i data-lucide="eye"></i>
                        </button>
                        <button class="toolbar-btn" id="filter-credit-btn" title="Filtra Clienti a Credito">
                            <i data-lucide="thumbs-up"></i>
                        </button>
                        <button class="toolbar-btn" id="filter-debt-btn" title="Filtra Clienti a Debito">
                            <i data-lucide="thumbs-down"></i>
                        </button>
                    </div>
                    <div class="toolbar-buttons">
                        <button class="toolbar-btn success" id="new-client-btn" title="Nuovo cliente">
                            <i data-lucide="user-plus"></i>
                            <span>Nuovo</span>
                        </button>
                        <button class="toolbar-btn" id="import-clients-btn" title="Importa"><i data-lucide="file-input"></i></button>
                        <button class="toolbar-btn" id="export-clients-btn" title="Esporta"><i data-lucide="file-output"></i></button>
                        <button class="toolbar-btn" id="print-clients-btn" title="Stampa"><i data-lucide="printer"></i></button>
                    </div>
                </div>

                <div class="registro-summary admin-summary">
                    <div class="summary-row">
                        <div class="summary-card">
                            <div class="summary-icon"><i data-lucide="users"></i></div>
                            <div class="summary-content">
                                <div class="summary-label">Posizioni</div>
                                <div class="summary-value" id="summary-total-clients">0</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon"><i data-lucide="scale"></i></div>
                            <div class="summary-content">
                                <div class="summary-label">Saldo Netto</div>
                                <div class="summary-value" id="summary-net-balance">€ 0,00</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon"><i data-lucide="trending-up"></i></div>
                            <div class="summary-content">
                                <div class="summary-label">Esposizione Maggiore</div>
                                <div class="summary-value" id="summary-highest-debt-amount">€ 0,00</div>
                                <div class="summary-sub-value" id="summary-highest-debt-name">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="content-section">
                    <div class="clients-grid" id="clients-grid"></div>
                </div>
            </div>

            <div id="registro-content" class="page-section" style="display:none;">
                <div class="floating-toolbar">
                    <div class="toolbar-buttons">
                        <button class="toolbar-btn success" id="new-load-btn"><i data-lucide="plus"></i> Nuova Consegna</button>
                        <button class="toolbar-btn" id="import-registro-btn"><i data-lucide="file-input"></i> Importa</button>
                        <button class="toolbar-btn" id="export-registro-btn"><i data-lucide="file-output"></i> Esporta</button>
                        <button class="toolbar-btn" id="print-registro-btn"><i data-lucide="printer"></i> Stampa</button>
                        <button class="toolbar-btn danger" id="reset-year-btn"><i data-lucide="calendar-x-2"></i> Reset</button>
                    </div>
                </div>
                
                <div class="summary-table-container" id="summary-table-container"></div>
                <div class="registro-summary" id="registro-summary"></div>
                
                <div class="content-section">
                    <div class="prices-header">
                        <h2 class="prices-title">Storico Carico Carburanti</h2>
                        <div class="toolbar-group-left">
                            <div class="tab-container" id="registro-period-tabs">
                                <button class="tab-btn active" data-period="anno">Anno</button>
                                <button class="tab-btn" data-period="mese">Mese</button>
                                <button class="tab-btn" data-period="trimestre">Trimestre</button>
                                <button class="tab-btn" data-period="semestre">Semestre</button>
                            </div>
                            <select class="filter-select" id="registro-value-filter"></select>
                            <button class="toolbar-btn" id="print-registro-table-btn" title="Stampa Tabella">
                                <i data-lucide="printer"></i>
                            </button>
                        </div>
                    </div>
                    <div class="history-list-container" id="registro-table-container"></div>
                </div>
            </div>

            <div id="virtualstation-content" class="page-section" style="display:none;">
                <div class="floating-toolbar">
                    <div class="toolbar-buttons">
                        <button class="toolbar-btn success" id="new-turn-btn"><i data-lucide="plus"></i> Nuovo Turno</button>
                        <button class="toolbar-btn" id="edit-table-btn"><i data-lucide="edit"></i> Modifica</button>
                        <button class="toolbar-btn" id="import-turns-btn"><i data-lucide="file-input"></i> Importa</button>
                        <button class="toolbar-btn" id="export-turns-btn"><i data-lucide="file-output"></i> Esporta</button>
                        <button class="toolbar-btn" id="print-turns-table-btn"><i data-lucide="printer"></i> Stampa</button>
                    </div>
                </div>
                
                <div class="content-section">
                    <div class="prices-header">
                        <h2 class="prices-title">Storico Turni</h2>
                    </div>
                    <div class="history-list-container" id="turns-history-container"></div>
                </div>
            </div>

            <div id="gestione-prezzi-content" class="page-section" style="display:none;">
                <div class="floating-toolbar">
                    <div class="toolbar-buttons">
                        <button class="toolbar-btn success" id="new-price-list-btn">
                            <i data-lucide="bell-ring"></i>
                            <span>Nuovo Listino</span>
                        </button>
                        <button class="toolbar-btn" id="competition-btn">
                            <i data-lucide="frown"></i>
                            <span>Concorrenza</span>
                        </button>
                        <button class="toolbar-btn" id="import-prices-btn"><i data-lucide="file-input"></i> Importa</button>
                        <button class="toolbar-btn" id="export-prices-btn"><i data-lucide="file-output"></i> Esporta</button>
                        <button class="toolbar-btn" id="print-report-btn"><i data-lucide="printer"></i> Stampa</button>
                    </div>
                </div>

                <div id="printable-report-area">
                    <div class="dual-card-container">
                        <div class="content-section">
                            <div class="prices-header">
                                <h2 class="prices-title">Prezzi Applicati</h2>
                                <span class="prices-date" id="applied-prices-date">Nessun listino impostato</span>
                            </div>
                            <div class="prices-grid-unified" id="prices-grid-display"></div>
                        </div>
                        <div class="content-section">
                            <div class="prices-header">
                                <h2 class="prices-title">Prezzi Concorrenza</h2>
                            </div>
                            <div class="prices-grid-unified" id="competition-grid-display"></div>
                        </div>
                    </div>
                </div>

                <div class="content-section">
                    <div class="prices-header">
                        <h2 class="prices-title">Storico Variazioni Prezzi</h2>
                        <div class="toolbar-group-left">
                            <div class="tab-container" id="period-tabs">
                                <button class="tab-btn active" data-period="anno">Anno</button>
                                <button class="tab-btn" data-period="mese">Mese</button>
                                <button class="tab-btn" data-period="trimestre">Trimestre</button>
                                <button class="tab-btn" data-period="semestre">Semestre</button>
                            </div>
                            <select class="filter-select" id="price-history-value-filter"></select>
                            <button class="toolbar-btn" id="print-history-btn" title="Stampa Storico">
                                <i data-lucide="printer"></i>
                            </button>
                        </div>
                    </div>
                    <div class="history-list-container" id="price-history-container"></div>
                </div>
            </div>

            <div id="statistiche-content" class="page-section" style="display:none;">
                <div class="floating-toolbar space-between">
                    <div class="toolbar-group-left">
                        <div class="tab-container" id="stats-period-tabs">
                            <button class="tab-btn active" data-period="giornata">Oggi</button>
                            <button class="tab-btn" data-period="settimana">Settimana</button>
                            <button class="tab-btn" data-period="mese">Mese</button>
                            <button class="tab-btn" data-period="trimestre">Trimestre</button>
                            <button class="tab-btn" data-period="semestre">Semestre</button>
                            <button class="tab-btn" data-period="anno">Anno</button>
                        </div>
                        <select class="filter-select" id="stats-value-filter"></select>
                    </div>
                    <div class="toolbar-buttons">
                        <button class="toolbar-btn" id="import-stats-btn" title="Importa dati"><i data-lucide="file-input"></i></button>
                        <button class="toolbar-btn" id="export-stats-btn" title="Esporta dati"><i data-lucide="file-output"></i></button>
                        <button class="toolbar-btn" id="print-stats-btn" title="Stampa report"><i data-lucide="printer"></i></button>
                    </div>
                </div>
                <div class="registro-summary" id="stats-summary">
                    <div class="summary-row">
                        <div class="summary-card">
                            <div class="summary-icon"><i data-lucide="wallet"></i></div>
                            <div class="summary-content">
                                <div class="summary-label">Fatturato</div>
                                <div class="summary-value" id="stats-total-revenue">€ 0,00</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon"><i data-lucide="fuel"></i></div>
                            <div class="summary-content">
                                <div class="summary-label">Litri Erogati</div>
                                <div class="summary-value" id="stats-total-liters">0</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon"><i data-lucide="users"></i></div>
                            <div class="summary-content">
                                <div class="summary-label">Servito</div>
                                <div class="summary-value" id="stats-servito-ratio">0%</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon"><i data-lucide="droplet"></i></div>
                            <div class="summary-content">
                                <div class="summary-label" id="stats-top-product-label">Prodotto Top</div>
                                <div class="summary-value" id="stats-top-product">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="charts-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-top: 24px;">
                    <div class="content-section">
                        <h3 class="summary-table-title">VENDITE PER PRODOTTO</h3>
                        <canvas id="product-sales-chart"></canvas>
                    </div>
                    <div class="content-section">
                         <h3 class="summary-table-title">MODALITÀ DI SERVIZIO</h3>
                        <canvas id="service-mode-chart"></canvas>
                    </div>
                </div>
                
                <div class="content-section" style="margin-top: 24px;">
                    <h3 class="summary-table-title">ANDAMENTO VENDITE (LITRI)</h3>
                    <div style="height: 400px; position: relative;">
                         <canvas id="sales-trend-chart"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <input type="file" id="vcf-file-input" accept=".vcf" style="display: none;">
    <input type="file" id="clients-file-input" accept=".json" style="display: none;">
    <input type="file" id="registro-file-input" accept=".json" style="display: none;">
    <input type="file" id="prices-file-input" accept=".json" style="display: none;">
    <input type="file" id="turns-file-input" accept=".json" style="display: none;">
    <input type="file" id="calendar-file-input" accept=".json" style="display: none;">

    <div id="custom-alert-box" class="custom-alert"></div>

    <div id="new-contact-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Nuovo Contatto</h2>
                <span class="close-btn" id="close-modal-btn"><i data-lucide="x"></i></span>
            </div>
            <div class="modal-body">
                <input type="text" id="contact-name" placeholder="Nome Completo" required>
                <input type="text" id="contact-org" placeholder="Organizzazione">
                <input type="tel" id="contact-tel" placeholder="Telefono">
                <input type="email" id="contact-email" placeholder="Email">
                <input type="text" id="contact-notes" placeholder="Note">
                
                <div class="category-selection">
                    <label class="category-label">Categoria:</label>
                    <div class="category-options">
                        <label class="category-option"><input type="radio" name="contact-category" value="clienti" checked><span class="category-name" data-category="clienti">Clienti</span></label>
                        <label class="category-option"><input type="radio" name="contact-category" value="autisti"><span class="category-name" data-category="autisti">Autisti</span></label>
                        <label class="category-option"><input type="radio" name="contact-category" value="enilive"><span class="category-name" data-category="enilive">Enilive</span></label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="toolbar-btn success" id="save-contact-btn"><i data-lucide="save"></i> Salva</button>
            </div>
        </div>
    </div>

    <div id="edit-contact-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Modifica Contatto</h2>
                <span class="close-btn" id="close-edit-modal-btn"><i data-lucide="x"></i></span>
            </div>
            <div class="modal-body">
                <input type="text" id="edit-contact-name" placeholder="Nome Completo" required>
                <input type="text" id="edit-contact-org" placeholder="Organizzazione">
                <input type="tel" id="edit-contact-tel" placeholder="Telefono">
                <input type="email" id="edit-contact-email" placeholder="Email">
                <input type="text" id="edit-contact-notes" placeholder="Note">
                
                <div class="category-selection">
                    <label class="category-label">Categoria:</label>
                    <div class="category-options">
                        <label class="category-option"><input type="radio" name="edit-contact-category" value="clienti"><span class="category-name" data-category="clienti">Clienti</span></label>
                        <label class="category-option"><input type="radio" name="edit-contact-category" value="autisti"><span class="category-name" data-category="autisti">Autisti</span></label>
                        <label class="category-option"><input type="radio" name="edit-contact-category" value="enilive"><span class="category-name" data-category="enilive">Enilive</span></label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="toolbar-btn danger" id="delete-contact-btn" style="margin-right: auto;"><i data-lucide="trash-2"></i> Elimina</button>
                <button class="toolbar-btn success" id="save-edit-contact-btn"><i data-lucide="save"></i> Salva Modifiche</button>
            </div>
        </div>
    </div>

    <div id="new-client-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Nuovo Cliente</h2>
                <span class="close-btn" id="close-client-modal-btn"><i data-lucide="x"></i></span>
            </div>
            <div class="modal-body">
                <input type="text" id="client-name-input" placeholder="Nome Cliente" required>
                <input type="text" id="client-initial-balance" placeholder="Saldo iniziale (credito)" pattern="[0-9,]*">
            </div>
            <div class="modal-footer">
                <button class="toolbar-btn success" id="save-client-btn"><i data-lucide="save"></i> Salva Cliente</button>
            </div>
        </div>
    </div>

    <div id="transaction-modal" class="modal">
        <div class="modal-content modal-content-medium">
            <div class="modal-header">
                <div class="modal-title"><span id="client-name-header"></span></div>
                <span class="close-btn" id="close-transaction-modal-btn"><i data-lucide="x"></i></span>
            </div>
            <div class="client-balance-display">
                <span class="balance-label">Saldo attuale:</span>
                <span id="client-balance-header" class="balance-amount"></span>
            </div>
            <div class="modal-body">
                <div class="transaction-form-inline">
                    <input type="text" id="transaction-date" placeholder="GG/MM/AAAA" class="date-input-text">
                    <input type="text" id="transaction-description" placeholder="Descrizione (default: Carburante)" class="description-input">
                    <input type="text" id="transaction-amount" placeholder="Importo (€)" class="amount-input">
                    <button class="btn-confirm-transaction" id="confirm-transaction-btn" title="Aggiungi addebito"><i data-lucide="plus"></i></button>
                </div>
            </div>
            <div class="modal-footer transaction-actions-compact">
                <button class="toolbar-btn success" id="pay-full-btn"><i data-lucide="check-circle"></i><span>Salda</span></button>
                <button class="toolbar-btn" id="pay-partial-btn"><i data-lucide="coins"></i><span>Acconto</span></button>
                <button class="toolbar-btn" id="print-transaction-btn"><i data-lucide="printer"></i><span>Stampa</span></button>
                <button class="toolbar-btn" id="view-history-btn"><i data-lucide="history"></i><span>Storico</span></button>
                <button class="toolbar-btn danger" id="delete-client-btn"><i data-lucide="trash-2"></i><span>Elimina</span></button>
            </div>
        </div>
    </div>

    <div id="history-modal" class="modal">
        <div class="modal-content modal-content-xlarge">
            <div class="modal-header">
                <h2 class="modal-title">Storico - <span id="history-client-name"></span></h2>
                <span class="close-btn" id="close-history-modal-btn"><i data-lucide="x"></i></span>
            </div>
            <div class="modal-body">
                <div class="history-table-wrapper">
                    <table class="history-table">
                        <thead><tr><th>Data</th><th>Descrizione</th><th>Importo</th><th>Tipo</th><th>Azioni</th></tr></thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="new-load-modal" class="modal">
        <div class="modal-content modal-content-medium">
            <div class="modal-header">
                <h2 class="modal-title">Nuova Consegna</h2>
                <span class="close-btn" id="close-load-modal-btn"><i data-lucide="x"></i></span>
            </div>
            <div class="modal-body">
                <div class="form-grid-2">
                    <div class="form-group"><label for="load-date">Data *</label><input type="text" id="load-date" placeholder="GG/MM/AAAA" required></div>
                    <div class="form-group"><label for="load-driver">Autista *</label><input type="text" id="load-driver" placeholder="Nome autista" required></div>
                </div>
                <div class="product-grid">
                    <div class="form-group"><label for="load-benzina">Benzina (L)</label><input type="number" id="load-benzina" placeholder="0" min="0"></div>
                    <div class="form-group"><label for="load-gasolio">Gasolio (L)</label><input type="number" id="load-gasolio" placeholder="0" min="0"></div>
                    <div class="form-group"><label for="load-diesel">Diesel+ (L)</label><input type="number" id="load-diesel" placeholder="0" min="0"></div>
                    <div class="form-group"><label for="load-hvolution">Hvolution (L)</label><input type="number" id="load-hvolution" placeholder="0" min="0"></div>
                    <div class="form-group"><label for="load-diff-benzina">Diff. Benzina</label><input type="number" id="load-diff-benzina" placeholder="0"></div>
                    <div class="form-group"><label for="load-diff-gasolio">Diff. Gasolio</label><input type="number" id="load-diff-gasolio" placeholder="0"></div>
                    <div class="form-group"><label for="load-diff-diesel">Diff. Diesel+</label><input type="number" id="load-diff-diesel" placeholder="0"></div>
                    <div class="form-group"><label for="load-diff-hvolution">Diff. Hvolution</label><input type="number" id="load-diff-hvolution" placeholder="0"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="toolbar-btn success" id="save-load-btn"><i data-lucide="save"></i> Salva Consegna</button>
            </div>
        </div>
    </div>

    <div id="new-turn-modal" class="modal">
        <div class="modal-content modal-content-large">
            <form id="new-turn-form">
                <div class="modal-header">
                    <h2 class="modal-title">Nuovo Turno</h2>
                    <span class="close-btn" id="close-turn-modal-btn"><i data-lucide="x"></i></span>
                </div>
                <div class="modal-body">
                    <div class="form-grid-3">
                        <div class="form-group"><label for="turn-shift">Turno *</label><input type="text" id="turn-shift" name="shift" placeholder="Es. Mattina, 1, A..." required></div>
                        <div class="form-group"><label for="turn-date">Data</label><input type="text" id="turn-date" name="date" readonly></div>
                        <div class="form-group"><label for="turn-time">Orario</label><input type="text" id="turn-time" name="time" readonly></div>
                    </div>
                    <h3 class="group-title">IPERSELF</h3>
                    <div class="product-inputs-grid iperself">
                        <div class="form-group"><label>Gasolio</label><input type="number" name="iperself-gasolio" placeholder="0" min="0" step="any"></div>
                        <div class="form-group"><label>Diesel+</label><input type="number" name="iperself-diesel" placeholder="0" min="0" step="any"></div>
                        <div class="form-group"><label>Benzina</label><input type="number" name="iperself-benzina" placeholder="0" min="0" step="any"></div>
                        <div class="form-group"><label>Hvolution</label><input type="number" name="iperself-hvolution" placeholder="0" min="0" step="any"></div>
                    </div>
                    <h3 class="group-title">SERVITO</h3>
                    <div class="product-inputs-grid servito">
                        <div class="form-group"><label>Gasolio</label><input type="number" name="servito-gasolio" placeholder="0" min="0" step="any"></div>
                        <div class="form-group"><label>Diesel+</label><input type="number" name="servito-diesel" placeholder="0" min="0" step="any"></div>
                        <div class="form-group"><label>AdBlue</label><input type="number" name="servito-adblue" placeholder="0" min="0" step="any"></div>
                        <div class="form-group"><label>Benzina</label><input type="number" name="servito-benzina" placeholder="0" min="0" step="any"></div>
                        <div class="form-group"><label>Hvolution</label><input type="number" name="servito-hvolution" placeholder="0" min="0" step="any"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="toolbar-btn danger" id="cancel-turn-btn"><i data-lucide="x"></i> Annulla</button>
                    <button type="submit" class="toolbar-btn success" id="save-turn-btn"><i data-lucide="check"></i> Conferma</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-turn-modal" class="modal">
        <div class="modal-content modal-content-large">
            <form id="edit-turn-form">
                <div class="modal-header">
                    <h2 class="modal-title">Modifica Turno</h2>
                    <span class="close-btn" id="close-edit-turn-modal-btn"><i data-lucide="x"></i></span>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-turn-id" name="id">
                    <div class="form-grid-3">
                        <div class="form-group"><label for="edit-turn-shift">Turno *</label><input type="text" id="edit-turn-shift" name="shift" required></div>
                        <div class="form-group"><label for="edit-turn-date">Data</label><input type="text" id="edit-turn-date" name="date"></div>
                        <div class="form-group"><label for="edit-turn-time">Orario</label><input type="text" id="edit-turn-time" name="time"></div>
                    </div>
                     <div class="product-group">
                        <h3 class="group-title">IPERSELF</h3>
                        <div class="product-inputs-grid iperself">
                            <div class="form-group"><label>Gasolio</label><input type="number" id="edit-turn-iperself-gasolio" name="iperself-gasolio" placeholder="0" min="0" step="any"></div>
                            <div class="form-group"><label>Diesel+</label><input type="number" id="edit-turn-iperself-diesel" name="iperself-diesel" placeholder="0" min="0" step="any"></div>
                            <div class="form-group"><label>Benzina</label><input type="number" id="edit-turn-iperself-benzina" name="iperself-benzina" placeholder="0" min="0" step="any"></div>
                            <div class="form-group"><label>Hvolution</label><input type="number" id="edit-turn-iperself-hvolution" name="iperself-hvolution" placeholder="0" min="0" step="any"></div>
                        </div>
                    </div>
                    <div class="product-group">
                        <h3 class="group-title">SERVITO</h3>
                        <div class="product-inputs-grid servito">
                            <div class="form-group"><label>Gasolio</label><input type="number" id="edit-turn-servito-gasolio" name="servito-gasolio" placeholder="0" min="0" step="any"></div>
                            <div class="form-group"><label>Diesel+</label><input type="number" id="edit-turn-servito-diesel" name="servito-diesel" placeholder="0" min="0" step="any"></div>
                            <div class="form-group"><label>AdBlue</label><input type="number" id="edit-turn-servito-adblue" name="servito-adblue" placeholder="0" min="0" step="any"></div>
                            <div class="form-group"><label>Benzina</label><input type="number" id="edit-turn-servito-benzina" name="servito-benzina" placeholder="0" min="0" step="any"></div>
                            <div class="form-group"><label>Hvolution</label><input type="number" id="edit-turn-servito-hvolution" name="servito-hvolution" placeholder="0" min="0" step="any"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="toolbar-btn danger" id="delete-edit-turn-btn"><i data-lucide="trash-2"></i> Elimina</button>
                    <button type="button" class="toolbar-btn" id="cancel-edit-turn-btn"><i data-lucide="x"></i> Annulla</button>
                    <button type="submit" class="toolbar-btn success" id="save-edit-turn-btn"><i data-lucide="save"></i> Salva</button>
                </div>
            </form>
        </div>
    </div>

    <div id="new-price-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Nuovo Listino Prezzi</h2>
                <span class="close-btn" id="close-price-modal-btn"><i data-lucide="x"></i></span>
            </div>
            <div class="modal-body">
                <div class="form-group price-date-group">
                    <label for="price-date">Data validità *</label>
                    <input type="text" id="price-date" placeholder="GG/MM/AAAA" required>
                </div>
                <div class="price-input-grid">
                    <div class="form-group"><label for="price-benzina">Benzina (€)</label><input type="text" id="price-benzina" placeholder="0.000"></div>
                    <div class="form-group"><label for="price-diesel">Diesel+ (€)</label><input type="text" id="price-diesel" placeholder="0.000"></div>
                    <div class="form-group"><label for="price-gasolio">Gasolio (€)</label><input type="text" id="price-gasolio" placeholder="0.000"></div>
                    <div class="form-group"><label for="price-hvolution">Hvolution (€)</label><input type="text" id="price-hvolution" placeholder="0.000"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="toolbar-btn success" id="save-price-btn"><i data-lucide="save"></i> Salva Listino</button>
            </div>
        </div>
    </div>
    
    <div id="competition-modal" class="modal">
        <div class="modal-content modal-content-medium">
            <div class="modal-header">
                <h2 class="modal-title">Prezzi Concorrenza</h2>
                <span class="close-btn" id="close-competition-modal-btn"><i data-lucide="x"></i></span>
            </div>
            <div class="modal-body">
                <div class="competition-grid">
                    <div class="competition-column">
                        <h3 class="competition-column-title">MyOil</h3>
                        <div class="form-group"><label for="comp-myoil-benzina">Benzina (€)</label><input type="text" id="comp-myoil-benzina" placeholder="0.000"></div>
                        <div class="form-group"><label for="comp-myoil-gasolio">Gasolio (€)</label><input type="text" id="comp-myoil-gasolio" placeholder="0.000"></div>
                    </div>
                    <div class="competition-column">
                        <h3 class="competition-column-title">Esso</h3>
                        <div class="form-group"><label for="comp-esso-benzina">Benzina (€)</label><input type="text" id="comp-esso-benzina" placeholder="0.000"></div>
                        <div class="form-group"><label for="comp-esso-gasolio">Gasolio (€)</label><input type="text" id="comp-esso-gasolio" placeholder="0.000"></div>
                    </div>
                    <div class="competition-column">
                        <h3 class="competition-column-title">Q8</h3>
                        <div class="form-group"><label for="comp-q8-benzina">Benzina (€)</label><input type="text" id="comp-q8-benzina" placeholder="0.000"></div>
                        <div class="form-group"><label for="comp-q8-gasolio">Gasolio (€)</label><input type="text" id="comp-q8-gasolio" placeholder="0.000"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="toolbar-btn success" id="save-competition-btn"><i data-lucide="save"></i> Salva Dati</button>
            </div>
        </div>
    </div>

    <div id="new-appointment-modal" class="modal">
        <div class="modal-content">
            <form>
                <div class="modal-header">
                    <h2 class="modal-title">Nuovo Appuntamento</h2>
                    <span class="close-btn"><i data-lucide="x"></i></span>
                </div>
                <div class="modal-body">
                    <div class="appointment-form-grid">
                        <div class="form-group form-group-span-2"><label for="appointment-title">Titolo *</label><input type="text" id="appointment-title" required></div>
                        <div class="form-group"><label for="appointment-start-date">Data Inizio *</label><input type="text" id="appointment-start-date" required></div>
                        <div class="form-group"><label for="appointment-end-date">Data Fine *</label><input type="text" id="appointment-end-date" required></div>
                        <div class="form-group-compound form-group-span-2">
                            <div class="form-group"><label>Ora Inizio</label><div class="time-inputs-container"><input type="text" id="appointment-start-hour" maxlength="2"><span>:</span><input type="text" id="appointment-start-minute" maxlength="2"></div></div>
                            <div class="form-group"><label>Ora Fine</label><div class="time-inputs-container"><input type="text" id="appointment-end-hour" maxlength="2"><span>:</span><input type="text" id="appointment-end-minute" maxlength="2"></div></div>
                            <div class="form-group"><label for="appointment-all-day">Tutto il giorno</label><div class="custom-checkbox-container"><input type="checkbox" id="appointment-all-day" class="all-day-checkbox"><label for="appointment-all-day" class="checkbox-visual"></label></div></div>
                        </div>
                        <div class="form-group form-group-span-2"><label for="appointment-description">Descrizione</label><textarea id="appointment-description" rows="3"></textarea></div>
                        <div class="form-group form-group-span-2">
                            <label class="recurrence-label">Ricorrenza</label>
                            <div class="recurrence-options">
                                <label><input type="radio" name="appointment-recurrence" value="none" checked><span>Nessuna</span></label>
                                <label><input type="radio" name="appointment-recurrence" value="daily"><span>Giornaliera</span></label>
                                <label><input type="radio" name="appointment-recurrence" value="weekly"><span>Settimanale</span></label>
                                <label><input type="radio" name="appointment-recurrence" value="monthly"><span>Mensile</span></label>
                                <label><input type="radio" name="appointment-recurrence" value="yearly"><span>Annuale</span></label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="toolbar-btn danger cancel-btn" id="cancel-appointment-btn"><i data-lucide="x"></i><span>Annulla</span></button>
                    <button type="button" class="toolbar-btn success" id="save-appointment-btn"><i data-lucide="save"></i><span>Salva Appuntamento</span></button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-appointment-modal" class="modal">
        <div class="modal-content">
            <form>
                <div class="modal-header">
                    <h2 class="modal-title">Modifica Appuntamento</h2>
                    <span class="close-btn"><i data-lucide="x"></i></span>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-appointment-id">
                    <div class="appointment-form-grid">
                        <div class="form-group form-group-span-2"><label for="edit-appointment-title">Titolo *</label><input type="text" id="edit-appointment-title" required></div>
                        <div class="form-group"><label for="edit-appointment-start-date">Data Inizio *</label><input type="text" id="edit-appointment-start-date" required></div>
                        <div class="form-group"><label for="edit-appointment-end-date">Data Fine *</label><input type="text" id="edit-appointment-end-date" required></div>
                        <div class="form-group-compound form-group-span-2">
                            <div class="form-group"><label>Ora Inizio</label><div class="time-inputs-container"><input type="text" id="edit-appointment-start-hour" maxlength="2"><span>:</span><input type="text" id="edit-appointment-start-minute" maxlength="2"></div></div>
                            <div class="form-group"><label>Ora Fine</label><div class="time-inputs-container"><input type="text" id="edit-appointment-end-hour" maxlength="2"><span>:</span><input type="text" id="edit-appointment-end-minute" maxlength="2"></div></div>
                            <div class="form-group"><label for="edit-appointment-all-day">Tutto il giorno</label><div class="custom-checkbox-container"><input type="checkbox" id="edit-appointment-all-day" class="all-day-checkbox"><label for="edit-appointment-all-day" class="checkbox-visual"></label></div></div>
                        </div>
                        <div class="form-group form-group-span-2"><label for="edit-appointment-description">Descrizione</label><textarea id="edit-appointment-description" rows="3"></textarea></div>
                         <div class="form-group form-group-span-2">
                            <label class="recurrence-label">Ricorrenza</label>
                            <div class="recurrence-options">
                                <label><input type="radio" name="edit-appointment-recurrence" value="none" checked><span>Nessuna</span></label>
                                <label><input type="radio" name="edit-appointment-recurrence" value="daily"><span>Giornaliera</span></label>
                                <label><input type="radio" name="edit-appointment-recurrence" value="weekly"><span>Settimanale</span></label>
                                <label><input type="radio" name="edit-appointment-recurrence" value="monthly"><span>Mensile</span></label>
                                <label><input type="radio" name="edit-appointment-recurrence" value="yearly"><span>Annuale</span></label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="toolbar-btn danger" id="delete-appointment-btn" style="margin-right: auto;"><i data-lucide="trash-2"></i><span>Elimina</span></button>
                    <button type="button" class="toolbar-btn danger cancel-btn" id="cancel-edit-appointment-btn"><i data-lucide="x"></i><span>Annulla</span></button>
                    <button type="button" class="toolbar-btn success" id="save-edit-appointment-btn"><i data-lucide="save"></i><span>Salva Modifiche</span></button>
                </div>
            </form>
        </div>
    </div>

    <div class="info-modal" id="info-modal">
        <div class="info-modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Informazioni</h2>
                <span class="close-btn" id="info-modal-close"><i data-lucide="x"></i></span>
            </div>
            <div class="info-logo-container">
                <div class="info-logo"><i data-lucide="bolt"></i></div>
            </div>
            <h1 class="info-title">MyStation</h1>
            <p class="info-subtitle">MyStation è un'applicazione web pensata per la gestione completa di una stazione di servizio. Permette di centralizzare e monitorare anagrafiche, calendario, amministrazione, registro di carico, prezzi e statistiche di vendita, con funzioni di stampa ed esportazione.</p>
            <div class="info-cards">
                <a href="https://github.com/tytus44/MyStation" target="_blank" class="info-card">
                    <i data-lucide="github" class="info-card-icon"></i>
                    <div class="info-card-text">Progetto su GitHub</div>
                </a>
                <div class="info-card">
                    <i data-lucide="braces" class="info-card-icon"></i>
                    <div class="info-card-text">Sviluppato con <i data-lucide="heart" class="heart-icon"></i> da NeRO</div>
                </div>
            </div>
        </div>
    </div>
    
    <script defer src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.lucide) {
                lucide.createIcons();
            }
        });
    </script>

    <script>

/* ===== MEMORIA.JS ===== */
/**
 * MEMORIA.JS
 * Sistema unificato di gestione localStorage e stato UI per MyStation
 */

const MemoriaStorage = {
    
    keys: {
        anagrafica: 'mystation_anagrafica_contacts',
        amministrazione: 'mystation_amministrazione_clients',
        registro: 'mystation_registro_loads',
        // Aggiunta nuova chiave per le rimanenze
        rimanenze: 'mystation_registro_rimanenze',
        virtualstation: 'mystation_virtualstation_turns',
        prezzi: 'mystation_gestione_prezzi_storico', 
        concorrenza: 'mystation_concorrenza_prezzi',
        calendario: 'mystation_calendario_appointments',
        theme: 'mystation_theme',
        viewPreferences: 'mystation_view_prefs',
        lastBackup: 'mystation_last_backup'
    },
    
    colorPalette: ['#fb8500', '#ffb703', '#42bfdd', '#ff66b3', '#2ec4b6', '#7678ed', '#16db65', '#0072f5', '#fa3e41'],
    availableColorsBySection: {},

    // ============================================
    // METODI GENERALI
    // ============================================
    isAvailable() {
        try {
            const test = '__localStorage_test__';
            localStorage.setItem(test, test);
            localStorage.removeItem(test);
            return true;
        } catch (e) {
            console.error('localStorage non disponibile:', e);
            return false;
        }
    },
    
    // ============================================
    // GESTIONE COLORI CENTRALIZZATA
    // ============================================
    getNextColor(section) {
        if (!this.availableColorsBySection[section] || this.availableColorsBySection[section].length === 0) {
            this.availableColorsBySection[section] = [...this.colorPalette].sort(() => 0.5 - Math.random());
        }
        return this.availableColorsBySection[section].pop();
    },

    // ============================================
    // GESTIONE TEMA CENTRALIZZATA
    // ============================================
    applyTheme(theme) {
        document.body.classList.toggle('dark-theme', theme === 'dark');
    },
    
    saveTheme(theme) {
        if (!this.isAvailable()) return;
        localStorage.setItem(this.keys.theme, theme);
        this.applyTheme(theme);
    },
    
    loadTheme() {
        return this.isAvailable() ? localStorage.getItem(this.keys.theme) || 'light' : 'light';
    },

    initTheme(themeToggleElement) {
        if (!themeToggleElement) return;
        const savedTheme = this.loadTheme();
        this.applyTheme(savedTheme);
        
        themeToggleElement.addEventListener('click', () => {
            const currentTheme = this.loadTheme();
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            this.saveTheme(newTheme);
        });
    },

    // ============================================
    // GESTIONE DATI PER SEZIONE
    // ============================================
    
    // --- Anagrafica ---
    saveContacts(contacts) {
        if (this.isAvailable()) localStorage.setItem(this.keys.anagrafica, JSON.stringify(contacts));
    },
    loadContacts() {
        if (!this.isAvailable()) return [];
        const data = localStorage.getItem(this.keys.anagrafica);
        return data ? JSON.parse(data) : [];
    },
    
    // --- Amministrazione ---
    saveClients(clients) {
        if (this.isAvailable()) localStorage.setItem(this.keys.amministrazione, JSON.stringify(clients));
    },
    loadClients() {
        if (!this.isAvailable()) return [];
        const data = localStorage.getItem(this.keys.amministrazione);
        return data ? JSON.parse(data) : [];
    },

    // --- Registro di Carico ---
    saveRegistro(loads) {
        if (this.isAvailable()) localStorage.setItem(this.keys.registro, JSON.stringify(loads));
    },
    loadRegistro() {
        if (!this.isAvailable()) return [];
        const data = localStorage.getItem(this.keys.registro);
        return data ? JSON.parse(data) : [];
    },
    
    // NUOVE FUNZIONI PER GESTIRE LE RIMANENZE
    saveRimanenze(rimanenze) {
        if (this.isAvailable()) localStorage.setItem(this.keys.rimanenze, JSON.stringify(rimanenze));
    },
    loadRimanenze() {
        if (!this.isAvailable()) return { benzina: 0, gasolio: 0, diesel: 0, hvolution: 0 };
        const data = localStorage.getItem(this.keys.rimanenze);
        // Se non ci sono dati salvati, restituisce un oggetto con valori a zero
        return data ? JSON.parse(data) : { benzina: 0, gasolio: 0, diesel: 0, hvolution: 0 };
    },

    // --- Virtual Station ---
    saveTurns(turns) {
        if (this.isAvailable()) localStorage.setItem(this.keys.virtualstation, JSON.stringify(turns));
    },
    loadTurns() {
        if (!this.isAvailable()) return [];
        const data = localStorage.getItem(this.keys.virtualstation);
        return data ? JSON.parse(data) : [];
    },

    // --- Gestione Prezzi ---
    savePriceEntry(newPriceEntry) {
        if (!this.isAvailable()) return;
        const priceHistory = this.loadPriceHistory();
        priceHistory.push(newPriceEntry);
        priceHistory.sort((a, b) => b.id - a.id); 
        localStorage.setItem(this.keys.prezzi, JSON.stringify(priceHistory));
    },

    saveAllPriceHistory(priceHistory) {
        if (!this.isAvailable()) return;
        localStorage.setItem(this.keys.prezzi, JSON.stringify(priceHistory));
    },

    loadPriceHistory() {
        if (!this.isAvailable()) return [];
        const data = localStorage.getItem(this.keys.prezzi);
        return data ? JSON.parse(data) : [];
    },

    // --- Prezzi Concorrenza ---
    saveCompetitionPrices(prices) {
        if (this.isAvailable()) localStorage.setItem(this.keys.concorrenza, JSON.stringify(prices));
    },
    loadCompetitionPrices() {
        if (!this.isAvailable()) return {};
        const data = localStorage.getItem(this.keys.concorrenza);
        return data ? JSON.parse(data) : {};
    },

    // --- Calendario ---
    saveAppointments(appointments) {
        if (this.isAvailable()) localStorage.setItem(this.keys.calendario, JSON.stringify(appointments));
    },
    loadAppointments() {
        if (!this.isAvailable()) return [];
        const data = localStorage.getItem(this.keys.calendario);
        return data ? JSON.parse(data) : [];
    },

    // --- Preferenze di Visualizzazione ---
    saveViewPreference(section, view) {
        if (!this.isAvailable()) return;
        const prefs = this.loadAllViewPreferences();
        prefs[section] = view;
        localStorage.setItem(this.keys.viewPreferences, JSON.stringify(prefs));
    },
    loadAllViewPreferences() {
        if (!this.isAvailable()) return {};
        const data = localStorage.getItem(this.keys.viewPreferences);
        return data ? JSON.parse(data) : {};
    },
    loadViewPreference(section) {
        const prefs = this.loadAllViewPreferences();
        return prefs[section] || 'grid';
    }
};

// ============================================
// FUNZIONE SHOWALERT CENTRALIZZATA
// ============================================
window.showAlert = function(message, type = 'info') {
    const customAlertBox = document.getElementById('custom-alert-box');
    if (!customAlertBox) return;
    
    customAlertBox.innerHTML = message;
    customAlertBox.className = 'custom-alert';
    if (type) customAlertBox.classList.add(type);
    customAlertBox.classList.add('show');
    
    setTimeout(() => {
        customAlertBox.classList.remove('show');
        setTimeout(() => {
            customAlertBox.className = 'custom-alert';
        }, 400);
    }, 3000);
};

window.MemoriaStorage = MemoriaStorage;

document.addEventListener('DOMContentLoaded', () => {
    // Disabilita l'autocompletamento per tutti i campi di input
    document.querySelectorAll('input').forEach(input => input.setAttribute('autocomplete', 'off'));
});

/* ===== SIDEBAR.JS ===== */
document.addEventListener('DOMContentLoaded', () => {
    // Riferimenti elementi DOM
    const navLinks = document.querySelectorAll('.nav-link');
    const pageTitle = document.getElementById('page-title');
    const pageSubtitle = document.getElementById('page-subtitle');
    const themeToggle = document.getElementById('theme-toggle');
    const infoToggle = document.getElementById('info-toggle');
    const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
    const sidebar = document.getElementById('sidebar');

    // Riferimenti modale info
    const infoModal = document.getElementById('info-modal');
    const infoModalClose = document.getElementById('info-modal-close');

    // Mappatura per titoli e sottotitoli
    const pageDetails = {
        home: { title: "Home", subtitle: "Dashboard principale." },
        anagrafica: { title: "Anagrafica", subtitle: "Gestisci i tuoi contatti business." },
        calendario: { title: "Calendario", subtitle: "Organizza i tuoi appuntamenti e impegni." },
        amministrazione: { title: "Amministrazione", subtitle: "Monitora i conti a credito dei clienti." },
        registro: { title: "Registro di Carico", subtitle: "Monitoraggio delle consegne di carburante." },
        "gestione-prezzi": { title: "Gestione Prezzi", subtitle: "Gestione dei prezzi e monitoraggio della concorrenza." },
        virtualstation: { title: "VirtualStation", subtitle: "Registra le vendite carburante per turni." },
        statistiche: { title: "Statistiche", subtitle: "Visualizza i dati di vendita e performance." }
    };

    // Funzione per cambiare pagina
    function switchPage(pageId) {
        document.querySelectorAll('.page-section').forEach(section => {
            section.style.display = 'none';
        });
        const activeSection = document.getElementById(`${pageId}-content`);
        if (activeSection) activeSection.style.display = 'block';

        if (pageDetails[pageId]) {
            pageTitle.textContent = pageDetails[pageId].title;
            pageSubtitle.textContent = pageDetails[pageId].subtitle;
        }

        navLinks.forEach(link => {
            link.classList.remove('active');
            if (link.dataset.page === pageId) link.classList.add('active');
        });

        // Chiama la funzione di inizializzazione della pagina statistiche se è quella attiva
        if (pageId === 'statistiche' && typeof window.initStatsPage === 'function') {
            window.initStatsPage();
        }

        if (window.innerWidth <= 768) sidebar.classList.remove('open');
    }

    // Gestione click sui link di navigazione
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            switchPage(e.currentTarget.dataset.page);
        });
    });

    // --- GESTIONE MODALE INFO ---
    function openInfoModal() {
        if (infoModal) {
            infoModal.style.display = 'flex';
            setTimeout(() => {
                infoModal.classList.add('show');
                // Inizializza le icone Lucide nel modale
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 10);
        }
    }

    function closeInfoModal() {
        if (infoModal) {
            infoModal.classList.remove('show');
            setTimeout(() => {
                infoModal.style.display = 'none';
            }, 300);
        }
    }

    // Event listeners per il modale info
    if (infoToggle) {
        infoToggle.addEventListener('click', openInfoModal);
    }

    if (infoModalClose) {
        infoModalClose.addEventListener('click', closeInfoModal);
    }

    if (infoModal) {
        infoModal.addEventListener('click', (e) => {
            if (e.target === infoModal) {
                closeInfoModal();
            }
        });
    }

    // Chiudi modale con ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && infoModal && infoModal.classList.contains('show')) {
            closeInfoModal();
        }
    });

    // --- GESTIONE FULLSCREEN (NUOVO) ---
    const fullscreenBtn = document.getElementById('fullscreen-toggle');
    if (fullscreenBtn) {
        const maximizeIcon = fullscreenBtn.querySelector('.maximize-icon');
        const minimizeIcon = fullscreenBtn.querySelector('.minimize-icon');

        function updateFullscreenIcon() {
            const isFullscreen = !!document.fullscreenElement;
            maximizeIcon.style.display = isFullscreen ? 'none' : 'block';
            minimizeIcon.style.display = isFullscreen ? 'block' : 'none';
        }

        fullscreenBtn.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    alert(`Errore nell'attivare la modalità schermo intero: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        });
        
        document.addEventListener('fullscreenchange', updateFullscreenIcon);
    }

    // Gestione sidebar mobile
    if(mobileMenuBtn) mobileMenuBtn.addEventListener('click', () => sidebar.classList.toggle('open'));
    document.addEventListener('click', (e) => {
        if (window.innerWidth <= 768 && sidebar && !sidebar.contains(e.target) && mobileMenuBtn && !mobileMenuBtn.contains(e.target)) {
            sidebar.classList.remove('open');
        }
    });

    // --- Inizializzazione ---
    if (window.MemoriaStorage) {
        window.MemoriaStorage.initTheme(themeToggle);
    }
    switchPage('home');
});

/* ===== ANAGRAFICA.JS ===== */
/**
 * ANAGRAFICA.JS
 * Gestione della sezione anagrafica con sistema di categorie e funzione stampa
 * --- VERSIONE DEFINITIVA COMPLETA ---
 */

document.addEventListener('DOMContentLoaded', () => {
    // Riferimenti elementi DOM
    const contactsGrid = document.getElementById('contacts-grid');
    const searchInput = document.getElementById('search-input');
    const clearSearchBtn = document.getElementById('clear-search-btn');
    const importBtn = document.getElementById('import-vcf-btn');
    const exportBtn = document.getElementById('export-vcf-btn');
    const printBtn = document.getElementById('print-contacts-btn');
    const deleteAllBtn = document.getElementById('delete-all-btn');
    const vcfFileInput = document.getElementById('vcf-file-input');
    const customAlertBox = document.getElementById('custom-alert-box');
    const newContactBtn = document.getElementById('new-contact-btn');
    const newContactModal = document.getElementById('new-contact-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const saveContactBtn = document.getElementById('save-contact-btn');
    const editContactModal = document.getElementById('edit-contact-modal');
    const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
    const saveEditContactBtn = document.getElementById('save-edit-contact-btn');
    const editContactName = document.getElementById('edit-contact-name');
    const editContactOrg = document.getElementById('edit-contact-org');
    const editContactTel = document.getElementById('edit-contact-tel');
    const editContactEmail = document.getElementById('edit-contact-email');
    const editContactNotes = document.getElementById('edit-contact-notes');
    const editContactCategory = document.getElementsByName('edit-contact-category');
    const deleteContactBtn = document.getElementById('delete-contact-btn');

    // Variabili globali
    let contacts = [];
    let filteredContacts = [];
    let currentFilter = 'all';
    let searchQuery = '';
    let currentEditingContactId = null;

    // Inizializzazione
    loadContacts();
    setupEventListeners();

    function setupEventListeners() {
        // Ricerca
        if (searchInput) {
            searchInput.addEventListener('input', handleSearch);
        }
        if (clearSearchBtn) {
            clearSearchBtn.addEventListener('click', clearSearch);
        }

        // Filtri categoria
        document.querySelectorAll('.category-filter-btn').forEach(btn => {
            btn.addEventListener('click', () => handleCategoryFilter(btn.dataset.category));
        });

        // Pulsanti azione
        if (importBtn) importBtn.addEventListener('click', importVCF);
        if (exportBtn) exportBtn.addEventListener('click', exportVCF);
        if (printBtn) printBtn.addEventListener('click', printContacts);
        if (deleteAllBtn) deleteAllBtn.addEventListener('click', deleteAllContacts);
        if (newContactBtn) newContactBtn.addEventListener('click', openNewContactModal);

        // Input file VCF
        if (vcfFileInput) {
            vcfFileInput.addEventListener('change', handleVCFImport);
        }

        // Modali
        if (closeModalBtn) closeModalBtn.addEventListener('click', closeNewContactModal);
        if (saveContactBtn) saveContactBtn.addEventListener('click', saveNewContact);
        if (closeEditModalBtn) closeEditModalBtn.addEventListener('click', closeEditContactModal);
        if (saveEditContactBtn) saveEditContactBtn.addEventListener('click', saveEditContact);
        if (deleteContactBtn) deleteContactBtn.addEventListener('click', deleteContact);

        // Chiusura modali con ESC o click fuori
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeNewContactModal();
                closeEditContactModal();
            }
        });

        // Click fuori dal modal
        if (newContactModal) {
            newContactModal.addEventListener('click', (e) => {
                if (e.target === newContactModal) closeNewContactModal();
            });
        }
        if (editContactModal) {
            editContactModal.addEventListener('click', (e) => {
                if (e.target === editContactModal) closeEditContactModal();
            });
        }
    }

    function loadContacts() {
        const savedContacts = localStorage.getItem('anagrafica-contacts');
        contacts = savedContacts ? JSON.parse(savedContacts) : [];
        
      
        applyFilters();
    }

    function saveContacts() {
        localStorage.setItem('anagrafica-contacts', JSON.stringify(contacts));
    }

    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function handleSearch() {
        searchQuery = searchInput.value.toLowerCase().trim();
        
        // Mostra/nascondi il pulsante clear
        if (clearSearchBtn) {
            clearSearchBtn.style.display = searchQuery ? 'flex' : 'none';
        }
        
        applyFilters();
    }

    function clearSearch() {
        searchInput.value = '';
        searchQuery = '';
        if (clearSearchBtn) {
            clearSearchBtn.style.display = 'none';
        }
        applyFilters();
    }

    function handleCategoryFilter(category) {
        // Logica toggle: se clicchi sullo stesso filtro già attivo, deselezionalo
        if (currentFilter === category) {
            currentFilter = 'all'; // Torna a mostrare tutti
        } else {
            currentFilter = category;
        }
        
        // Aggiorna stato visivo pulsanti
        document.querySelectorAll('.category-filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Se non è "all", attiva il pulsante corrispondente
        if (currentFilter !== 'all') {
            const activeBtn = document.querySelector(`[data-category="${currentFilter}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }
        
        applyFilters();
    }

    function applyFilters() {
        let filtered = [...contacts];
        
        // Filtro categoria
        if (currentFilter !== 'all') {
            filtered = filtered.filter(contact => contact.CATEGORIA === currentFilter);
        }
        
        // Filtro ricerca
        if (searchQuery) {
            filtered = filtered.filter(contact => {
                return (contact.FN || '').toLowerCase().includes(searchQuery) ||
                       (contact.ORG || '').toLowerCase().includes(searchQuery) ||
                       (contact.TEL || '').toLowerCase().includes(searchQuery) ||
                       (contact.EMAIL || '').toLowerCase().includes(searchQuery) ||
                       (contact.NOTE || '').toLowerCase().includes(searchQuery);
            });
        }
        
        // ORDINAMENTO ALFABETICO PER NOME
        filtered.sort((a, b) => {
            const nameA = (a.FN || '').toLowerCase();
            const nameB = (b.FN || '').toLowerCase();
            return nameA.localeCompare(nameB, 'it', { sensitivity: 'base' });
        });
        
        filteredContacts = filtered;
        renderContacts(filteredContacts);
    }

    function renderContacts(contacts) {
        if (!contactsGrid) return;
        
        if (!contacts || contacts.length === 0) {
            contactsGrid.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 48px; color: var(--text-secondary);">
                    <i data-lucide="users" style="width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                    <h3 style="margin-bottom: 8px;">Nessun contatto trovato</h3>
                    <p>Aggiungi il primo contatto o modifica i filtri di ricerca</p>
                </div>
            `;
            // Re-initialize lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            return;
        }

        contactsGrid.innerHTML = contacts.map(contact => {
            const categoryColor = getCategoryColor(contact.CATEGORIA);
            const categoryIcon = getCategoryIcon(contact.CATEGORIA);
            
            return `
                <div class="contact-box" data-contact-id="${contact.id}">
                    <div class="contact-header">
                        <div class="contact-icon-container" style="background-color: ${categoryColor};">
                            <i data-lucide="${categoryIcon}"></i>
                        </div>
                        <div class="contact-details">
                            <div class="contact-name">${contact.FN || 'Nome non specificato'}</div>
                            <div class="contact-org">${contact.ORG || ''}</div>
                        </div>
                    </div>
                    <ul class="contact-info-list">
                        ${contact.TEL ? `<li class="contact-info-item"><i data-lucide="phone"></i>${contact.TEL}</li>` : ''}
                        ${contact.EMAIL ? `<li class="contact-info-item"><i data-lucide="mail"></i>${contact.EMAIL}</li>` : ''}
                        ${contact.NOTE ? `<li class="contact-info-item"><i data-lucide="file-text"></i>${contact.NOTE}</li>` : ''}
                    </ul>
                    <button class="contact-edit-btn" onclick="editContact('${contact.id}')" title="Modifica contatto">
                        <i data-lucide="square-pen"></i>
                    </button>
                </div>
            `;
        }).join('');

        // Re-initialize lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    function getCategoryColor(category) {
        const colors = {
            'clienti': '#A855F7',    // Viola
            'autisti': '#2ECC71',    // Verde
            'enilive': '#06B6D4'     // Cyan
        };
        return colors[category] || '#6B7280'; // Grigio di default
    }

    function getCategoryIcon(category) {
        const icons = {
            'clienti': 'user',
            'autisti': 'truck',
            'enilive': 'zap'
        };
        return icons[category] || 'user';
    }

    // Funzione globale per modificare contatto
    window.editContact = function(contactId) {
        const contact = contacts.find(c => c.id === contactId);
        if (!contact) return;

        currentEditingContactId = contactId;
        
        // Popola il form di modifica
        if (editContactName) editContactName.value = contact.FN || '';
        if (editContactOrg) editContactOrg.value = contact.ORG || '';
        if (editContactTel) editContactTel.value = contact.TEL || '';
        if (editContactEmail) editContactEmail.value = contact.EMAIL || '';
        if (editContactNotes) editContactNotes.value = contact.NOTE || '';
        
        // Seleziona la categoria
        editContactCategory.forEach(radio => {
            radio.checked = radio.value === contact.CATEGORIA;
        });
        
        // Mostra il modal
        if (editContactModal) {
            editContactModal.style.display = 'flex';
        }
    };

    function openNewContactModal() {
        if (newContactModal) {
            newContactModal.style.display = 'flex';
            
            // Reset form
            const form = newContactModal.querySelector('form');
            if (form) form.reset();
        }
    }

    function closeNewContactModal() {
        if (newContactModal) {
            newContactModal.style.display = 'none';
        }
    }

    function closeEditContactModal() {
        if (editContactModal) {
            editContactModal.style.display = 'none';
        }
        currentEditingContactId = null;
    }

    function saveNewContact() {
        const form = newContactModal.querySelector('form');
        if (!form) return;

        const formData = new FormData(form);
        const newContact = {
            id: generateId(),
            FN: formData.get('contact-name') || '',
            ORG: formData.get('contact-org') || '',
            TEL: formData.get('contact-tel') || '',
            EMAIL: formData.get('contact-email') || '',
            NOTE: formData.get('contact-notes') || '',
            CATEGORIA: formData.get('contact-category') || 'clienti'
        };

        contacts.push(newContact);
        saveContacts();
        applyFilters();
        closeNewContactModal();
        
        showAlert('Contatto aggiunto con successo!', 'success');
    }

    function saveEditContact() {
        if (!currentEditingContactId) return;

        const contactIndex = contacts.findIndex(c => c.id === currentEditingContactId);
        if (contactIndex === -1) return;

        // Ottieni categoria selezionata
        let selectedCategory = 'clienti';
        editContactCategory.forEach(radio => {
            if (radio.checked) selectedCategory = radio.value;
        });

        // Aggiorna il contatto
        contacts[contactIndex] = {
            ...contacts[contactIndex],
            FN: editContactName.value || '',
            ORG: editContactOrg.value || '',
            TEL: editContactTel.value || '',
            EMAIL: editContactEmail.value || '',
            NOTE: editContactNotes.value || '',
            CATEGORIA: selectedCategory
        };

        saveContacts();
        applyFilters();
        closeEditContactModal();
        
        showAlert('Contatto modificato con successo!', 'success');
    }

    function importVCF() {
        if (vcfFileInput) {
            vcfFileInput.click();
        }
    }

    function handleVCFImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const vcfContent = e.target.result;
            const parsedContacts = parseVCF(vcfContent);
            
            if (parsedContacts.length > 0) {
                contacts.push(...parsedContacts);
                saveContacts();
                applyFilters();
                showAlert(`Importati ${parsedContacts.length} contatti!`, 'success');
            } else {
                showAlert('Nessun contatto valido trovato nel file VCF', 'error');
            }
        };
        reader.readAsText(file);
        
        // Reset input
        event.target.value = '';
    }

    function parseVCF(vcfContent) {
        const contacts = [];
        const vcardBlocks = vcfContent.split('BEGIN:VCARD');
        
        vcardBlocks.forEach(block => {
            if (!block.trim()) return;
            
            const contact = {
                id: generateId(),
                FN: '',
                ORG: '',
                TEL: '',
                EMAIL: '',
                NOTE: '',
                CATEGORIA: 'clienti'
            };
            
            const lines = block.split('\n');
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine.startsWith('FN:')) {
                    contact.FN = trimmedLine.substring(3);
                } else if (trimmedLine.startsWith('ORG:')) {
                    contact.ORG = trimmedLine.substring(4);
                } else if (trimmedLine.startsWith('TEL:') || trimmedLine.includes('TEL;')) {
                    contact.TEL = trimmedLine.split(':')[1] || '';
                } else if (trimmedLine.startsWith('EMAIL:') || trimmedLine.includes('EMAIL;')) {
                    contact.EMAIL = trimmedLine.split(':')[1] || '';
                } else if (trimmedLine.startsWith('NOTE:')) {
                    contact.NOTE = trimmedLine.substring(5);
                }
            });
            
            if (contact.FN) {
                contacts.push(contact);
            }
        });
        
        return contacts;
    }

    function exportVCF() {
        if (contacts.length === 0) {
            showAlert('Nessun contatto da esportare', 'error');
            return;
        }

        const vcfContent = contacts.map(contact => {
            return [
                'BEGIN:VCARD',
                'VERSION:3.0',
                `FN:${contact.FN || ''}`,
                contact.ORG ? `ORG:${contact.ORG}` : '',
                contact.TEL ? `TEL:${contact.TEL}` : '',
                contact.EMAIL ? `EMAIL:${contact.EMAIL}` : '',
                contact.NOTE ? `NOTE:${contact.NOTE}` : '',
                'END:VCARD'
            ].filter(line => line).join('\n');
        }).join('\n\n');

        const blob = new Blob([vcfContent], { type: 'text/vcard' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'contatti_anagrafica.vcf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showAlert('File VCF esportato con successo!', 'success');
    }

    function printContacts() {
        const contactsToPrint = filteredContacts.length > 0 ? filteredContacts : contacts;
        
        if (contactsToPrint.length === 0) {
            showAlert('Nessun contatto da stampare', 'error');
            return;
        }

        generatePrintableHTML(contactsToPrint);
    }

    function generatePrintableHTML(contactsToPrint) {
        const printWindow = window.open('', '_blank');
        
        // Raggruppa per categoria
        const grouped = {
            clienti: contactsToPrint.filter(c => c.CATEGORIA === 'clienti'),
            autisti: contactsToPrint.filter(c => c.CATEGORIA === 'autisti'),
            enilive: contactsToPrint.filter(c => c.CATEGORIA === 'enilive')
        };

        printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Anagrafica Contatti - Stampa</title>
            <style>
                @page {
                    size: landscape;
                    margin: 1cm;
                }
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    font-size: 11px;
                    line-height: 1.4;
                    color: #333;
                    background: white;
                }
                .header {
                    text-align: center;
                    margin-bottom: 20px;
                    padding-bottom: 15px;
                    border-bottom: 2px solid #333;
                }
                .header h1 {
                    font-size: 24px;
                    margin-bottom: 5px;
                    color: #333;
                }
                .header .subtitle {
                    font-size: 14px;
                    color: #666;
                }
                .category-section {
                    margin-bottom: 25px;
                    break-inside: avoid;
                }
                .category-title {
                    font-size: 16px;
                    font-weight: bold;
                    margin-bottom: 10px;
                    padding: 8px 12px;
                    color: white;
                    border-radius: 4px;
                }
                .category-title.clienti { background-color: #A855F7; }
                .category-title.autisti { background-color: #2ECC71; }
                .category-title.enilive { background-color: #06B6D4; }
                
                .contacts-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 15px;
                    border: 1px solid #ddd;
                }
                .contacts-table th {
                    background-color: #f8f9fa;
                    padding: 8px 10px;
                    text-align: left;
                    font-weight: 600;
                    border: 1px solid #ddd;
                    font-size: 12px;
                }
                .contacts-table td {
                    padding: 6px 10px;
                    border: 1px solid #ddd;
                    vertical-align: top;
                    word-wrap: break-word;
                    max-width: 150px;
                }
                .contacts-table tr:nth-child(even) {
                    background-color: #f8f9fa;
                }
                .contact-name {
                    font-weight: 600;
                    color: #333;
                }
                .contact-org,
                .contact-tel,
                .contact-email,
                .contact-notes {
                    color: #666;
                    font-size: 10px;
                }
                .summary {
                    margin-top: 20px;
                    padding: 15px;
                    background-color: #f8f9fa;
                    border-radius: 4px;
                    border: 1px solid #ddd;
                }
                .summary h3 {
                    margin-bottom: 10px;
                    color: #333;
                    font-size: 14px;
                }
                .summary-item {
                    display: inline-block;
                    margin-right: 20px;
                    font-weight: 500;
                    color: #666;
                }
                @media print {
                    body { print-color-adjust: exact; }
                    .category-section { page-break-inside: avoid; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Anagrafica Contatti</h1>
                <div class="subtitle">Stampato il ${new Date().toLocaleDateString('it-IT')} alle ${new Date().toLocaleTimeString('it-IT')}</div>
            </div>
        `);

        // Stampa per ogni categoria
        Object.keys(grouped).forEach(categoryKey => {
            const categoryContacts = grouped[categoryKey];
            if (categoryContacts.length === 0) return;

            const categoryNames = {
                'clienti': 'CLIENTI',
                'autisti': 'AUTISTI', 
                'enilive': 'ENILIVE'
            };

            printWindow.document.write(`
                <div class="category-section">
                    <div class="category-title ${categoryKey}">${categoryNames[categoryKey]} (${categoryContacts.length})</div>
                    <table class="contacts-table">
                        <thead>
                            <tr>
                                <th style="width: 25%;">Nome</th>
                                <th style="width: 20%;">Organizzazione</th>
                                <th style="width: 18%;">Telefono</th>
                                <th style="width: 22%;">Email</th>
                                <th style="width: 15%;">Note</th>
                            </tr>
                        </thead>
                        <tbody>
            `);

            categoryContacts.forEach(contact => {
                printWindow.document.write(`
                    <tr>
                        <td class="contact-name">${contact.FN || '-'}</td>
                        <td class="contact-org">${contact.ORG || '-'}</td>
                        <td class="contact-tel">${contact.TEL || '-'}</td>
                        <td class="contact-email">${contact.EMAIL || '-'}</td>
                        <td class="contact-notes">${contact.NOTE || '-'}</td>
                    </tr>
                `);
            });

            printWindow.document.write('</tbody></table></div>');
        });

        // Summary
        printWindow.document.write(`
            <div class="summary">
                <h3>Riepilogo</h3>
                <span class="summary-item">Totale contatti: ${contactsToPrint.length}</span>
        `);
        
        if (grouped.clienti.length > 0) {
            printWindow.document.write(`<span class="summary-item">Clienti: ${grouped.clienti.length}</span>`);
        }
        if (grouped.autisti.length > 0) {
            printWindow.document.write(`<span class="summary-item">Autisti: ${grouped.autisti.length}</span>`);
        }
        if (grouped.enilive.length > 0) {
            printWindow.document.write(`<span class="summary-item">Enilive: ${grouped.enilive.length}</span>`);
        }
        
        printWindow.document.write('</div></body></html>');
        printWindow.document.close();
        
        setTimeout(() => {
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }, 500);
    }

    function deleteContact() {
        if (!currentEditingContactId) return;

        if (confirm('Sei sicuro di voler eliminare questo contatto? Questa azione non può essere annullata.')) {
            const contactIndex = contacts.findIndex(c => c.id === currentEditingContactId);
            if (contactIndex !== -1) {
                contacts.splice(contactIndex, 1);
                saveContacts();
                applyFilters();
                closeEditContactModal();
                showAlert('Contatto eliminato con successo!', 'success');
            }
        }
    }

    function deleteAllContacts() {
        if (contacts.length === 0) {
            showAlert('Nessun contatto da eliminare', 'error');
            return;
        }

        if (confirm('Sei sicuro di voler eliminare TUTTI i contatti? Questa azione non può essere annullata.')) {
            contacts = [];
            saveContacts();
            applyFilters();
            showAlert('Tutti i contatti sono stati eliminati', 'success');
        }
    }

    function showAlert(message, type = 'info') {
        if (!customAlertBox) return;

        customAlertBox.textContent = message;
        customAlertBox.className = `custom-alert ${type}`;
        customAlertBox.style.display = 'block';

        setTimeout(() => {
            customAlertBox.style.display = 'none';
        }, 3000);
    }
});

/* ===== CALENDARIO.JS ===== */
/**
 * CALENDARIO.JS
 * Gestione completa della sezione calendario con festività italiane
 * e supporto per eventi multi-giorno.
 */

document.addEventListener('DOMContentLoaded', () => {
    // Riferimenti DOM
    const calendarGrid = document.getElementById('calendar-grid');
    const calendarTitle = document.getElementById('calendar-title');
    const prevMonthBtn = document.getElementById('prev-month-btn');
    const nextMonthBtn = document.getElementById('next-month-btn');
    const todayBtn = document.getElementById('today-btn');
    const newAppointmentBtn = document.getElementById('new-appointment-btn-toolbar');
    const appointmentsTabs = document.getElementById('appointments-tabs');
    const appointmentsList = document.getElementById('appointments-list');
    const selectedDateTitle = document.getElementById('selected-date-title');
    const selectedDateSubtitle = document.getElementById('selected-date-subtitle');
    
    // Modali
    const newAppointmentModal = document.getElementById('new-appointment-modal');
    const editAppointmentModal = document.getElementById('edit-appointment-modal');
    const saveAppointmentBtn = document.getElementById('save-appointment-btn');
    const saveEditAppointmentBtn = document.getElementById('save-edit-appointment-btn');
    const deleteAppointmentBtn = document.getElementById('delete-appointment-btn');
    const appointmentAllDay = document.getElementById('appointment-all-day');
    const editAppointmentAllDay = document.getElementById('edit-appointment-all-day');
    const cancelAppointmentBtn = document.getElementById('cancel-appointment-btn');
    const cancelEditAppointmentBtn = document.getElementById('cancel-edit-appointment-btn');
    
    // Pulsanti Toolbar
    const importCalendarBtn = document.getElementById('import-calendar-btn');
    const exportCalendarBtn = document.getElementById('export-calendar-btn');
    const printCalendarBtn = document.getElementById('print-calendar-btn');
    const deleteAllCalendarBtn = document.getElementById('delete-all-calendar-btn');

    // Variabili globali
    let currentDate = new Date();
    let selectedDate = new Date();
    let allAppointments = [];
    let currentView = 'day';
    let editingAppointmentId = null;

    const MONTHS = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
    const WEEKDAYS_FULL = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'];
    const ITALIAN_HOLIDAYS = { '1/1': 'Capodanno', '6/1': 'Epifania', '25/4': 'Festa della Liberazione', '1/5': 'Festa del Lavoro', '2/6': 'Festa della Repubblica', '15/8': 'Ferragosto', '1/11': 'Ognissanti', '8/12': 'Immacolata Concezione', '25/12': 'Natale', '26/12': 'Santo Stefano' };

    function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
    function formatDateISO(date) { return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`; }
    function formatDateItalian(date) { return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`; }
    function parseItalianDate(dateStr) { const parts = dateStr.split('/'); return parts.length !== 3 ? null : new Date(parts[2], parts[1] - 1, parts[0]); }
    function parseISODate(dateStr) { const date = new Date(dateStr); return new Date(date.getTime() + date.getTimezoneOffset() * 60000); }
    function isHoliday(date) { return ITALIAN_HOLIDAYS[`${date.getDate()}/${date.getMonth() + 1}`] || null; }
    function isSameDay(d1, d2) { return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate(); }
    
    function saveAppointments() { window.MemoriaStorage?.saveAppointments(allAppointments); }
    function loadAppointments() { allAppointments = window.MemoriaStorage?.loadAppointments() || []; }

    function generateCalendar() {
        calendarTitle.textContent = `${MONTHS[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        calendarGrid.innerHTML = '';
        WEEKDAYS_FULL.forEach(w => { const h = document.createElement('div'); h.className = 'calendar-header'; h.textContent = w.substring(0, 3); calendarGrid.appendChild(h); });
        const year = currentDate.getFullYear(), month = currentDate.getMonth();
        const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0);
        const start = new Date(firstDay); start.setDate(start.getDate() - (start.getDay() + 6) % 7);
        const end = new Date(lastDay); if ((end.getDay() + 6) % 7 < 6) { end.setDate(end.getDate() + (6 - (end.getDay() + 6) % 7)); }
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) { createCalendarDay(new Date(d), d.getMonth() !== month); }
    }

    function createCalendarDay(date, isOtherMonth) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        if (isOtherMonth) dayEl.classList.add('other-month');
        if (isSameDay(date, new Date())) dayEl.classList.add('today');
        if (isHoliday(date) && !isOtherMonth) dayEl.classList.add('holiday');
        if (isSameDay(date, selectedDate)) dayEl.classList.add('selected');
        dayEl.innerHTML = `<div class="calendar-day-number">${date.getDate()}</div><div class="appointment-dots"></div>`;
        const dotsContainer = dayEl.querySelector('.appointment-dots');
        const dayAppointments = allAppointments.filter(apt => date >= parseISODate(apt.startDate) && date <= parseISODate(apt.endDate));
        if (dayAppointments.length > 0) {
            dotsContainer.innerHTML += `<div class="appointment-dot"></div>`;
            if (dayAppointments.some(apt => apt.isAllDay)) dayEl.classList.add('multiday-event-bg');
        }
        dayEl.addEventListener('click', () => { selectedDate = new Date(date); currentDate = new Date(date); generateCalendar(); updateSelectedDateInfo(); updateAppointmentsList(); });
        calendarGrid.appendChild(dayEl);
    }

    function updateSelectedDateInfo() {
        if (currentView === 'all') { selectedDateTitle.textContent = 'Tutti gli Appuntamenti'; selectedDateSubtitle.textContent = `${allAppointments.length} appuntamenti totali`; } 
        else if (currentView === 'day') { selectedDateTitle.textContent = formatDateItalian(selectedDate); selectedDateSubtitle.textContent = isHoliday(selectedDate) || WEEKDAYS_FULL[(selectedDate.getDay() + 6) % 7]; } 
        else if (currentView === 'week') { const startOfWeek = new Date(selectedDate); startOfWeek.setDate(selectedDate.getDate() - (selectedDate.getDay() + 6) % 7); const endOfWeek = new Date(startOfWeek); endOfWeek.setDate(startOfWeek.getDate() + 6); selectedDateTitle.textContent = `Settimana del ${formatDateItalian(startOfWeek)}`; selectedDateSubtitle.textContent = `dal ${formatDateItalian(startOfWeek)} al ${formatDateItalian(endOfWeek)}`; } 
        else if (currentView === 'month') { selectedDateTitle.textContent = `${MONTHS[selectedDate.getMonth()]} ${selectedDate.getFullYear()}`; const monthAppointments = allAppointments.filter(apt => parseISODate(apt.startDate).getMonth() === selectedDate.getMonth() && parseISODate(apt.startDate).getFullYear() === selectedDate.getFullYear()); selectedDateSubtitle.textContent = `${monthAppointments.length} appuntamenti nel mese`; }
    }

    function updateAppointmentsList() {
        appointmentsList.innerHTML = ''; let filtered = [];
        if (currentView === 'day') { filtered = allAppointments.filter(apt => selectedDate >= parseISODate(apt.startDate) && selectedDate <= parseISODate(apt.endDate)); } 
        else if (currentView === 'week') { const startOfWeek = new Date(selectedDate); startOfWeek.setDate(selectedDate.getDate() - (selectedDate.getDay() + 6) % 7); startOfWeek.setHours(0, 0, 0, 0); const endOfWeek = new Date(startOfWeek); endOfWeek.setDate(startOfWeek.getDate() + 6); endOfWeek.setHours(23, 59, 59, 999); filtered = allAppointments.filter(apt => parseISODate(apt.startDate) <= endOfWeek && parseISODate(apt.endDate) >= startOfWeek); } 
        else if (currentView === 'month') { const startOfMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1); const endOfMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0); endOfMonth.setHours(23, 59, 59, 999); filtered = allAppointments.filter(apt => parseISODate(apt.startDate) <= endOfMonth && parseISODate(apt.endDate) >= startOfMonth); } 
        else { filtered = [...allAppointments]; }
        if (filtered.length === 0) { appointmentsList.innerHTML = `<div class="no-appointments">Nessun appuntamento trovato</div>`; return; }
        filtered.sort((a,b) => parseISODate(a.startDate) - parseISODate(b.startDate) || (a.startTime || '00:00').localeCompare(b.startTime || '00:00')).forEach(apt => {
            const item = document.createElement('div'); item.className = 'appointment-item'; const start = parseISODate(apt.startDate), end = parseISODate(apt.endDate);
            let dateDisplay = apt.isAllDay ? (isSameDay(start, end) ? `${formatDateItalian(start)} (Tutto il giorno)` : `${formatDateItalian(start)} - ${formatDateItalian(end)}`) : `${formatDateItalian(start)}, ${apt.startTime} - ${apt.endTime}`;
            item.innerHTML = `<div class="appointment-time">${dateDisplay}</div><div class="appointment-title">${apt.title}</div>${apt.description ? `<div class="appointment-description">${apt.description}</div>` : ''}`;
            item.addEventListener('click', () => openEditAppointmentModal(apt.id)); appointmentsList.appendChild(item);
        });
    }

    function openNewAppointmentModal() {
        newAppointmentModal.style.display = 'flex';
        const form = newAppointmentModal.querySelector('form'); if(form) form.reset();
        const fDate = formatDateItalian(selectedDate);
        document.getElementById('appointment-start-date').value = fDate; document.getElementById('appointment-end-date').value = fDate; document.getElementById('appointment-start-hour').value = '09'; document.getElementById('appointment-start-minute').value = '00'; document.getElementById('appointment-end-hour').value = '10'; document.getElementById('appointment-end-minute').value = '00';
        appointmentAllDay.dispatchEvent(new Event('change'));
    }

    function openEditAppointmentModal(id) {
        const apt = allAppointments.find(a => a.id === id); if (!apt) return; editingAppointmentId = id; editAppointmentModal.style.display = 'flex';
        document.getElementById('edit-appointment-title').value = apt.title; document.getElementById('edit-appointment-start-date').value = formatDateItalian(parseISODate(apt.startDate)); document.getElementById('edit-appointment-end-date').value = formatDateItalian(parseISODate(apt.endDate));
        editAppointmentAllDay.checked = apt.isAllDay; editAppointmentAllDay.dispatchEvent(new Event('change'));
        if (!apt.isAllDay) {
            const [startH, startM] = apt.startTime.split(':'); const [endH, endM] = apt.endTime.split(':');
            document.getElementById('edit-appointment-start-hour').value = startH; document.getElementById('edit-appointment-start-minute').value = startM; document.getElementById('edit-appointment-end-hour').value = endH; document.getElementById('edit-appointment-end-minute').value = endM;
        } else { document.getElementById('edit-appointment-start-hour').value = ''; document.getElementById('edit-appointment-start-minute').value = ''; document.getElementById('edit-appointment-end-hour').value = ''; document.getElementById('edit-appointment-end-minute').value = ''; }
        document.getElementById('edit-appointment-description').value = apt.description || '';
        const recurrenceRadio = editAppointmentModal.querySelector(`input[name="edit-appointment-recurrence"][value="${apt.recurrence || 'none'}"]`); if (recurrenceRadio) recurrenceRadio.checked = true;
    }

    function closeModal(modal) { modal.style.display = 'none'; editingAppointmentId = null; }

    function saveAppointment(isEditing) {
        const modal = isEditing ? editAppointmentModal : newAppointmentModal;
        const modalPrefix = isEditing ? 'edit-' : '';
        const title = document.getElementById(`${modalPrefix}appointment-title`).value.trim();
        const startDate = parseItalianDate(document.getElementById(`${modalPrefix}appointment-start-date`).value.trim());
        const endDate = parseItalianDate(document.getElementById(`${modalPrefix}appointment-end-date`).value.trim());
        const isAllDay = document.getElementById(`${modalPrefix}appointment-all-day`).checked;
        const startHour = document.getElementById(`${modalPrefix}appointment-start-hour`).value.padStart(2, '0');
        const startMinute = document.getElementById(`${modalPrefix}appointment-start-minute`).value.padStart(2, '0');
        const endHour = document.getElementById(`${modalPrefix}appointment-end-hour`).value.padStart(2, '0');
        const endMinute = document.getElementById(`${modalPrefix}appointment-end-minute`).value.padStart(2, '0');
        const description = document.getElementById(`${modalPrefix}appointment-description`).value.trim();
        const recurrence = modal.querySelector(`input[name="${modalPrefix}appointment-recurrence"]:checked`).value;

        if (!title || !startDate || !endDate) return showAlert('Titolo e date sono obbligatori.', 'danger');
        if (endDate < startDate) return showAlert('La data di fine non può precedere quella di inizio.', 'danger');
        if (!isAllDay && isSameDay(startDate, endDate) && `${startHour}:${startMinute}` >= `${endHour}:${endMinute}`) return showAlert('L\'orario di fine deve essere successivo a quello di inizio.', 'danger');

        if (isEditing) { // Logica di modifica semplificata (modifica solo questo evento)
            const aptIndex = allAppointments.findIndex(a => a.id === editingAppointmentId); if (aptIndex === -1) return;
            allAppointments[aptIndex] = { ...allAppointments[aptIndex], title, description, isAllDay, startDate: formatDateISO(startDate), endDate: formatDateISO(endDate), startTime: isAllDay ? null : `${startHour}:${startMinute}`, endTime: isAllDay ? null : `${endHour}:${endMinute}`, recurrence, updatedAt: new Date().toISOString() };
        } else { // Logica di creazione con ricorrenza
            const appointmentsToSave = [];
            const firstAppointmentId = generateId();
            const duration = endDate.getTime() - startDate.getTime();
            
            const baseAppointment = { id: firstAppointmentId, title, description, isAllDay, startDate: formatDateISO(startDate), endDate: formatDateISO(endDate), startTime: isAllDay ? null : `${startHour}:${startMinute}`, endTime: isAllDay ? null : `${endHour}:${endMinute}`, recurrence, createdAt: new Date().toISOString() };
            if (recurrence !== 'none') baseAppointment.recurrenceId = firstAppointmentId;
            appointmentsToSave.push(baseAppointment);

            if (recurrence !== 'none') {
                let loopDate = new Date(startDate);
                const finalDate = new Date(startDate); finalDate.setFullYear(startDate.getFullYear() + 2);
                while (true) {
                    if (recurrence === 'daily') loopDate.setDate(loopDate.getDate() + 1);
                    else if (recurrence === 'weekly') loopDate.setDate(loopDate.getDate() + 7);
                    else if (recurrence === 'monthly') loopDate.setMonth(loopDate.getMonth() + 1);
                    else if (recurrence === 'yearly') loopDate.setFullYear(loopDate.getFullYear() + 1);
                    if (loopDate > finalDate) break;
                    const nextEndDate = new Date(loopDate.getTime() + duration);
                    const recurringAppointment = { ...baseAppointment, id: generateId(), startDate: formatDateISO(loopDate), endDate: formatDateISO(nextEndDate) };
                    appointmentsToSave.push(recurringAppointment);
                }
            }
            allAppointments.push(...appointmentsToSave);
        }
        saveAppointments(); refreshUI(); closeModal(modal); showAlert(`Appuntamento ${isEditing ? 'aggiornato' : 'salvato'}.`, 'success');
    }
    
    function deleteAppointment() { if (!editingAppointmentId || !confirm('Eliminare questo appuntamento?')) return; allAppointments = allAppointments.filter(apt => apt.id !== editingAppointmentId); saveAppointments(); refreshUI(); closeModal(editAppointmentModal); showAlert('Appuntamento eliminato.', 'success'); }
    function deleteAllCalendar() { if (allAppointments.length === 0 || !confirm(`Eliminare TUTTI i ${allAppointments.length} appuntamenti?`)) return; allAppointments = []; saveAppointments(); refreshUI(); showAlert('Calendario eliminato.', 'success'); }
    function exportAppointments() { if (allAppointments.length === 0) return showAlert('Nessun appuntamento da esportare.', 'info'); const dataStr = JSON.stringify(allAppointments, null, 2); const dataBlob = new Blob([dataStr], {type: 'application/json'}); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = `calendario_${formatDateISO(new Date())}.json`; link.click(); URL.revokeObjectURL(url); }
    function importAppointments() { const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; input.onchange = e => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = event => { try { const imported = JSON.parse(event.target.result); if (!Array.isArray(imported)) throw new Error('Formato non valido'); allAppointments.push(...imported); saveAppointments(); refreshUI(); showAlert(`${imported.length} appuntamenti importati.`, 'success'); } catch (error) { showAlert('Errore nell\'importazione del file.', 'danger'); } }; reader.readAsText(file); }; input.click(); }
    
    function printCurrentView() {
        const calendarGridHTML = document.getElementById('calendar-grid').innerHTML; const appointmentsListHTML = document.getElementById('appointments-list').innerHTML; const calendarTitleText = document.getElementById('calendar-title').textContent;
        const printStyles = `<style>@media print{@page{size:A4;margin:20mm;}body{font-family:sans-serif;color:#000;}h1,h2,h3{color:#000;margin-bottom:0.5em;} .print-container{width:100%;} .calendar-section,.appointments-section{page-break-inside:avoid;margin-bottom:20px;border:1px solid #ccc;border-radius:8px;padding:15px;} .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;border:1px solid #ccc;} .calendar-header,.calendar-day{text-align:center;padding:5px;border:1px solid #eee;} .calendar-day.other-month{visibility:hidden;} .calendar-header{font-weight:bold;background-color:#f0f0f0;} .calendar-day-number{font-size:12px;color:black !important;} .multiday-event-bg{background-color:#e9e9e9 !important;} .appointment-dot{display:inline-block;width:6px;height:6px;border-radius:50%;background-color:#000 !important;} .appointment-item{font-size:10pt;border-bottom:1px solid #eee;padding:8px 0;page-break-inside:avoid;} .appointment-time{font-size:0.9em;color:#555;} .appointment-title{font-weight:bold;} .no-appointments{text-align:center;color:#777;font-style:italic;}}</style>`;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`<html><head><title>Stampa Calendario</title>${printStyles}</head><body><div class="print-container"><div class="calendar-section"><h2>${calendarTitleText}</h2><div class="calendar-grid">${calendarGridHTML}</div></div><div class="appointments-section"><div class="appointments-list">${appointmentsListHTML}</div></div></div></body></html>`);
        printWindow.document.close();
        setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
    }
    
    function refreshUI() { generateCalendar(); updateAppointmentsList(); updateSelectedDateInfo(); }
    const toggleTimeInputs = (modal, shouldDisable) => modal.querySelectorAll('.time-inputs-container input').forEach(input => input.disabled = shouldDisable);

    appointmentAllDay.addEventListener('change', e => toggleTimeInputs(newAppointmentModal, e.target.checked));
    editAppointmentAllDay.addEventListener('change', e => toggleTimeInputs(editAppointmentModal, e.target.checked));
    appointmentsTabs.addEventListener('click', (e) => { if (e.target.classList.contains('tab-btn')) { currentView = e.target.dataset.view; appointmentsTabs.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); refreshUI(); } });
    prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); generateCalendar(); });
    nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); generateCalendar(); });
    todayBtn.addEventListener('click', () => { currentDate = new Date(); selectedDate = new Date(); refreshUI(); });
    newAppointmentBtn.addEventListener('click', openNewAppointmentModal);
    saveAppointmentBtn.addEventListener('click', () => saveAppointment(false));
    saveEditAppointmentBtn.addEventListener('click', () => saveAppointment(true));
    deleteAppointmentBtn.addEventListener('click', deleteAppointment);
    cancelAppointmentBtn.addEventListener('click', () => closeModal(newAppointmentModal));
    cancelEditAppointmentBtn.addEventListener('click', () => closeModal(editAppointmentModal));
    document.querySelectorAll('.modal .close-btn').forEach(btn => btn.addEventListener('click', () => { closeModal(newAppointmentModal); closeModal(editAppointmentModal); }));
    deleteAllCalendarBtn.addEventListener('click', deleteAllCalendar);
    exportCalendarBtn.addEventListener('click', exportAppointments);
    importCalendarBtn.addEventListener('click', importAppointments);
    printCalendarBtn.addEventListener('click', printCurrentView);

    function init() { loadAppointments(); refreshUI(); }
    init();
});

/* ===== AMMINISTRAZIONE.JS ===== */
/**
 * AMMINISTRAZIONE.JS
 * Gestione completa della sezione amministrazione clienti (Versione Finale Corretta)
 */

document.addEventListener('DOMContentLoaded', () => {
    // Riferimenti DOM
    const clientsGrid = document.getElementById('clients-grid');
    const searchClientInput = document.getElementById('search-client-input');
    const clearClientSearchBtn = document.getElementById('clear-client-search-btn');
    const showHideClientsBtn = document.getElementById('show-hide-clients-btn');
    const filterCreditBtn = document.getElementById('filter-credit-btn');
    const filterDebtBtn = document.getElementById('filter-debt-btn');
    const newClientBtn = document.getElementById('new-client-btn');
    const importClientsBtn = document.getElementById('import-clients-btn');
    const exportClientsBtn = document.getElementById('export-clients-btn');
    const printClientsBtn = document.getElementById('print-clients-btn');
    const newClientModal = document.getElementById('new-client-modal');
    const closeClientModalBtn = document.getElementById('close-client-modal-btn');
    const saveClientBtn = document.getElementById('save-client-btn');
    const transactionModal = document.getElementById('transaction-modal');
    const closeTransactionModalBtn = document.getElementById('close-transaction-modal-btn');
    const clientNameHeader = document.getElementById('client-name-header');
    const clientBalanceHeader = document.getElementById('client-balance-header');
    const confirmTransactionBtn = document.getElementById('confirm-transaction-btn');
    const payFullBtn = document.getElementById('pay-full-btn');
    const payPartialBtn = document.getElementById('pay-partial-btn');
    const deleteClientBtn = document.getElementById('delete-client-btn');
    const viewHistoryBtn = document.getElementById('view-history-btn');
    const printTransactionBtn = document.getElementById('print-transaction-btn');
    const historyModal = document.getElementById('history-modal');
    const closeHistoryModalBtn = document.getElementById('close-history-modal-btn');
    const historyClientName = document.getElementById('history-client-name');
    const historyTableBody = document.getElementById('history-table-body');
    const summaryTotalClients = document.getElementById('summary-total-clients');
    const summaryNetBalance = document.getElementById('summary-net-balance');
    const summaryActiveCredits = document.getElementById('summary-active-credits');
    const summaryActiveDebts = document.getElementById('summary-active-debts');

    // Stato Globale
    let allClients = [];
    let displayedClients = [];
    let currentClientIndex = -1;
    let currentFilter = 'all';
    let isHidden = false;

    // Funzioni utility
    const showAlert = (message, type = 'info') => {
        const customAlertBox = document.getElementById('custom-alert-box');
        if (!customAlertBox) return;
        customAlertBox.innerHTML = message;
        customAlertBox.className = 'custom-alert';
        if (type) customAlertBox.classList.add(type);
        customAlertBox.classList.add('show');
        setTimeout(() => {
            customAlertBox.classList.remove('show');
            setTimeout(() => { customAlertBox.className = 'custom-alert'; }, 400);
        }, 3000);
    };

    const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
    const parseCurrency = (value) => parseFloat((value || '0').toString().replace(/[^0-9,.-]/g, '').replace(',', '.')) || 0;
    const formatCurrency = (value) => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(value);
    const formatDate = (dateStr) => new Date(dateStr).toLocaleDateString('it-IT');
    const getTodayISO = () => new Date().toISOString().split('T')[0];
    const parseItalianDate = (dateStr) => {
        if (!dateStr || !dateStr.includes('/')) return getTodayISO();
        const parts = dateStr.split('/');
        if (parts.length !== 3) return getTodayISO();
        return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
    };

    function calculateClientTotal(client) {
        return client.transactions.reduce((total, transaction) => total + (parseFloat(transaction.amount) || 0), 0);
    }

    function applyFilters() {
        const searchTerm = (searchClientInput?.value || '').toLowerCase();
        let filtered = allClients;

        if (searchTerm) {
            filtered = filtered.filter(client => client.name.toLowerCase().includes(searchTerm));
        }

        if (currentFilter === 'credit') {
            filtered = filtered.filter(client => calculateClientTotal(client) < -0.005);
        } else if (currentFilter === 'debt') {
            filtered = filtered.filter(client => calculateClientTotal(client) > 0.005);
        }

        displayedClients = filtered;
        renderClients();
        updateSummaryBox();
    }

    function openTransactionModal(index) {
        currentClientIndex = index;
        const client = allClients[index];
        const total = calculateClientTotal(client);

        if (clientNameHeader) {
            clientNameHeader.innerHTML = `
                <input type="text" id="edit-client-name" value="${client.name}" 
                       style="background: transparent; border: none; font-size: inherit; font-weight: inherit; color: inherit; width: 100%;">
            `;
        }

        if (clientBalanceHeader) {
            clientBalanceHeader.textContent = formatCurrency(total);
            clientBalanceHeader.className = `balance-amount ${total > 0.005 ? 'balance-debt' : (total < -0.005 ? 'balance-credit' : '')}`;
        }

        if (transactionModal) {
            const transactionDate = document.getElementById('transaction-date');
            const transactionDescription = document.getElementById('transaction-description');
            const transactionAmount = document.getElementById('transaction-amount');
            
            if (transactionDate) transactionDate.value = formatDate(getTodayISO());
            if (transactionDescription) transactionDescription.value = '';
            if (transactionAmount) transactionAmount.value = '';
            
            transactionModal.style.display = 'flex';

            const editNameInput = document.getElementById('edit-client-name');
            if (editNameInput) {
                editNameInput.addEventListener('blur', () => {
                    const newName = editNameInput.value.trim();
                    if (newName && newName !== client.name) {
                        client.name = newName;
                        saveToLocalStorage();
                        applyFilters();
                        showAlert('Nome cliente aggiornato.', 'success');
                    }
                });

                editNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { editNameInput.blur(); } });
            }
        }
    }

    function addTransaction() {
        if (currentClientIndex < 0) return;
        
        const transactionAmount = document.getElementById('transaction-amount');
        const transactionDate = document.getElementById('transaction-date');
        const transactionDescription = document.getElementById('transaction-description');
        
        if (!transactionAmount) return showAlert('Errore: campo importo non trovato.', 'danger');
        
        const amount = parseCurrency(transactionAmount.value);
        if (amount <= 0) return showAlert('L\'importo deve essere maggiore di zero.', 'danger');

        allClients[currentClientIndex].transactions.push({
            date: transactionDate ? parseItalianDate(transactionDate.value) : getTodayISO(),
            description: transactionDescription ? (transactionDescription.value.trim() || 'Carburante') : 'Carburante',
            amount: amount,
            timestamp: new Date().toISOString()
        });
        saveToLocalStorage();
        applyFilters();
        openTransactionModal(currentClientIndex);
        showAlert('Addebito aggiunto.', 'success');
    }

    function payFull() {
        if (currentClientIndex < 0) return;
        const client = allClients[currentClientIndex];
        const total = calculateClientTotal(client);

        if (Math.abs(total) < 0.005) {
            showAlert('Il cliente ha già saldato.', 'info');
            return;
        }

        if (!confirm(`Confermi il pagamento completo di ${formatCurrency(Math.abs(total))}? Lo storico verrà azzerato.`)) return;

        // MODIFICA: Azzera completamente lo storico dopo il saldo
        client.transactions = [];

        saveToLocalStorage();
        applyFilters();
        setTimeout(() => openTransactionModal(currentClientIndex), 100);
        showAlert('Pagamento completo registrato. Storico azzerato.', 'success');
    }

    function payPartial() {
        if (currentClientIndex < 0) return;
        const client = allClients[currentClientIndex];
        const total = calculateClientTotal(client);

        const amountStr = prompt(`Inserisci l'importo dell'acconto (saldo attuale: ${formatCurrency(total)}):`);
        if (!amountStr) return;

        const amount = parseCurrency(amountStr);
        if (amount <= 0) {
            showAlert('L\'importo deve essere maggiore di zero.', 'danger');
            return;
        }

        if (total > 0.005 && amount > total) {
            if (!confirm(`L'importo inserito (${formatCurrency(amount)}) è superiore al debito (${formatCurrency(total)}). Continuare?`)) return;
        }

        client.transactions.push({
            date: getTodayISO(),
            description: 'Acconto',
            amount: -amount,
            timestamp: new Date().toISOString()
        });

        saveToLocalStorage();
        applyFilters();
        setTimeout(() => openTransactionModal(currentClientIndex), 100);
        showAlert('Acconto registrato.', 'success');
    }

    function deleteClient() {
        if (currentClientIndex < 0) return;
        const client = allClients[currentClientIndex];

        if (confirm(`Sei sicuro di voler eliminare il cliente "${client.name}"? Questa azione non può essere annullata.`)) {
            allClients.splice(currentClientIndex, 1);
            saveToLocalStorage();
            applyFilters();
            closeTransactionModal();
            showAlert('Cliente eliminato.', 'success');
        }
    }

    function openHistoryModal() {
        if (currentClientIndex < 0) return;
        const client = allClients[currentClientIndex];
        if (historyClientName) historyClientName.textContent = client.name;
        renderHistory(client);
        if (historyModal) historyModal.style.display = 'flex';
    }

    function saveNewClient() {
        const clientNameInput = document.getElementById('client-name-input');
        const clientInitialBalanceInput = document.getElementById('client-initial-balance');
        
        if (!clientNameInput) return showAlert('Errore: campo nome non trovato.', 'danger');
        
        const name = clientNameInput.value.trim();
        const initialBalance = clientInitialBalanceInput ? parseCurrency(clientInitialBalanceInput.value) : 0;

        if (!name) {
            showAlert('Inserisci il nome del cliente.', 'danger');
            return;
        }

        const newClient = {
            id: generateId(),
            name: name,
            color: window.MemoriaStorage ? window.MemoriaStorage.getNextColor('amministrazione') : '#1D62EC',
            transactions: []
        };

        if (initialBalance > 0) {
            newClient.transactions.push({
                date: getTodayISO(),
                description: 'Credito iniziale',
                amount: -initialBalance,
                timestamp: new Date().toISOString()
            });
        }

        allClients.push(newClient);
        saveToLocalStorage();
        applyFilters();
        closeNewClientModal();
        
        // Pulisci i campi solo se esistono
        if (clientNameInput) clientNameInput.value = '';
        if (clientInitialBalanceInput) clientInitialBalanceInput.value = '';
        
        showAlert('Cliente aggiunto.', 'success');
    }

    function handleHistoryTableEvents(e) {
        const target = e.target;
        const row = target.closest('tr');
        if (!row || !row.dataset.transIndex) return;

        const transIndex = parseInt(row.dataset.transIndex, 10);
        const client = allClients[currentClientIndex];

        if (isNaN(transIndex) || !client || !client.transactions[transIndex]) {
            return showAlert("Errore nell'identificare la transazione.", 'danger');
        }

        if (target.closest('.history-delete-btn')) {
            if (confirm('Sei sicuro di voler eliminare questa transazione?')) {
                client.transactions.splice(transIndex, 1);
                saveToLocalStorage();
                renderHistory(client);
                applyFilters();
                showAlert('Transazione eliminata.');
            }
        } else if (target.matches('.history-input')) {
            target.addEventListener('change', () => {
                const transaction = client.transactions[transIndex];
                const field = target.dataset.field;
                if (field === 'date') transaction.date = parseItalianDate(target.value);
                else if (field === 'description') transaction.description = target.value;
                else if (field === 'amount') transaction.amount = parseCurrency(target.value);
                saveToLocalStorage();
                applyFilters();
            }, { once: true });
        }
    }

    function exportClients() {
        if (allClients.length === 0) return showAlert("Nessun cliente da esportare.", 'info');
        const exportData = {
            version: "1.0",
            type: "MyStation_Clients",
            exportedAt: new Date().toISOString(),
            data: allClients
        };
        const dataStr = JSON.stringify(exportData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `clienti_amministrazione_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showAlert('Clienti esportati con successo.', 'success');
    }

    function importClients() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const parsedJson = JSON.parse(event.target.result);
                    let importedClients = [];
                    if (parsedJson && typeof parsedJson === 'object' && Array.isArray(parsedJson.data)) {
                        importedClients = parsedJson.data;
                    } else if (Array.isArray(parsedJson)) {
                        importedClients = parsedJson;
                    } else {
                        throw new Error('Formato del file JSON non valido.');
                    }
                    if (confirm(`Vuoi importare ${importedClients.length} clienti? I clienti esistenti verranno mantenuti.`)) {
                        importedClients.forEach(client => {
                            client.id = client.id || generateId();
                            client.color = client.color || (window.MemoriaStorage ? window.MemoriaStorage.getNextColor('amministrazione') : '#1D62EC');
                            client.transactions = client.transactions || [];
                        });
                        allClients = [...allClients, ...importedClients];
                        saveToLocalStorage();
                        applyFilters();
                        showAlert(`${importedClients.length} clienti importati.`, 'success');
                    }
                } catch (error) {
                    showAlert('Errore importazione: ' + error.message, 'danger');
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    function printClientList() {
        if (displayedClients.length === 0) return showAlert("Nessun cliente da stampare.", 'info');
        const printWindow = window.open('', '_blank');
        
        // MODIFICA: Aumentato considerevolmente le dimensioni dei font per sfruttare lo spazio verticale
        let content = `<html><head><title>Lista Clienti</title><style>
            body{font-family:Arial,sans-serif;font-size:18px;line-height:1.6;margin:20px} 
            h1{font-size:32px;margin-bottom:30px;text-align:center} 
            table{width:100%;border-collapse:collapse;font-size:20px} 
            th,td{border:2px solid #333;padding:15px 20px;text-align:left} 
            th{background-color:#f2f2f2;font-size:22px;font-weight:bold} 
            .debt{color:red;font-weight:bold} 
            .credit{color:green;font-weight:bold}
            h3{font-size:26px;margin-top:40px;margin-bottom:20px}
            p{font-size:20px;margin:10px 0}
        </style></head><body>
        <h1>Lista Clienti (${new Date().toLocaleDateString('it-IT')})</h1>
        <table><thead><tr><th>Nome Cliente</th><th>Saldo</th><th>Stato</th></tr></thead><tbody>`;

        displayedClients.forEach(client => {
            const total = calculateClientTotal(client);
            const status = total > 0.005 ? 'Da pagare' : (total < -0.005 ? 'Credito' : 'Saldato');
            const className = total > 0.005 ? 'debt' : (total < -0.005 ? 'credit' : '');
            content += `<tr><td>${client.name}</td><td class="${className}">${formatCurrency(total)}</td><td>${status}</td></tr>`;
        });

        const totalDebt = displayedClients.reduce((sum, c) => (calculateClientTotal(c) > 0 ? sum + calculateClientTotal(c) : sum), 0);
        const totalCredit = displayedClients.reduce((sum, c) => (calculateClientTotal(c) < 0 ? sum + Math.abs(calculateClientTotal(c)) : sum), 0);

        content += `</tbody></table><h3>Riepilogo</h3><p>Totale debiti: <span class="debt">${formatCurrency(totalDebt)}</span></p><p>Totale crediti: <span class="credit">${formatCurrency(totalCredit)}</span></p></body></html>`;

        printWindow.document.write(content);
        printWindow.document.close();
        printWindow.print();
    }

    function printClientStatement() {
        if (currentClientIndex < 0) return showAlert("Nessun cliente selezionato.", 'info');
        const client = allClients[currentClientIndex];
        const printWindow = window.open('', '_blank');
        let content = `<html><head><title>Estratto Conto: ${client.name}</title><style>
            body{font-family:Arial,sans-serif} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ccc;padding:8px;text-align:left} th{background-color:#f2f2f2} .total-row{font-weight:bold;background-color:#f2f2f2} .credit{color:green} .debt{color:red}
        </style></head><body>
        <h2>Estratto Conto: ${client.name}</h2><h4>Data: ${new Date().toLocaleDateString('it-IT')}</h4>
        <table><thead><tr><th>Data</th><th>Descrizione</th><th style="text-align:right">Importo</th></tr></thead><tbody>`;

        const sorted = [...client.transactions].sort((a, b) => new Date(a.date) - new Date(b.date));
        let runningTotal = 0;

        sorted.forEach(t => {
            runningTotal += t.amount;
            const className = t.amount > 0 ? 'debt' : 'credit';
            content += `<tr><td>${formatDate(t.date)}</td><td>${t.description}</td><td style="text-align:right" class="${className}">${formatCurrency(t.amount)}</td></tr>`;
        });

        const finalClass = runningTotal > 0 ? 'debt' : 'credit';
        content += `<tr class="total-row"><td colspan="2">SALDO FINALE</td><td style="text-align:right" class="${finalClass}">${formatCurrency(runningTotal)}</td></tr>`;
        content += '</tbody></table></body></html>';

        printWindow.document.write(content);
        printWindow.document.close();
        printWindow.print();
    }

    function closeNewClientModal() {
        if (newClientModal) newClientModal.style.display = 'none';
    }

    function closeTransactionModal() {
        if (transactionModal) transactionModal.style.display = 'none';
        currentClientIndex = -1;
    }

    function closeHistoryModal() {
        if (historyModal) historyModal.style.display = 'none';
    }

    function renderClients() {
        if (!clientsGrid) return;

        const clientsToRender = isHidden ? [] : displayedClients;

        if (isHidden) {
            clientsGrid.innerHTML = '<p class="no-data-message">Clicca sull\'icona occhio per mostrare.</p>';
            return;
        }

        clientsGrid.innerHTML = '';
        if (clientsToRender.length === 0) {
            clientsGrid.innerHTML = '<p class="no-data-message">Nessun cliente trovato.</p>';
            return;
        }

        clientsToRender.forEach(client => {
            const clientBox = document.createElement('div');
            const originalIndex = allClients.findIndex(c => c.id === client.id);
            clientBox.className = 'client-box';
            const total = calculateClientTotal(client);
            const totalClass = total > 0.005 ? 'client-debt' : (total < -0.005 ? 'client-credit' : '');

            clientBox.innerHTML = `
                <div class="client-header">
                    <div class="client-icon-container" style="background: ${client.color || '#1D62EC'}"><i data-lucide="handshake"></i></div>
                    <h3 class="client-name">${client.name || 'Sconosciuto'}</h3>
                </div>
                <p class="client-total-grid ${totalClass}">${formatCurrency(Math.abs(total))}</p>
                <div class="client-status">
                    ${total > 0.005 ? '<span class="status-badge debt">Da pagare</span>' : 
                      total < -0.005 ? '<span class="status-badge credit">Credito</span>' : 
                      '<span class="status-badge paid">Saldato</span>'}
                </div>
            `;
            const openModalBtn = document.createElement('button');
            openModalBtn.className = 'client-open-modal-btn';
            openModalBtn.title = 'Apri dettagli';
            openModalBtn.innerHTML = '<i data-lucide="square-arrow-out-up-right"></i>';
            openModalBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openTransactionModal(originalIndex);
            });
            clientBox.appendChild(openModalBtn);
            clientsGrid.appendChild(clientBox);
        });
        if (window.lucide) lucide.createIcons();
    }

    function renderHistory(client) {
        if (!historyTableBody) return;
        historyTableBody.innerHTML = '';
        if (!client || client.transactions.length === 0) {
            historyTableBody.innerHTML = `<tr><td colspan="5" class="no-data-message">Nessuna transazione.</td></tr>`;
            return;
        }
        const sorted = [...client.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
        sorted.forEach(trans => {
            const index = client.transactions.indexOf(trans);
            const row = document.createElement('tr');
            row.dataset.transIndex = index;
            row.innerHTML = `
                <td><input class="history-input" value="${formatDate(trans.date)}" data-field="date"></td>
                <td><input class="history-input" value="${trans.description || ''}" data-field="description"></td>
                <td><input class="history-input" value="${formatCurrency(trans.amount)}" data-field="amount"></td>
                <td><span>${trans.amount > 0 ? 'Addebito' : 'Pagamento'}</span></td>
                <td><button class="action-btn delete-btn" title="Elimina"><i data-lucide="trash-2"></i></button></td>
            `;
            historyTableBody.appendChild(row);
        });
        if (window.lucide) lucide.createIcons();
    }

    // Logica di gestione dati
    function saveToLocalStorage() {
        if (window.MemoriaStorage) window.MemoriaStorage.saveClients(allClients);
    }

    function loadFromLocalStorage() {
        if (window.MemoriaStorage) {
            allClients = window.MemoriaStorage.loadClients().map(client => ({
                ...client,
                id: client.id || generateId(),
                color: client.color || (window.MemoriaStorage ? window.MemoriaStorage.getNextColor('amministrazione') : '#1D62EC'),
                transactions: client.transactions?.map(t => ({...t, amount: parseFloat(t.amount) || 0 })) || []
            }));
            applyFilters();
        }
    }

    function updateSummaryBox() {
        // 1. Posizioni (numero clienti totali)
        if (summaryTotalClients) summaryTotalClients.textContent = allClients.length;

        // 2. Credito concesso (saldo netto totale)
        const netBalance = allClients.reduce((total, client) => total + calculateClientTotal(client), 0);

        if (summaryNetBalance) {
            summaryNetBalance.textContent = formatCurrency(netBalance);
            summaryNetBalance.classList.remove('debt', 'credit');

            if (netBalance > 0.005) {
                summaryNetBalance.classList.add('debt');
            } else if (netBalance < -0.005) {
                // Applica il colore rosso anche per i negativi come richiesto
                summaryNetBalance.classList.add('debt');
            }
        }

        // 3. Crediti attivi (clienti con credito)
        const activeCredits = allClients.filter(client => calculateClientTotal(client) < -0.005).length;
        if (summaryActiveCredits) summaryActiveCredits.textContent = activeCredits;

        // 4. Debiti attivi (clienti con debito)
        const activeDebts = allClients.filter(client => calculateClientTotal(client) > 0.005).length;
        if (summaryActiveDebts) summaryActiveDebts.textContent = activeDebts;
    }

    // Inizializzazione
    function init() {
        loadFromLocalStorage();

        if (searchClientInput) {
            searchClientInput.addEventListener('input', () => {
                if (clearClientSearchBtn) clearClientSearchBtn.style.display = searchClientInput.value ? 'block' : 'none';
                applyFilters();
            });
        }

        if (clearClientSearchBtn) {
            clearClientSearchBtn.addEventListener('click', () => {
                searchClientInput.value = '';
                clearClientSearchBtn.style.display = 'none';
                applyFilters();
            });
        }

        if (showHideClientsBtn) {
            showHideClientsBtn.addEventListener('click', () => {
                isHidden = !isHidden;
                applyFilters();
                const iconElement = showHideClientsBtn.querySelector('i');
                if (iconElement) {
                    iconElement.setAttribute('data-lucide', isHidden ? 'eye-off' : 'eye');
                    if (window.lucide) lucide.createIcons();
                }
            });
        }

        const toggleFilter = (btn, filterType) => {
            const wasActive = currentFilter === filterType;
            currentFilter = wasActive ? 'all' : filterType;
            
            // Resetta specificamente i pulsanti filtro crediti e debiti
            [filterCreditBtn, filterDebtBtn].forEach(filterBtn => {
                if (filterBtn) {
                    filterBtn.classList.remove('active');
                    const icon = filterBtn.querySelector('i');
                    if (icon) {
                        icon.style.color = ''; // Rimuove colore personalizzato
                    }
                }
            });
            
            // Se il filtro non era attivo, attivalo e colora l'icona
            if (!wasActive) {
                btn.classList.add('active');
                const icon = btn.querySelector('i');
                if (icon) {
                    // Colori specifici per tipo di filtro
                    if (filterType === 'credit') {
                        icon.style.color = '#22c55e'; // Verde per crediti
                    } else if (filterType === 'debt') {
                        icon.style.color = '#ef4444'; // Rosso per debiti
                    }
                }
            }
            
            applyFilters();
        };

        if (filterCreditBtn) filterCreditBtn.addEventListener('click', () => toggleFilter(filterCreditBtn, 'credit'));
        if (filterDebtBtn) filterDebtBtn.addEventListener('click', () => toggleFilter(filterDebtBtn, 'debt'));
        if (newClientBtn) newClientBtn.addEventListener('click', () => { if (newClientModal) newClientModal.style.display = 'flex'; });
        if (closeClientModalBtn) closeClientModalBtn.addEventListener('click', closeNewClientModal);
        if (saveClientBtn) saveClientBtn.addEventListener('click', saveNewClient);
        if (closeTransactionModalBtn) closeTransactionModalBtn.addEventListener('click', closeTransactionModal);
        if (confirmTransactionBtn) confirmTransactionBtn.addEventListener('click', addTransaction);
        if (payFullBtn) payFullBtn.addEventListener('click', payFull);
        if (payPartialBtn) payPartialBtn.addEventListener('click', payPartial);
        if (deleteClientBtn) deleteClientBtn.addEventListener('click', deleteClient);
        if (viewHistoryBtn) viewHistoryBtn.addEventListener('click', openHistoryModal);
        if (printTransactionBtn) printTransactionBtn.addEventListener('click', printClientStatement);
        if (closeHistoryModalBtn) closeHistoryModalBtn.addEventListener('click', closeHistoryModal);
        if (historyTableBody) historyTableBody.addEventListener('click', handleHistoryTableEvents);
        if (exportClientsBtn) exportClientsBtn.addEventListener('click', exportClients);
        if (importClientsBtn) importClientsBtn.addEventListener('click', importClients);
        if (printClientsBtn) printClientsBtn.addEventListener('click', printClientList);

        // Gestione modali con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeNewClientModal();
                closeTransactionModal();
                closeHistoryModal();
            }
        });

        // Inizializza gli indicatori dei filtri
        if (clearClientSearchBtn) clearClientSearchBtn.style.display = 'none';
    }

    init();
});

/* ===== REGISTRO.JS ===== */
/**
 * REGISTRO.JS
 * Gestione completa del registro di carico con layout a tabella e filtri istantanei.
 */

document.addEventListener('DOMContentLoaded', () => {
    // Riferimenti DOM aggiornati
    const registroTableContainer = document.getElementById('registro-table-container');
    const newLoadBtn = document.getElementById('new-load-btn');
    const newLoadModal = document.getElementById('new-load-modal');
    const summaryTableContainer = document.getElementById('summary-table-container');
    const exportRegistroBtn = document.getElementById('export-registro-btn');
    const printRegistroBtn = document.getElementById('print-registro-btn');
    const closeLoadModalBtn = document.getElementById('close-load-modal-btn');
    const saveLoadBtn = document.getElementById('save-load-btn');
    const customAlertBox = document.getElementById('custom-alert-box');
    const importRegistroBtn = document.getElementById('import-registro-btn');
    const registroFileInput = document.getElementById('registro-file-input');
    const resetYearBtn = document.getElementById('reset-year-btn');

    // Nuovi riferimenti per i filtri
    const registroPeriodTabs = document.getElementById('registro-period-tabs');
    const registroValueFilter = document.getElementById('registro-value-filter');
    const printRegistroTableBtn = document.getElementById('print-registro-table-btn');

    // Stato
    let allLoads = [];
    let filteredLoads = [];
    let rimanenzeState = { benzina: 0, gasolio: 0, diesel: 0, hvolution: 0 };
    const productKeys = ['benzina', 'gasolio', 'diesel', 'hvolution'];
    const productLabels = { benzina: 'Benzina', gasolio: 'Gasolio', diesel: 'Diesel+', hvolution: 'Hvolution' };

    // ============================================
    // FUNZIONI UTILITY
    // ============================================
    function showAlert(message) { if (!customAlertBox) return; customAlertBox.textContent = message; customAlertBox.classList.add('show'); setTimeout(() => customAlertBox.classList.remove('show'), 3000); }
    const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
    const formatNumber = (num) => new Intl.NumberFormat('it-IT').format(num);
    const getTodayItalian = () => new Date().toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
    const parseItalianDate = (dateStr) => { if (!dateStr || !dateStr.includes('/')) return new Date().toISOString(); const parts = dateStr.split('/'); if (parts.length !== 3) return new Date().toISOString(); return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`; };

    // ============================================
    // GESTIONE DATI (LocalStorage)
    // ============================================
    function saveToLocalStorage() {
        if (window.MemoriaStorage) {
            window.MemoriaStorage.saveRegistro(allLoads);
            window.MemoriaStorage.saveRimanenze(rimanenzeState);
        }
    }

    function loadFromLocalStorage() {
        if (window.MemoriaStorage) {
            rimanenzeState = window.MemoriaStorage.loadRimanenze() || { benzina: 0, gasolio: 0, diesel: 0, hvolution: 0 };
            allLoads = window.MemoriaStorage.loadRegistro();
        }
        applyFilters();
    }
    
    // ============================================
    // RENDERING
    // ============================================
    function renderLoads(loads) {
        if (!registroTableContainer) return;
        registroTableContainer.innerHTML = '';

        if (loads.length === 0) {
            registroTableContainer.innerHTML = '<p class="no-data-message">Nessuna consegna trovata per i filtri selezionati.</p>';
            return;
        }

        loads.sort((a, b) => new Date(parseItalianDate(b.date)) - new Date(parseItalianDate(a.date)));
        
        let tableHTML = `
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Autista</th>
                        <th>Benzina</th>
                        <th>Gasolio</th>
                        <th>Diesel+</th>
                        <th>Hvolution</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
        `;

        loads.forEach(load => {
            tableHTML += `
                <tr>
                    <td>${load.date}</td>
                    <td>${load.driver || 'N/D'}</td>
            `;
            productKeys.forEach(key => {
                const quantity = parseFloat(load[key] || 0);
                const diffKey = `diff${key.charAt(0).toUpperCase() + key.slice(1)}`;
                const diff = parseFloat(load[diffKey] || 0);
                const diffClass = diff > 0 ? 'diff-positive' : (diff < 0 ? 'diff-negative' : '');
                const diffSign = diff > 0 ? '+' : '';

                tableHTML += `
                    <td>
                        <div class="table-cell-value">${formatNumber(quantity)} L</div>
                        <div class="table-cell-subvalue ${diffClass}">${diffSign}${formatNumber(diff)}</div>
                    </td>
                `;
            });

            tableHTML += `
                    <td class="actions-cell">
                        <button class="action-btn edit-btn" data-id="${load.id}" title="Modifica"><i data-lucide="square-pen"></i></button>
                        <button class="action-btn delete-btn" data-id="${load.id}" title="Elimina"><i data-lucide="trash-2"></i></button>
                    </td>
                </tr>
            `;
        });

        tableHTML += '</tbody></table>';
        registroTableContainer.innerHTML = tableHTML;

        lucide.createIcons();

        registroTableContainer.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', e => openNewLoadModal(e.currentTarget.dataset.id)));
        registroTableContainer.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', e => deleteLoad(e.currentTarget.dataset.id)));
    }
    
    function updateSummary(loads) {
        const summaryEl = document.getElementById('registro-summary');
        if (!summaryEl || !summaryTableContainer) return;

        let topDriver = { name: 'N/D', count: 0 };
        if (loads.length > 0) {
            const driverCounts = loads.reduce((acc, load) => { acc[load.driver] = (acc[load.driver] || 0) + 1; return acc; }, {});
            topDriver = Object.entries(driverCounts).reduce((top, [name, count]) => count > top.count ? { name, count } : top, { name: 'N/D', count: 0 });
        }

        const totals = loads.reduce((acc, load) => {
            productKeys.forEach(key => {
                const diffKey = `diff${key.charAt(0).toUpperCase() + key.slice(1)}`;
                acc.totals[key] += parseFloat(load[key] || 0);
                acc.diffs[key] += parseFloat(load[diffKey] || 0);
            });
            return acc;
        }, { totals: { benzina: 0, gasolio: 0, diesel: 0, hvolution: 0 }, diffs: { benzina: 0, gasolio: 0, diesel: 0, hvolution: 0 } });
        
        const productTotals = totals.totals;
        const productDiffs = totals.diffs;
        
        summaryEl.innerHTML = `
            <div class="summary-row">
                <div class="summary-card"><div class="summary-icon"><i data-lucide="truck"></i></div><div class="summary-content"><div class="summary-label">Consegne Effettuate</div><div class="summary-value">${loads.length}</div></div></div>
                <div class="summary-card"><div class="summary-icon"><i data-lucide="user-star"></i></div><div class="summary-content"><div class="summary-label">Top Autista</div><div class="summary-value" style="font-size: 18px;">${topDriver.name} (${topDriver.count})</div></div></div>
                <div class="summary-card"><div class="summary-icon"><i data-lucide="fuel"></i></div><div class="summary-content"><div class="summary-label">Totale Litri</div><div class="summary-value">${formatNumber(Object.values(productTotals).reduce((a, b) => a + b, 0))}</div></div></div>
            </div>
            <div class="summary-row">
                <div class="summary-card product-benzina"><div class="summary-icon"><i data-lucide="droplet"></i></div><div class="summary-content"><div class="summary-label">Totale Benzina</div><div class="summary-value">${formatNumber(productTotals.benzina)}</div></div></div>
                <div class="summary-card product-gasolio"><div class="summary-icon"><i data-lucide="droplet"></i></div><div class="summary-content"><div class="summary-label">Totale Gasolio</div><div class="summary-value">${formatNumber(productTotals.gasolio)}</div></div></div>
                <div class="summary-card product-diesel"><div class="summary-icon"><i data-lucide="droplet"></i></div><div class="summary-content"><div class="summary-label">Totale Diesel+</div><div class="summary-value">${formatNumber(productTotals.diesel)}</div></div></div>
                <div class="summary-card product-hvolution"><div class="summary-icon"><i data-lucide="droplet"></i></div><div class="summary-content"><div class="summary-label">Totale Hvolution</div><div class="summary-value">${formatNumber(productTotals.hvolution)}</div></div></div>
            </div>`;
        
        lucide.createIcons();

        const currentYear = new Date().getFullYear();
        const previousYear = currentYear - 1;
        
        let tableRowsHtml = '';
        productKeys.forEach(key => {
            const carico = productTotals[key];
            const differenza = productDiffs[key];
            const rimanenza = rimanenzeState[key] || 0;
            const contabile = carico + differenza + rimanenza;
            const diffClass = differenza > 0 ? 'diff-positive' : (differenza < 0 ? 'diff-negative' : '');
            const diffSign = differenza > 0 ? '+' : '';

            tableRowsHtml += `<tr>
                                <td>${productLabels[key]}</td>
                                <td class="carico-value">${formatNumber(carico)} L</td>
                                <td class="diff-value ${diffClass}">${diffSign}${formatNumber(differenza)}</td>
                                <td><input type="number" class="rimanenza-input" data-product="${key}" value="${rimanenza}"></td>
                                <td class="contabile-value" data-product="${key}">${formatNumber(contabile)}</td>
                              </tr>`;
        });
        
        const titleHTML = `<h3 class="summary-table-title">RIEPILOGO TOTALI (${currentYear})</h3>`;
        const tableHTML = `<table class="summary-table" id="totale-carburanti">
                                <thead>
                                    <tr>
                                        <th>Prodotto</th>
                                        <th>Carico</th>
                                        <th>Differenza</th>
                                        <th>Rimanenza (${previousYear})</th>
                                        <th>Contabile</th>
                                    </tr>
                                </thead>
                                <tbody>${tableRowsHtml}</tbody>
                           </table>`;
        summaryTableContainer.innerHTML = titleHTML + tableHTML;
    }

    function updateFilterValueOptions(period) {
        if (!registroValueFilter) return;
        const currentYear = new Date().getFullYear();
        registroValueFilter.innerHTML = '';

        if (period === 'anno') {
            const option = document.createElement('option');
            option.value = currentYear.toString();
            option.textContent = currentYear.toString();
            registroValueFilter.appendChild(option);
            registroValueFilter.disabled = true;
        } else {
            registroValueFilter.disabled = false;
            const months = [ { value: '01', label: 'Gennaio' }, { value: '02', label: 'Febbraio' }, { value: '03', label: 'Marzo' }, { value: '04', label: 'Aprile' }, { value: '05', label: 'Maggio' }, { value: '06', label: 'Giugno' }, { value: '07', label: 'Luglio' }, { value: '08', label: 'Agosto' }, { value: '09', label: 'Settembre' }, { value: '10', label: 'Ottobre' }, { value: '11', label: 'Novembre' }, { value: '12', label: 'Dicembre' } ];
            const quarters = [ { value: 'Q1', label: '1° Trimestre' }, { value: 'Q2', label: '2° Trimestre' }, { value: 'Q3', label: '3° Trimestre' }, { value: 'Q4', label: '4° Trimestre' }];
            const semesters = [ { value: 'S1', label: '1° Semestre' }, { value: 'S2', label: '2° Semestre' }];
            let options;
            switch(period) {
                case 'mese': options = months; break;
                case 'trimestre': options = quarters; break;
                case 'semestre': options = semesters; break;
            }
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.label;
                registroValueFilter.appendChild(option);
            });
        }
    }
    
    function applyFilters() {
        if (!registroPeriodTabs) return;
        const activeTab = registroPeriodTabs.querySelector('.tab-btn.active');
        if (!activeTab) return;

        const period = activeTab.dataset.period;
        const value = registroValueFilter.value;
        const currentYearString = new Date().getFullYear().toString();

        let loads = allLoads.filter(load => {
            if (!load.date || typeof load.date !== 'string') return false;
            const dateParts = load.date.split('/');
            if (dateParts.length !== 3) return false;
            const month = dateParts[1];
            const year = dateParts[2];
            
            switch(period) {
                case 'anno': return year === value;
                case 'mese': return month === value && year === currentYearString;
                case 'trimestre': const monthNum = parseInt(month, 10); const quarter = `Q${Math.ceil(monthNum / 3)}`; return quarter === value && year === currentYearString;
                case 'semestre': const semester = parseInt(month, 10) <= 6 ? 'S1' : 'S2'; return semester === value && year === currentYearString;
                default: return false;
            }
        });

        filteredLoads = loads;
        renderLoads(filteredLoads);
        updateSummary(filteredLoads);
    }
    
    function openNewLoadModal(loadId = null) { 
        if (!newLoadModal) return; 
        const form = newLoadModal.querySelector('.modal-content'); 
        const modalTitle = newLoadModal.querySelector('.modal-title');
        
        form.dataset.editId = ''; 
        
        if (loadId) { 
            const loadToEdit = allLoads.find(l => l.id === loadId); 
            if (loadToEdit) { 
                form.dataset.editId = loadId; 
                modalTitle.textContent = 'Modifica Consegna Carburante';
                
                document.getElementById('load-date').value = loadToEdit.date; 
                document.getElementById('load-driver').value = loadToEdit.driver; 
                productKeys.forEach(key => { 
                    const diffKey = `diff${key.charAt(0).toUpperCase() + key.slice(1)}`; 
                    document.getElementById(`load-${key}`).value = loadToEdit[key] || ''; 
                    document.getElementById(`load-diff-${key}`).value = loadToEdit[diffKey] || ''; 
                }); 
            } 
        } else { 
            modalTitle.textContent = 'Nuova Consegna';
            
            document.getElementById('load-date').value = getTodayItalian(); 
            document.getElementById('load-driver').value = ''; 
            productKeys.forEach(key => { 
                document.getElementById(`load-${key}`).value = ''; 
                document.getElementById(`load-diff-${key}`).value = ''; 
            }); 
        } 
        
        newLoadModal.style.display = 'flex';
    }
    
    function closeNewLoadModal() { if (newLoadModal) newLoadModal.style.display = 'none'; }
    
    function saveNewLoad() { const form = newLoadModal.querySelector('.modal-content'); const date = document.getElementById('load-date').value.trim(); const driver = document.getElementById('load-driver').value.trim(); if (!date || !driver) { showAlert('Data e Autista sono campi obbligatori.'); return; } const newLoad = { id: form.dataset.editId || generateId(), date, driver, timestamp: new Date().toISOString() }; let totalQuantity = 0; productKeys.forEach(key => { const diffKey = `diff${key.charAt(0).toUpperCase() + key.slice(1)}`; const quantity = parseFloat(document.getElementById(`load-${key}`).value) || 0; const diff = parseFloat(document.getElementById(`load-diff-${key}`).value) || 0; newLoad[key] = quantity; newLoad[diffKey] = diff; totalQuantity += quantity; }); if (totalQuantity === 0) { showAlert('Inserire la quantità per almeno un prodotto.'); return; } if (form.dataset.editId) { const index = allLoads.findIndex(l => l.id === form.dataset.editId); if (index > -1) allLoads[index] = newLoad; } else { allLoads.push(newLoad); } saveToLocalStorage(); applyFilters(); closeNewLoadModal(); showAlert('Consegna salvata con successo.'); }
    
    function deleteLoad(loadId) { if(confirm('Sei sicuro di voler eliminare questa consegna?')) { allLoads = allLoads.filter(load => load.id !== loadId); saveToLocalStorage(); applyFilters(); showAlert('Consegna eliminata.'); } }
    
    function importRegistro(file) { const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); const importedLoads = data.history || (Array.isArray(data) ? data : []); if (importedLoads.length > 0) { const newLoads = importedLoads.map(load => ({...load, id: load.id || generateId() })); allLoads = [...allLoads, ...newLoads]; saveToLocalStorage(); applyFilters(); showAlert(`${newLoads.length} consegne importate.`); } else { showAlert('Nessun dato valido trovato nel file.'); } } catch (error) { showAlert('Errore nel leggere il file JSON.'); } }; reader.readAsText(file); }
    
    function resetYear() { const currentYear = new Date().getFullYear(); const loadsFromCurrentYear = allLoads.filter(load => { const dateParts = (load.date || '').split('/'); return dateParts.length === 3 && parseInt(dateParts[2]) === currentYear; }); if (loadsFromCurrentYear.length === 0) { showAlert(`Nessuna consegna da eliminare per l'anno ${currentYear}.`); return; } if (confirm(`Sei sicuro di voler eliminare tutte le ${loadsFromCurrentYear.length} consegne del ${currentYear}? L'azione non può essere annullata.`)) { allLoads = allLoads.filter(load => { const dateParts = (load.date || '').split('/'); return dateParts.length !== 3 || parseInt(dateParts[2]) !== currentYear; }); saveToLocalStorage(); applyFilters(); showAlert(`Tutte le consegne del ${currentYear} sono state eliminate.`); } }
    
    function exportRegistro() {
        if (allLoads.length === 0) { showAlert("Nessuna consegna da esportare."); return; }
        const dataStr = JSON.stringify(allLoads, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `registro_consegne_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        showAlert("Registro esportato con successo.");
    }

    function printRegistro() {
        const summaryContent = document.getElementById('registro-summary').innerHTML;
        const summaryTableContent = document.getElementById('summary-table-container').innerHTML;
        if (!summaryContent || !summaryTableContent) {
            showAlert("Nessun riepilogo da stampare.");
            return;
        }

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`<html><head><title>Riepilogo Registro Consegne</title>
            <link rel="stylesheet" href="stile.css">
            <style>
                body { background: white; color: black; padding: 20px; font-family: 'Fredoka', sans-serif; }
                .summary-card, .summary-table-container { box-shadow: none; border: 1px solid #ccc; }
                .summary-value, .text-primary { color: black !important; }
                .summary-label, .text-muted { color: #555 !important; }
                .rimanenza-input { border: none; background: transparent; } /* Stile per la stampa */
            </style>
        </head><body>`);
        printWindow.document.write('<h1>Riepilogo Registro Consegne</h1>');
        printWindow.document.write(summaryContent);
        printWindow.document.write(summaryTableContent);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        setTimeout(() => {
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }, 500);
    }

    function printRegistroTable() {
        const tableContainer = document.getElementById('registro-table-container');
        const table = tableContainer.querySelector('table');
        if (!table) {
            showAlert("Nessuna tabella da stampare.", 'danger');
            return;
        }

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`<html><head><title>Stampa Storico Carico Carburanti</title>
            <style>
                @media print { @page { size: landscape; } }
                body { font-family: Arial, sans-serif; }
                h1 { font-size: 16pt; }
                table { width: 100%; border-collapse: collapse; font-size: 9pt; }
                th, td { border: 1px solid #ccc; padding: 6px; text-align: center; vertical-align: middle; }
                th { background-color: #f2f2f2; }
                td:nth-child(2) { text-align: left; }
                .table-cell-subvalue { font-size: 8pt; color: #666; }
                .diff-positive { color: #008000; }
                .diff-negative { color: #d90000; }
                .actions-cell { display: none; }
            </style>
        </head><body>`);
        
        let tableHTML = table.cloneNode(true);
        tableHTML.querySelectorAll('.actions-cell').forEach(cell => cell.remove());
        tableHTML.querySelector('thead tr').lastElementChild.remove();
        
        printWindow.document.write(`<h1>Storico Carico Carburanti</h1>`);
        printWindow.document.write(tableHTML.outerHTML);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        setTimeout(() => {
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }, 500);
    }

    function setupRegistroFilters() {
        if (registroPeriodTabs) {
            registroPeriodTabs.addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-btn')) {
                    registroPeriodTabs.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    updateFilterValueOptions(e.target.dataset.period);
                    applyFilters();
                }
            });
        }
        if (registroValueFilter) {
            registroValueFilter.addEventListener('change', applyFilters);
        }
    }

    // Event Listeners
    if (newLoadBtn) newLoadBtn.addEventListener('click', () => openNewLoadModal());
    if (closeLoadModalBtn) closeLoadModalBtn.addEventListener('click', closeNewLoadModal);
    if (saveLoadBtn) saveLoadBtn.addEventListener('click', saveNewLoad);
    if (importRegistroBtn) importRegistroBtn.addEventListener('click', () => registroFileInput.click());
    if (registroFileInput) registroFileInput.addEventListener('change', e => { if (e.target.files.length > 0) importRegistro(e.target.files[0]); });
    if (resetYearBtn) resetYearBtn.addEventListener('click', resetYear);
    if (exportRegistroBtn) exportRegistroBtn.addEventListener('click', exportRegistro);
    if (printRegistroBtn) printRegistroBtn.addEventListener('click', printRegistro);
    if (printRegistroTableBtn) printRegistroTableBtn.addEventListener('click', printRegistroTable);
    
    if (newLoadModal) { newLoadModal.addEventListener('click', (event) => { if (event.target.matches('.spinner-btn')) { event.preventDefault(); const button = event.target; const input = button.parentElement.querySelector('input[type=number]'); if (!input) return; const step = parseFloat(button.dataset.step); let currentValue = parseFloat(input.value) || 0; let newValue = currentValue + step; if (input.min !== '' && newValue < parseFloat(input.min)) { newValue = parseFloat(input.min); } input.value = newValue; } }); }

    if (summaryTableContainer) {
        summaryTableContainer.addEventListener('input', (event) => {
            if (event.target.classList.contains('rimanenza-input')) {
                const input = event.target;
                const product = input.dataset.product;
                const rimanenza = parseFloat(input.value) || 0;
                
                // Aggiorna e salva lo stato delle rimanenze
                rimanenzeState[product] = rimanenza;
                if (window.MemoriaStorage) {
                    window.MemoriaStorage.saveRimanenze(rimanenzeState);
                }

                // Ricalcola il contabile in tempo reale
                const parentRow = input.closest('tr');
                const contabileCell = parentRow.querySelector(`.contabile-value[data-product="${product}"]`);
                
                const caricoText = parentRow.querySelector('.carico-value').textContent.replace(/\./g, '').replace(',', '.');
                const carico = parseFloat(caricoText) || 0;

                const differenzaText = parentRow.querySelector('.diff-value').textContent.replace(/\./g, '').replace(',', '.');
                const differenza = parseFloat(differenzaText) || 0;
                
                contabileCell.textContent = formatNumber(carico + differenza + rimanenza);
            }
        });
    }

    // Inizializzazione
    setupRegistroFilters();
    updateFilterValueOptions('anno');
    loadFromLocalStorage();
});

/* ===== VIRTUALSTATION.JS ===== */
// File: virtualstation.js

document.addEventListener('DOMContentLoaded', () => {
    // Aggiunge il plugin per il calcolo delle settimane ISO
    if (window.dayjs && window.dayjs_plugin_isoWeek) {
        dayjs.extend(window.dayjs_plugin_isoWeek);
    }

    // Riferimenti DOM
    const newTurnBtn = document.getElementById('new-turn-btn');
    const newTurnModal = document.getElementById('new-turn-modal');
    const closeTurnModalBtn = document.getElementById('close-turn-modal-btn');
    const cancelTurnBtn = document.getElementById('cancel-turn-btn');
    const newTurnForm = document.getElementById('new-turn-form');

    // Riferimenti DOM per il modale di modifica
    const editTurnModal = document.getElementById('edit-turn-modal');
    const closeEditTurnModalBtn = document.getElementById('close-edit-turn-modal-btn');
    const cancelEditTurnBtn = document.getElementById('cancel-edit-turn-btn');
    const editTurnForm = document.getElementById('edit-turn-form');
    const deleteEditTurnBtn = document.getElementById('delete-edit-turn-btn');
    
    // Riferimenti DOM per lo storico
    const turnsHistoryContainer = document.getElementById('turns-history-container');
    const printTurnsTableBtn = document.getElementById('print-turns-table-btn');
    const editTableBtn = document.getElementById('edit-table-btn');
    const importBtn = document.getElementById('import-turns-btn');
    const exportBtn = document.getElementById('export-turns-btn');

    // Stato
    let allTurns = [];
    let isTableEditMode = false;

    // Costanti
    const SERVITO_MARKUP = 0.210;
    const IPERSELF_EXTRA_MARKUP = 0.005;
    const SERVITO_EXTRA_MARKUP = 0.015;
    const PRODUCTS = [
        { id: 'benzina', name: 'Benzina' }, { id: 'diesel', name: 'Diesel+' }, { id: 'gasolio', name: 'Gasolio' },
        { id: 'hvolution', name: 'Hvolution' }, { id: 'adblue', name: 'AdBlue' }
    ];

    // Funzioni Utility
    const showAlert = (message) => {
        const customAlertBox = document.getElementById('custom-alert-box');
        if (!customAlertBox) return;
        customAlertBox.textContent = message;
        customAlertBox.classList.add('show');
        setTimeout(() => customAlertBox.classList.remove('show'), 3000);
    };
    const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
    const formatNumber = (num) => new Intl.NumberFormat('it-IT').format(num);
    const formatCurrency = (num) => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(num);
    
    // Gestione Dati
    function saveTurns() { if (window.MemoriaStorage) window.MemoriaStorage.saveTurns(allTurns); }
    function loadTurns() {
        allTurns = window.MemoriaStorage ? window.MemoriaStorage.loadTurns() : [];
        renderTurnsHistoryTable();
    }

    // Gestione Modali
    function openNewTurnModal() {
        if (!newTurnModal || !newTurnForm) return;    
        newTurnForm.reset();
        const now = new Date();
        document.getElementById('turn-date').value = now.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
        document.getElementById('turn-time').value = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
        newTurnModal.style.display = 'flex';
    }
    function closeNewTurnModal() { if (newTurnModal) newTurnModal.style.display = 'none'; }
    function openEditTurnModal(turnId) {
        const turn = allTurns.find(t => t.id === turnId);
        if (!turn || !editTurnModal || !editTurnForm) return;
        editTurnForm.reset();
        document.getElementById('edit-turn-id').value = turn.id;
        document.getElementById('edit-turn-shift').value = turn.shift;
        document.getElementById('edit-turn-date').value = turn.date;
        document.getElementById('edit-turn-time').value = turn.time;
        if(turn.iperself) for (const product in turn.iperself) { if(document.getElementById(`edit-turn-iperself-${product}`)) document.getElementById(`edit-turn-iperself-${product}`).value = turn.iperself[product]; }
        if(turn.servito) for (const product in turn.servito) { if(document.getElementById(`edit-turn-servito-${product}`)) document.getElementById(`edit-turn-servito-${product}`).value = turn.servito[product]; }
        editTurnModal.style.display = 'flex';
    }
    function closeEditTurnModal() { if (editTurnModal) editTurnModal.style.display = 'none'; }
    
    // Logica Calcolo Prezzi e Totali
    function calculateTurnTotals(turn, latestPriceEntry) {
        const totals = { iperself: { liters: 0, amount: 0, products: {} }, servito: { liters: 0, amount: 0, products: {} }, grandTotal: { liters: 0, amount: 0, products: {} } };
        if (!latestPriceEntry || !latestPriceEntry.recommended) return totals;
        const { recommended, adblue: adbluePrice = 0 } = latestPriceEntry;
        const process = (source, target, mode) => {
            for (const productId in source) {
                const liters = source[productId] || 0;
                if (liters > 0) {
                    let price = 0;
                    if (mode === 'iperself') price = (recommended[productId] || 0) + IPERSELF_EXTRA_MARKUP;
                    else {
                        if (productId === 'adblue') price = adbluePrice;
                        else price = (recommended[productId] || 0) + SERVITO_MARKUP + SERVITO_EXTRA_MARKUP;
                    }
                    const amount = liters * price;
                    target.liters += liters;
                    target.amount += amount;
                    target.products[productId] = { liters, amount };
                }
            }
        };
        process(turn.iperself, totals.iperself, 'iperself');
        process(turn.servito, totals.servito, 'servito');
        totals.grandTotal.liters = totals.iperself.liters + totals.servito.liters;
        totals.grandTotal.amount = totals.iperself.amount + totals.servito.amount;
        PRODUCTS.forEach(p => {
             totals.grandTotal.products[p.id] = {
                 liters: (totals.iperself.products[p.id]?.liters || 0) + (totals.servito.products[p.id]?.liters || 0),
                 amount: (totals.iperself.products[p.id]?.amount || 0) + (totals.servito.products[p.id]?.amount || 0)
             };
        });
        return totals;
    }

    // Logica Principale
    function getTurnDataFromForm(formElement) {
        const data = new FormData(formElement);
        const turnData = { iperself: {}, servito: {} };
        for(let [key, value] of data.entries()) {
            if (key.startsWith('iperself-')) turnData.iperself[key.replace('iperself-', '')] = parseFloat(value) || 0;
            else if (key.startsWith('servito-')) turnData.servito[key.replace('servito-', '')] = parseFloat(value) || 0;
            else turnData[key] = value.trim();
        }
        return turnData;
    }
    
    function saveNewTurn(event) {
        event.preventDefault();
        const newTurnData = getTurnDataFromForm(newTurnForm);
        if (!newTurnData.shift) return showAlert('Il campo "Turno" è obbligatorio.');
        allTurns.push({ ...newTurnData, id: generateId(), timestamp: new Date().toISOString() });
        saveTurns();
        renderTurnsHistoryTable();
        closeNewTurnModal();
        showAlert('Nuovo turno salvato con successo.');
    }
    
    function saveEditedTurn(event) {
        event.preventDefault();
        const editedData = getTurnDataFromForm(editTurnForm);
        if (!editedData.shift) return showAlert('Il campo "Turno" è obbligatorio.');
        const turnIndex = allTurns.findIndex(t => t.id === editedData.id);
        if (turnIndex === -1) return showAlert('Errore: turno non trovato.');
        allTurns[turnIndex] = { ...allTurns[turnIndex], ...editedData };
        saveTurns();
        renderTurnsHistoryTable();
        closeEditTurnModal();
        showAlert('Turno aggiornato con successo.');
    }

    function deleteTurn() {
        const turnId = document.getElementById('edit-turn-id').value;
        const turnIndex = allTurns.findIndex(t => t.id === turnId);
        if (turnIndex === -1) return showAlert('Errore: turno non trovato.');
        const turn = allTurns[turnIndex];
        if (confirm(`Sei sicuro di voler eliminare il turno "${turn.shift}" del ${turn.date}?`)) {
            allTurns.splice(turnIndex, 1);
            saveTurns();
            renderTurnsHistoryTable();
            closeEditTurnModal();
            showAlert('Turno eliminato con successo.');
        }
    }
    
    // Rendering tabella storico
    function renderTurnsHistoryTable() {
        if (!turnsHistoryContainer) return;
        turnsHistoryContainer.innerHTML = '';
        if (allTurns.length === 0) {
            turnsHistoryContainer.innerHTML = '<p class="no-data-message">Nessun turno registrato.</p>';
            return;
        }
        
        const titleElement = document.querySelector('#virtualstation-content .prices-title');
        if (titleElement) {
            const currentYear = new Date().getFullYear();
            titleElement.textContent = `Storico turni (${currentYear})`;
        }
        
        const priceHistory = window.MemoriaStorage ? window.MemoriaStorage.loadPriceHistory() : [];
        const latestPriceEntry = priceHistory.length > 0 ? priceHistory[0] : null;
        
        const productHeaders = PRODUCTS.map(p => `<th>${p.name}</th>`).join('');
        let tableHTML = `<table class="history-table">
            <thead>
                <tr>
                    <th>Data/Turno</th>
                    <th>Modalità</th>
                    ${productHeaders}
                    <th>LITRI</th>
                    <th>IMPORTO</th>
                </tr>
            </thead>
            <tbody>`;
        
        const sortedTurns = [...allTurns].sort((a, b) => {
            const parseItalianDate = (dateStr) => {
                if (!dateStr || typeof dateStr !== 'string') return new Date(0);
                const parts = dateStr.split('/');
                if (parts.length !== 3) return new Date(0);
                return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
            };
            const dateA = parseItalianDate(a.date);
            const dateB = parseItalianDate(b.date);
            const dateDiff = dateB.getTime() - dateA.getTime();
            if (dateDiff !== 0) return dateDiff;
            const timeA = a.time || '00:00';
            const timeB = b.time || '00:00';
            return timeB.localeCompare(timeA);
        });
        
        sortedTurns.forEach(turn => {
            const totals = calculateTurnTotals(turn, latestPriceEntry);
            const renderProductCells = (productData, isTotal = false, turnData = null, mode = '') => PRODUCTS.map(p => {
                if (isTableEditMode && !isTotal && turnData) {
                    const value = turnData[mode]?.[p.id] || 0;
                    return `<td><input type="number" class="edit-input virtualstation-edit-input" data-turn-id="${turn.id}" data-mode="${mode}" data-product="${p.id}" value="${value}" min="0"></td>`;
                }
                const data = productData[p.id];
                return data && data.liters > 0 ? `<td>${formatNumber(data.liters)}</td>` : '<td>-</td>';
            }).join('');
            
            const dateTimeCell = isTableEditMode ? 
                `<td rowspan="3"><input type="text" class="edit-input virtualstation-edit-input" data-turn-id="${turn.id}" data-field="date" value="${turn.date}"><br><input type="text" class="edit-input virtualstation-edit-input" data-turn-id="${turn.id}" data-field="shift" value="${turn.shift}"></td>` :
                `<td rowspan="3">${turn.date}<br>${turn.shift}</td>`;
                
            tableHTML += `<tr>${dateTimeCell}<td class="mode-cell">Iperself</td>${renderProductCells(totals.iperself.products, false, turn, 'iperself')}<td>${formatNumber(totals.iperself.liters)}</td><td>${formatCurrency(totals.iperself.amount)}</td></tr>`;
            tableHTML += `<tr><td class="mode-cell">Servito</td>${renderProductCells(totals.servito.products, false, turn, 'servito')}<td>${formatNumber(totals.servito.liters)}</td><td>${formatCurrency(totals.servito.amount)}</td></tr>`;
            tableHTML += `<tr class="total-row"><td class="mode-cell">Totale</td>${renderProductCells(totals.grandTotal.products, true)}<td>${formatNumber(totals.grandTotal.liters)}</td><td>${formatCurrency(totals.grandTotal.amount)}</td></tr>`;
        });
        
        tableHTML += '</tbody></table>';
        turnsHistoryContainer.innerHTML = tableHTML;
        
        if (isTableEditMode) {
            turnsHistoryContainer.querySelectorAll('.edit-input').forEach(input => input.addEventListener('change', handleTableEdit));
        }
    }

    // Gestione Editing Tabella
    function toggleTableEditMode() {
        isTableEditMode = !isTableEditMode;
        if (editTableBtn) {
            editTableBtn.classList.toggle('active', isTableEditMode);
            editTableBtn.title = isTableEditMode ? 'Disattiva modalità modifica' : 'Attiva modalità modifica';
        }
        renderTurnsHistoryTable();
    }
    
    function handleTableEdit(e) {
        const input = e.target;
        const { turnId, field, mode, product } = input.dataset;
        const turn = allTurns.find(t => t.id === turnId);
        if (!turn) return;
        
        if (field) turn[field] = input.value;
        else if (mode && product && turn[mode]) turn[mode][product] = parseFloat(input.value) || 0;
        
        saveTurns();
        renderTurnsHistoryTable();
    }

    // Funzione di stampa
    function printTurnsTable() {
        if (allTurns.length === 0) return showAlert("Nessun dato da stampare.");
        const priceHistory = window.MemoriaStorage ? window.MemoriaStorage.loadPriceHistory() : [];
        const latestPriceEntry = priceHistory.length > 0 ? priceHistory[0] : null;
        const printWindow = window.open('', '_blank');
        let content = `<html><head><title>Stampa Storico Turni</title><style>
            @media print{@page{size:landscape}}body{font-family:Arial,sans-serif;font-size:10pt}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ccc;padding:5px;text-align:center;vertical-align:middle}th{background-color:#f2f2f2}.total-row td{background-color:#e9e9e9;font-weight:bold;border-bottom:2px solid #333}tbody{border-top:2px solid #333}td:nth-child(1),td:nth-child(2){text-align:left}.amount{color:#555;font-size:.8em}
        </style></head><body><h1>Storico Turni</h1><table><thead><tr><th>Data / Turno</th><th>Modalità</th>${PRODUCTS.map(p => `<th>${p.name}</th>`).join('')}<th>LITRI</th><th>IMPORTO</th></tr></thead>`;
        
        const sorted = [...allTurns].sort((a, b) => {
            const parseItalianDate = (dateStr) => {
                if (!dateStr || typeof dateStr !== 'string') return new Date(0);
                const parts = dateStr.split('/');
                if (parts.length !== 3) return new Date(0);
                return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
            };
            const dateA = parseItalianDate(a.date);
            const dateB = parseItalianDate(b.date);
            const dateDiff = dateB.getTime() - dateA.getTime();
            if (dateDiff !== 0) return dateDiff;
            const timeA = a.time || '00:00';
            const timeB = b.time || '00:00';
            return timeB.localeCompare(timeA);
        });
        
        sorted.forEach(turn => {
            const totals = calculateTurnTotals(turn, latestPriceEntry);
            const renderCells = (data) => PRODUCTS.map(p => `<td>${data[p.id] ? formatNumber(data[p.id].liters) : '-'}</td>`).join('');
            content += `<tbody>
                <tr><td rowspan="3">${turn.date}<br>${turn.shift}</td><td>Iperself</td>${renderCells(totals.iperself.products)}<td>${formatNumber(totals.iperself.liters)}</td><td>${formatCurrency(totals.iperself.amount)}</td></tr>
                <tr><td>Servito</td>${renderCells(totals.servito.products)}<td>${formatNumber(totals.servito.liters)}</td><td>${formatCurrency(totals.servito.amount)}</td></tr>
                <tr class="total-row"><td>Totale</td>${renderCells(totals.grandTotal.products)}<td>${formatNumber(totals.grandTotal.liters)}</td><td>${formatCurrency(totals.grandTotal.amount)}</td></tr>
            </tbody>`;
        });
        
        content += '</table></body></html>';
        printWindow.document.write(content);
        printWindow.document.close();
        setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
    }

    // Funzioni di Import/Export
    function exportTurns() {
        if (allTurns.length === 0) {
            showAlert("Nessun turno da esportare.");
            return;
        }
        
        const exportData = {
            version: "1.0",
            type: "MyStation_Turns",
            exportedAt: new Date().toISOString(),
            totalTurns: allTurns.length,
            data: allTurns
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `turni_virtualstation_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showAlert('Turni esportati con successo.');
    }

    function importTurns() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const parsedJson = JSON.parse(event.target.result);
                    
                    let importedTurns = [];
                    if (parsedJson && typeof parsedJson === 'object' && Array.isArray(parsedJson.data)) {
                        importedTurns = parsedJson.data;
                    } 
                    else if (Array.isArray(parsedJson)) {
                        importedTurns = parsedJson;
                    } 
                    else {
                        throw new Error('Formato del file JSON non valido.');
                    }
                    
                    if (importedTurns.length === 0) {
                        showAlert('Il file non contiene turni da importare.');
                        return;
                    }
                    
                    if (confirm(`Trovati ${importedTurns.length} turni da importare. Continuare?`)) {
                        const turnsToImport = importedTurns.filter(turn => turn.id && turn.shift);
                        
                        if (turnsToImport.length === 0) {
                            showAlert('Nessun turno valido trovato nel file.');
                            return;
                        }
                        
                        const existingIds = new Set(allTurns.map(t => t.id));
                        const newTurns = turnsToImport.filter(turn => !existingIds.has(turn.id));
                        
                        if (newTurns.length === 0) {
                            showAlert('Tutti i turni nel file sono già presenti.');
                            return;
                        }
                        
                        allTurns = [...allTurns, ...newTurns];
                        saveTurns();
                        renderTurnsHistoryTable();
                        
                        const duplicatesCount = turnsToImport.length - newTurns.length;
                        let message = `${newTurns.length} turni importati con successo.`;
                        if (duplicatesCount > 0) {
                            message += ` ${duplicatesCount} turni duplicati sono stati ignorati.`;
                        }
                        showAlert(message);
                    }
                } catch (error) {
                    showAlert('Errore durante l\'importazione: ' + error.message);
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    // Inizializzazione e Event Listeners
    function init() {
        if (newTurnBtn) newTurnBtn.addEventListener('click', openNewTurnModal);
        if (closeTurnModalBtn) closeTurnModalBtn.addEventListener('click', closeNewTurnModal);
        if (cancelTurnBtn) cancelTurnBtn.addEventListener('click', closeNewTurnModal);
        if (newTurnForm) newTurnForm.addEventListener('submit', saveNewTurn);
        
        if (editTurnForm) editTurnForm.addEventListener('submit', saveEditedTurn);
        if (closeEditTurnModalBtn) closeEditTurnModalBtn.addEventListener('click', closeEditTurnModal);
        if (cancelEditTurnBtn) cancelEditTurnBtn.addEventListener('click', closeEditTurnModal);
        if (deleteEditTurnBtn) deleteEditTurnBtn.addEventListener('click', deleteTurn);

        if (printTurnsTableBtn) printTurnsTableBtn.addEventListener('click', printTurnsTable);
        if (editTableBtn) editTableBtn.addEventListener('click', toggleTableEditMode);

        if (importBtn) importBtn.addEventListener('click', importTurns);
        if (exportBtn) exportBtn.addEventListener('click', exportTurns);
        
        loadTurns();
    }

    init();
});

/* ===== GESTIONE-PREZZI.JS ===== */
/**
 * GESTIONE-PREZZI.JS
 * Gestione completa della sezione gestione prezzi con filtri periodo
 */

document.addEventListener('DOMContentLoaded', () => {

    // ============================================
    // COSTANTI E CONFIGURAZIONE
    // ============================================

    // Margini da aggiungere ai prezzi consigliati per ottenere i prezzi finali
    const SERVITO_MARKUP = 0.210;
    const IPERSELF_EXTRA_MARKUP = 0.005;
    const SERVITO_EXTRA_MARKUP = 0.015;

    // Lista di tutti i prodotti gestiti
    const ALL_PRODUCTS = [
        { id: 'benzina', name: 'Benzina' },
        { id: 'diesel', name: 'Diesel+' },
        { id: 'gasolio', name: 'Gasolio' },
        { id: 'hvolution', name: 'Hvolution' },
        { id: 'adblue', name: 'AdBlue' }
    ];
    
    // Prodotti da visualizzare nella tabella dello storico (escluso AdBlue)
    const HISTORY_TABLE_PRODUCTS = ALL_PRODUCTS.filter(p => p.id !== 'adblue');
    
    // Prodotti per il modal (senza AdBlue)
    const MODAL_PRODUCTS = ALL_PRODUCTS.filter(p => p.id !== 'adblue');

    // ============================================
    // RIFERIMENTI AGLI ELEMENTI DEL DOM
    // ============================================
    const newPriceListBtn = document.getElementById('new-price-list-btn');
    const priceModal = document.getElementById('new-price-modal');
    const closePriceModalBtn = document.getElementById('close-price-modal-btn');
    const savePriceBtn = document.getElementById('save-price-btn');
    const pricesGridDisplay = document.getElementById('prices-grid-display');
    const appliedPricesDate = document.getElementById('applied-prices-date');
    
    const importBtn = document.getElementById('import-prices-btn');
    const exportBtn = document.getElementById('export-prices-btn');
    const printBtn = document.getElementById('print-report-btn');
    const fileInput = document.getElementById('prices-file-input');
    
    const historyContainer = document.getElementById('price-history-container');
    const periodTabs = document.getElementById('period-tabs');
    const valueFilter = document.getElementById('price-history-value-filter');
    const printHistoryBtn = document.getElementById('print-history-btn');

    // ============================================
    // GESTIONE FILTRI PERIODO
    // ============================================
    
    // Aggiorna il selettore dei valori in base al periodo
    function updateHistoryValueFilter(period) {
        if (!valueFilter) return;
        const currentYear = new Date().getFullYear();
        valueFilter.innerHTML = '';

        if (period === 'anno') {
            const option = document.createElement('option');
            option.value = currentYear.toString();
            option.textContent = currentYear.toString();
            valueFilter.appendChild(option);
            valueFilter.disabled = true;
        } else {
            valueFilter.disabled = false;
            const months = [
                { value: '01', label: 'Gennaio' }, { value: '02', label: 'Febbraio' }, { value: '03', label: 'Marzo' },
                { value: '04', label: 'Aprile' }, { value: '05', label: 'Maggio' }, { value: '06', label: 'Giugno' },
                { value: '07', label: 'Luglio' }, { value: '08', label: 'Agosto' }, { value: '09', label: 'Settembre' },
                { value: '10', label: 'Ottobre' }, { value: '11', label: 'Novembre' }, { value: '12', label: 'Dicembre' }
            ];
            const quarters = [
                { value: 'Q1', label: '1° Trimestre' }, { value: 'Q2', label: '2° Trimestre' },
                { value: 'Q3', label: '3° Trimestre' }, { value: 'Q4', label: '4° Trimestre' }
            ];
            const semesters = [
                { value: 'S1', label: '1° Semestre' }, { value: 'S2', label: '2° Semestre' }
            ];
            
            let options;
            switch(period) {
                case 'mese': options = months; break;
                case 'trimestre': options = quarters; break;
                case 'semestre': options = semesters; break;
            }
            
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.label;
                valueFilter.appendChild(option);
            });
        }
    }
    
    // Filtra i dati dello storico in base al periodo e valore selezionato
    function getFilteredHistory() {
        if (!periodTabs || !valueFilter) return MemoriaStorage.loadPriceHistory();
        
        const activeTab = periodTabs.querySelector('.tab-btn.active');
        if (!activeTab) return MemoriaStorage.loadPriceHistory();

        const period = activeTab.dataset.period;
        const value = valueFilter.value;
        const allHistory = MemoriaStorage.loadPriceHistory();
        const currentYearString = new Date().getFullYear().toString();

        return allHistory.filter(entry => {
            if (!entry.date || typeof entry.date !== 'string') return false;
            const dateParts = entry.date.split('/');
            if (dateParts.length !== 3) return false;
            const month = dateParts[1];
            const year = dateParts[2];
            
            switch(period) {
                case 'anno': 
                    return year === value;
                case 'mese': 
                    return month === value && year === currentYearString;
                case 'trimestre': 
                    const monthNum = parseInt(month, 10);
                    const quarter = `Q${Math.ceil(monthNum / 3)}`;
                    return quarter === value && year === currentYearString;
                case 'semestre': 
                    const semester = parseInt(month, 10) <= 6 ? 'S1' : 'S2';
                    return semester === value && year === currentYearString;
                default: 
                    return true;
            }
        });
    }

    // ============================================
    // GESTIONE MODALE NUOVO LISTINO
    // ============================================

    // Apre il modale per inserire un nuovo listino prezzi
    const openPriceModal = () => {
        if (!priceModal) return;
        
        // Reset del form
        MODAL_PRODUCTS.forEach(p => {
            const input = document.getElementById(`price-${p.id}`);
            if (input) input.value = '';
        });
        
        const dateInput = document.getElementById('price-date');
        if (dateInput) {
            const today = new Date();
            const formattedDate = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
            dateInput.value = formattedDate;
        }
        
        // Reset modalità modifica
        delete priceModal.dataset.editingId;
        priceModal.querySelector('.modal-title').textContent = 'Nuovo Listino Prezzi';
        priceModal.style.display = 'flex';
    };

    // Chiude il modale
    const closePriceModal = () => {
        if (priceModal) {
            priceModal.style.display = 'none';
            delete priceModal.dataset.editingId;
        }
    };

    // Salva un nuovo listino prezzi
    const saveNewPriceEntry = () => {
        const date = document.getElementById('price-date')?.value;
        if (!date) {
            showAlert('Inserisci la data del listino.', 'danger');
            return;
        }

        const recommended = {};
        let hasValidPrice = false;

        MODAL_PRODUCTS.forEach(p => {
            const input = document.getElementById(`price-${p.id}`);
            const value = parseFloat(input?.value?.replace(',', '.')) || 0;
            recommended[p.id] = value;
            if (value > 0) hasValidPrice = true;
        });

        if (!hasValidPrice) {
            showAlert('Inserisci almeno un prezzo valido.', 'danger');
            return;
        }

        const entry = {
            id: priceModal.dataset.editingId ? parseInt(priceModal.dataset.editingId) : Date.now(),
            date: date,
            recommended: recommended,
            adblue: priceModal.dataset.editingId ? 
                    (MemoriaStorage.loadPriceHistory().find(e => e.id == priceModal.dataset.editingId)?.adblue || 0) : 0,
            timestamp: new Date().toISOString()
        };

        let history = MemoriaStorage.loadPriceHistory();
        
        if (priceModal.dataset.editingId) {
            // Modalità modifica
            const index = history.findIndex(e => e.id == priceModal.dataset.editingId);
            if (index !== -1) {
                history[index] = entry;
                showAlert('Listino aggiornato.', 'success');
            }
        } else {
            // Nuovo listino
            history.unshift(entry);
            showAlert('Nuovo listino salvato.', 'success');
        }

        MemoriaStorage.saveAllPriceHistory(history);
        loadCurrentPrices();
        updatePriceHistory();
        closePriceModal();
    };

    // Salva il prezzo AdBlue
    const saveAdbluePrice = (price) => {
        const history = MemoriaStorage.loadPriceHistory();
        if (history.length === 0) return;
        
        const latestEntry = history[0];
        latestEntry.adblue = price;
        
        MemoriaStorage.saveAllPriceHistory(history);
        showAlert('Prezzo AdBlue aggiornato.', 'success');
    };

    // ============================================
    // GESTIONE PREZZI CORRENTI
    // ============================================

    // Carica e visualizza i prezzi correnti
    const loadCurrentPrices = () => {
        if (!pricesGridDisplay || !appliedPricesDate) return;
        
        const history = MemoriaStorage.loadPriceHistory();
        const latestEntry = history.length > 0 ? history[0] : null;
        
        // Aggiorna la data applicata
        appliedPricesDate.textContent = latestEntry ? latestEntry.date : 'Nessun listino applicato';
        
        // Pulisce il container
        pricesGridDisplay.innerHTML = '';
        
        if (!latestEntry) {
            pricesGridDisplay.innerHTML = '<p class="no-prices-message">Nessun listino prezzi disponibile. Crea il primo listino.</p>';
            return;
        }

        // Crea la card unificata
        const unifiedCard = document.createElement('div');
        unifiedCard.className = 'price-unified-card';
        
        let cardHTML = '<div class="price-columns-container">';
        
        // Colonna Iperself
        cardHTML += '<div class="price-column-unified"><h3 class="price-column-title">Iperself</h3>';
        ALL_PRODUCTS.forEach(p => {
            if (p.id === 'adblue') {
                cardHTML += `<div class="price-item invisible-price" data-product="${p.id}"></div>`;
            } else {
                const recommendedPrice = latestEntry.recommended[p.id] || 0;
                if (recommendedPrice > 0) {
                    const iperPrice = recommendedPrice + IPERSELF_EXTRA_MARKUP;
                    cardHTML += `<div class="price-item" data-product="${p.id}"><span class="price-product-name">${p.name}</span><span class="price-value">€ ${iperPrice.toFixed(3)}</span></div>`;
                } else {
                    cardHTML += `<div class="price-item disabled-price" data-product="${p.id}"><span class="price-product-name">${p.name}</span><span class="price-value">-</span></div>`;
                }
            }
        });
        cardHTML += '</div>';
        
        // Colonna Servito
        cardHTML += '<div class="price-column-unified"><h3 class="price-column-title">Servito</h3>';
        ALL_PRODUCTS.forEach(p => {
            if (p.id === 'adblue') {
                const adbluePrice = latestEntry.adblue || 0;
                cardHTML += `<div class="price-item" data-product="${p.id}">
                    <span class="price-product-name">${p.name}</span>
                    <input type="text" 
                           class="adblue-editable-input" 
                           id="adblue-price-input"
                           value="${adbluePrice > 0 ? adbluePrice.toFixed(3) : ''}" 
                           placeholder="0.000"
                           title="Clicca per modificare il prezzo AdBlue">
                </div>`;
            } else {
                const recommendedPrice = latestEntry.recommended[p.id] || 0;
                if (recommendedPrice > 0) {
                    const servitoPrice = recommendedPrice + SERVITO_MARKUP + SERVITO_EXTRA_MARKUP;
                    cardHTML += `<div class="price-item" data-product="${p.id}"><span class="price-product-name">${p.name}</span><span class="price-value">€ ${servitoPrice.toFixed(3)}</span></div>`;
                } else {
                    cardHTML += `<div class="price-item disabled-price" data-product="${p.id}"><span class="price-product-name">${p.name}</span><span class="price-value">-</span></div>`;
                }
            }
        });
        cardHTML += '</div>';
        
        cardHTML += '</div>';
        unifiedCard.innerHTML = cardHTML;
        pricesGridDisplay.appendChild(unifiedCard);

        // Aggiunge event listener per l'input AdBlue
        const adblueInput = document.getElementById('adblue-price-input');
        if (adblueInput) {
            adblueInput.addEventListener('blur', (e) => {
                const newValue = parseFloat(e.target.value.replace(',', '.')) || 0;
                saveAdbluePrice(newValue);
                // Aggiorna la visualizzazione
                if (newValue > 0) {
                    e.target.value = newValue.toFixed(3);
                } else {
                    e.target.value = '';
                }
            });
            
            adblueInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.target.blur();
                }
            });
            
            // Seleziona tutto il testo quando riceve il focus
            adblueInput.addEventListener('focus', (e) => {
                e.target.select();
            });
        }
    };

    // ============================================
    // GESTIONE STORICO PREZZI
    // ============================================

    // Aggiorna la visualizzazione dello storico prezzi (ora con filtri)
    const updatePriceHistory = () => {
        if (!historyContainer) return;
        
        const filteredHistory = getFilteredHistory();
        historyContainer.innerHTML = '';
        
        if (filteredHistory.length === 0) {
            historyContainer.innerHTML = '<p class="no-history-message">Nessun dato nello storico per il periodo selezionato.</p>';
            return;
        }

        // Creazione tabella con header
        const table = document.createElement('table');
        table.className = 'history-table';
        
        // Header tabella
        let headerHTML = '<thead><tr><th>Data</th>';
        HISTORY_TABLE_PRODUCTS.forEach(p => {
            headerHTML += `<th>${p.name}</th>`;
        });
        headerHTML += '<th>Azioni</th></tr></thead>';
        
        // Body tabella
        let bodyHTML = '<tbody>';
        filteredHistory.forEach(entry => {
            bodyHTML += `<tr data-entry-id="${entry.id}">`;
            bodyHTML += `<td class="date-cell">${entry.date}</td>`;
            
            HISTORY_TABLE_PRODUCTS.forEach(p => {
                const price = entry.recommended[p.id] || 0;
                if (price > 0) {
                    bodyHTML += `<td class="price-cell">€ ${price.toFixed(3)}</td>`;
                } else {
                    bodyHTML += `<td class="price-cell disabled">-</td>`;
                }
            });
            
            bodyHTML += `<td class="actions-cell">
                <button class="action-btn edit-btn" onclick="editPriceEntry(${entry.id})" title="Modifica">
                    <i data-lucide="square-pen"></i>
                </button>
                <button class="action-btn delete-btn" onclick="deletePriceEntry(${entry.id})" title="Elimina">
                    <i data-lucide="trash-2"></i>
                </button>
            </td>`;
            bodyHTML += '</tr>';
        });
        bodyHTML += '</tbody>';
        
        table.innerHTML = headerHTML + bodyHTML;
        historyContainer.appendChild(table);
        
        // Reinizializza le icone Lucide
        if (window.lucide) {
            window.lucide.createIcons();
        }
    };

    // Modifica una voce esistente nello storico
    window.editPriceEntry = (entryId) => {
        const history = MemoriaStorage.loadPriceHistory();
        const entry = history.find(e => e.id == entryId);
        if (!entry) return;
        
        // Popola il modal con i dati esistenti
        document.getElementById('price-date').value = entry.date;
        MODAL_PRODUCTS.forEach(p => {
            const input = document.getElementById(`price-${p.id}`);
            if (input) {
                input.value = entry.recommended[p.id] || '';
            }
        });
        
        // Imposta modalità modifica
        priceModal.dataset.editingId = entryId;
        priceModal.querySelector('.modal-title').textContent = 'Modifica Listino Prezzi';
        priceModal.style.display = 'flex';
    };

    // Elimina una voce dallo storico
    window.deletePriceEntry = (entryId) => {
        if (!confirm('Sei sicuro di voler eliminare questa voce?')) return;
        
        const history = MemoriaStorage.loadPriceHistory();
        const filteredHistory = history.filter(e => e.id != entryId);
        MemoriaStorage.saveAllPriceHistory(filteredHistory);
        
        showAlert('Voce eliminata.', 'success');
        loadCurrentPrices();
        updatePriceHistory();
    };

    // ============================================
    // IMPORT/EXPORT
    // ============================================

    // Gestione importazione prezzi
    const handleImport = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                
                if (!Array.isArray(importedData) || importedData.length === 0) {
                    showAlert('File non valido o vuoto.', 'danger');
                    return;
                }

                // Validazione struttura dati
                const isValid = importedData.every(entry => 
                    entry.hasOwnProperty('id') && 
                    entry.hasOwnProperty('date') && 
                    entry.hasOwnProperty('recommended')
                );

                if (!isValid) {
                    showAlert('Struttura dati non valida.', 'danger');
                    return;
                }

                // Salva i dati importati
                MemoriaStorage.saveAllPriceHistory(importedData);
                loadCurrentPrices();
                updatePriceHistory();
                showAlert(`Importati ${importedData.length} listini.`, 'success');
                
            } catch (error) {
                showAlert('Errore durante l\'importazione del file.', 'danger');
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    };

    // Gestione esportazione prezzi
    const handleExport = () => {
        const history = MemoriaStorage.loadPriceHistory();
        if (history.length === 0) {
            showAlert('Nessun dato da esportare.', 'warning');
            return;
        }

        const dataStr = JSON.stringify(history, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `listini_prezzi_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        showAlert('Dati esportati.', 'success');
    };

    // ============================================
    // STAMPA REPORT
    // ============================================

    // Stampa il report prezzi correnti
    const printCurrentPrices = () => {
        const history = MemoriaStorage.loadPriceHistory();
        const latestEntry = history.length > 0 ? history[0] : null;
        const competitionPrices = MemoriaStorage.loadCompetitionPrices();
        
        if (!latestEntry) {
            showAlert('Nessun listino da stampare.', 'warning');
            return;
        }

        const printWindow = window.open('', '_blank');
        if (!printWindow) {
            showAlert('Impossibile aprire la finestra di stampa.', 'danger');
            return;
        }

        printWindow.document.write(`
            <!DOCTYPE html>
            <html lang="it">
            <head>
                <meta charset="UTF-8">
                <title>Report Prezzi - ${latestEntry.date}</title>
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { font-family: Arial, sans-serif; font-size: 12px; line-height: 1.4; color: #333; padding: 20px; }
                    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                    .header h1 { font-size: 24px; margin-bottom: 5px; }
                    .header .date { font-size: 14px; color: #666; }
                    .price-section { margin-bottom: 30px; }
                    .price-section h2 { font-size: 16px; margin-bottom: 15px; color: #333; }
                    .price-card { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
                    .price-columns { display: flex; }
                    .price-column { flex: 1; padding: 15px; }
                    .price-column:first-child { border-right: 1px solid #ddd; }
                    .price-column h3 { font-size: 14px; margin-bottom: 10px; text-align: center; background: #f5f5f5; padding: 5px; border-radius: 4px; }
                    .price-item { display: flex; justify-content: space-between; margin-bottom: 8px; padding: 4px 0; }
                    .price-item:last-child { margin-bottom: 0; }
                    .price-product-name { font-weight: 500; }
                    .price-value { font-weight: bold; color: #2563eb; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Report Prezzi Carburanti</h1>
                    <div class="date">Data: ${latestEntry.date}</div>
                </div>
                
                <div class="price-section">
                    <h2>Prezzi Applicati</h2>
                    <div class="price-card">
                        <div class="price-columns">
                            <div class="price-column">
                                <h3>Iperself</h3>
        `);

        ALL_PRODUCTS.forEach(p => {
            if (p.id !== 'adblue') {
                const recommendedPrice = latestEntry.recommended[p.id] || 0;
                if (recommendedPrice > 0) {
                    const iperPrice = recommendedPrice + IPERSELF_EXTRA_MARKUP;
                    printWindow.document.write(`
                        <div class="price-item">
                            <span class="price-product-name">${p.name}</span>
                            <span class="price-value">€ ${iperPrice.toFixed(3)}</span>
                        </div>
                    `);
                } else {
                    printWindow.document.write(`
                        <div class="price-item">
                            <span class="price-product-name">${p.name}</span>
                            <span class="price-value">-</span>
                        </div>
                    `);
                }
            }
        });
        
        printWindow.document.write(`
                            </div>
                            <div class="price-column">
                                <h3>Servito</h3>
        `);

        ALL_PRODUCTS.forEach(p => {
            if (p.id === 'adblue') {
                const adbluePrice = latestEntry.adblue || 0;
                printWindow.document.write(`
                    <div class="price-item">
                        <span class="price-product-name">${p.name}</span>
                        <span class="price-value">${adbluePrice > 0 ? '€ ' + adbluePrice.toFixed(3) : '-'}</span>
                    </div>
                `);
            } else {
                const recommendedPrice = latestEntry.recommended[p.id] || 0;
                if (recommendedPrice > 0) {
                    const servitoPrice = recommendedPrice + SERVITO_MARKUP + SERVITO_EXTRA_MARKUP;
                    printWindow.document.write(`
                        <div class="price-item">
                            <span class="price-product-name">${p.name}</span>
                            <span class="price-value">€ ${servitoPrice.toFixed(3)}</span>
                        </div>
                    `);
                } else {
                    printWindow.document.write(`
                        <div class="price-item">
                            <span class="price-product-name">${p.name}</span>
                            <span class="price-value">-</span>
                        </div>
                    `);
                }
            }
        });
        
        printWindow.document.write(`
                            </div>
                        </div>
                    </div>
                </div>
            </body>
            </html>
        `);
        printWindow.document.close();
        
        printWindow.onload = () => {
            printWindow.print();
            printWindow.close();
        };
    };

    // ============================================
    // UTILITY
    // ============================================

    // Mostra messaggi di alert
    const showAlert = (message, type = 'info') => {
        // Implementazione semplificata - puoi personalizzare
        alert(message);
    };

    // ============================================
    // EVENT LISTENERS
    // ============================================

    // Eventi per il modale
    if (newPriceListBtn) {
        newPriceListBtn.addEventListener('click', openPriceModal);
    }
    
    if (closePriceModalBtn) {
        closePriceModalBtn.addEventListener('click', closePriceModal);
    }
    
    if (savePriceBtn) {
        savePriceBtn.addEventListener('click', saveNewPriceEntry);
    }

    // Eventi per import/export
    if (importBtn) {
        importBtn.addEventListener('click', () => fileInput?.click());
    }
    
    if (fileInput) {
        fileInput.addEventListener('change', handleImport);
    }
    
    if (exportBtn) {
        exportBtn.addEventListener('click', handleExport);
    }
    
    if (printBtn) {
        printBtn.addEventListener('click', printCurrentPrices);
    }

    // Eventi per i filtri periodo
    if (periodTabs) {
        periodTabs.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-btn')) {
                // Rimuovi active dalla tab corrente
                periodTabs.querySelector('.active')?.classList.remove('active');
                // Aggiungi active alla nuova tab
                e.target.classList.add('active');
                // Aggiorna il filtro valore
                updateHistoryValueFilter(e.target.dataset.period);
                // Aggiorna lo storico
                updatePriceHistory();
            }
        });
    }
    
    if (valueFilter) {
        valueFilter.addEventListener('change', () => {
            updatePriceHistory();
        });
    }

    // Chiusura modale cliccando fuori
    if (priceModal) {
        priceModal.addEventListener('click', (e) => {
            if (e.target === priceModal) {
                closePriceModal();
            }
        });
    }

    // ============================================
    // INIZIALIZZAZIONE
    // ============================================

    // Inizializza i filtri
    if (periodTabs && valueFilter) {
        const activeTab = periodTabs.querySelector('.tab-btn.active');
        if (activeTab) {
            updateHistoryValueFilter(activeTab.dataset.period);
        }
    }

    // Carica i dati all'avvio
    loadCurrentPrices();
    updatePriceHistory();
});

/* ===== CONCORRENZA.JS ===== */
document.addEventListener('DOMContentLoaded', () => {

    // ============================================
    // COSTANTI E CONFIGURAZIONE
    // ============================================

    const competitors = [
        { id: 'myoil', name: 'MyOil' },
        { id: 'esso', name: 'Esso' },
        { id: 'q8', name: 'Q8' }
    ];
    const products = ['benzina', 'gasolio'];
    const IPERSELF_EXTRA_MARKUP = 0.005;

    // ============================================
    // RIFERIMENTI AGLI ELEMENTI DEL DOM
    // ============================================
    const competitionBtn = document.getElementById('competition-btn');
    const competitionModal = document.getElementById('competition-modal');
    const closeCompetitionModalBtn = document.getElementById('close-competition-modal-btn');
    const saveCompetitionBtn = document.getElementById('save-competition-btn');
    const competitionGridDisplay = document.getElementById('competition-grid-display');

    // ============================================
    // GESTIONE MODALE
    // ============================================

    // Apre il modale per inserire i prezzi della concorrenza
    const openCompetitionModal = () => {
        const currentPrices = MemoriaStorage.loadCompetitionPrices();
        
        // Carica i prezzi esistenti nei campi del modale
        competitors.forEach(c => {
            products.forEach(p => {
                const input = document.getElementById(`comp-${c.id}-${p}`);
                if (input) {
                    input.value = (currentPrices[c.id] && currentPrices[c.id][p]) ? currentPrices[c.id][p] : '';
                }
            });
        });
        
        competitionModal.style.display = 'flex';
    };

    // Chiude il modale
    const closeCompetitionModal = () => {
        competitionModal.style.display = 'none';
    };

    // Salva i dati della concorrenza
    const saveCompetitionData = () => {
        const pricesToSave = {};
        
        // Raccoglie i prezzi dai campi input
        competitors.forEach(c => {
            pricesToSave[c.id] = {};
            products.forEach(p => {
                const input = document.getElementById(`comp-${c.id}-${p}`);
                if (input && input.value) {
                    pricesToSave[c.id][p] = parseFloat(input.value.replace(',', '.')) || 0;
                }
            });
        });

        // Salva i dati e aggiorna la visualizzazione
        MemoriaStorage.saveCompetitionPrices(pricesToSave);
        renderCompetitionPrices();
        closeCompetitionModal();

        // Mostra messaggio di successo
        if (window.showAlert) {
            window.showAlert('<strong>Successo!</strong> Dati concorrenza salvati.', 'success');
        }
    };

    // ============================================
    // RENDERING PREZZI CONCORRENZA (CORRETTO)
    // ============================================

    // Funzione principale per renderizzare i prezzi della concorrenza
    window.renderCompetitionPrices = () => {
        competitionGridDisplay.innerHTML = '';
        const competitionPrices = MemoriaStorage.loadCompetitionPrices();
        const myPriceHistory = MemoriaStorage.loadPriceHistory();
        const myPrices = myPriceHistory.length > 0 ? myPriceHistory[0] : null;

        if (Object.keys(competitionPrices).length === 0) {
            competitionGridDisplay.innerHTML = '<p class="no-prices-message">Nessun dato sulla concorrenza inserito.</p>';
            return;
        }
        
        // Calcola i prezzi Iperself per le differenze
        const myIperselfPrices = {};
        if (myPrices) {
            products.forEach(p => {
                myIperselfPrices[p] = (myPrices.recommended[p] || 0) + IPERSELF_EXTRA_MARKUP;
            });
        }
        
        // Crea una singola scheda con due griglie separate
        const unifiedCard = document.createElement('div');
        unifiedCard.className = 'price-unified-card';
        
        let cardHTML = '';
        
        // PRIMA GRIGLIA: Prezzi della concorrenza
        cardHTML += '<div class="price-columns-container competition-columns">';
        
        competitors.forEach(c => {
            const competitorData = competitionPrices[c.id] || {};
            cardHTML += `<div class="price-column-unified">
                <h3 class="price-column-title">${c.name}</h3>`;
            
            // Prezzi della concorrenza
            products.forEach(p => {
                const price = competitorData[p] || 0;
                if (price > 0) {
                    cardHTML += `<div class="price-item" data-product="${p}">
                        <span class="price-product-name">${p.charAt(0).toUpperCase() + p.slice(1)}</span>
                        <span class="price-value">€ ${price.toFixed(3)}</span>
                    </div>`;
                } else {
                    cardHTML += `<div class="price-item disabled-price" data-product="${p}">
                        <span class="price-product-name">${p.charAt(0).toUpperCase() + p.slice(1)}</span>
                        <span class="price-value">-</span>
                    </div>`;
                }
            });
            
            cardHTML += '</div>';
        });
        
        cardHTML += '</div>';
        
        // DIVISORE
        cardHTML += '<div class="competition-divider"></div>';
        
        // SECONDA GRIGLIA: Differenze
        cardHTML += '<div class="price-columns-container competition-columns">';
        
        competitors.forEach(c => {
            const competitorData = competitionPrices[c.id] || {};
            cardHTML += `<div class="price-column-unified">`;
            
            // Differenze
            products.forEach(p => {
                const myPrice = myIperselfPrices[p] || 0;
                const theirPrice = competitorData[p] || 0;
                let difference = 0;
                let diffClass = 'neutral';
                let diffSign = '';

                if (myPrice > 0 && theirPrice > 0) {
                    difference = theirPrice - myPrice; // Differenza: loro - nostro
                    if (difference > 0.0005) {
                        diffClass = 'positive'; // Verde se loro sono più alti (buono per noi)
                        diffSign = '+';
                    } else if (difference < -0.0005) {
                        diffClass = 'negative'; // Rosso se loro sono più bassi (cattivo per noi)
                        diffSign = '';
                    }
                }

                cardHTML += `<div class="price-item price-difference" data-product="${p}">
                    <span class="price-product-name">${p.charAt(0).toUpperCase() + p.slice(1)}</span>
                    <span class="price-value diff-${diffClass}">
                        ${(myPrice > 0 && theirPrice > 0) ? diffSign + difference.toFixed(3) : '-.---'}
                    </span>
                </div>`;
            });
            
            cardHTML += '</div>';
        });
        
        cardHTML += '</div>';
        
        unifiedCard.innerHTML = cardHTML;
        competitionGridDisplay.appendChild(unifiedCard);
    };

    // ============================================
    // FUNZIONI DI COMPATIBILITÀ
    // ============================================

    // Funzione mantenuta per compatibilità con gestione-prezzi.js
    window.renderPriceDifferences = () => {
        return; // Non fa nulla, la logica è integrata in renderCompetitionPrices
    };

    // ============================================
    // EVENT LISTENERS
    // ============================================

    // Gestione apertura modale
    if (competitionBtn) {
        competitionBtn.addEventListener('click', openCompetitionModal);
    }
    
    // Gestione chiusura modale
    if (closeCompetitionModalBtn) {
        closeCompetitionModalBtn.addEventListener('click', closeCompetitionModal);
    }
    
    // Gestione salvataggio dati
    if (saveCompetitionBtn) {
        saveCompetitionBtn.addEventListener('click', saveCompetitionData);
    }

    // Chiusura modale cliccando fuori
    if (competitionModal) {
        competitionModal.addEventListener('click', (e) => {
            if (e.target === competitionModal) {
                closeCompetitionModal();
            }
        });
    }

    // ============================================
    // INIZIALIZZAZIONE
    // ============================================

    // Rendering iniziale dei prezzi concorrenza
    renderCompetitionPrices();
});

/* ===== STATISTICHE.JS ===== */
/**
 * STATISTICHE.JS
 * Calcola e visualizza le statistiche di vendita basate sui dati di VirtualStation.
 */
document.addEventListener('DOMContentLoaded', () => {
    // Aggiunge il plugin per il calcolo delle settimane ISO
    dayjs.extend(window.dayjs_plugin_isoWeek);

    const PRODUCTS = [
        { id: 'benzina', name: 'Benzina', color: '#2ECC71' }, 
        { id: 'diesel', name: 'Diesel+', color: '#FB8500' }, 
        { id: 'gasolio', name: 'Gasolio', color: '#FFC300' },
        { id: 'hvolution', name: 'Hvolution', color: '#42BFDD' }, 
        { id: 'adblue', name: 'AdBlue', color: '#64748B' }
    ];
    const SERVITO_MARKUP = 0.210;
    const IPERSELF_EXTRA_MARKUP = 0.005;
    const SERVITO_EXTRA_MARKUP = 0.015;

    // Riferimenti DOM
    let productSalesChart, serviceModeChart, salesTrendChart;
    const productSalesCanvas = document.getElementById('product-sales-chart');
    const serviceModeCanvas = document.getElementById('service-mode-chart');
    const salesTrendCanvas = document.getElementById('sales-trend-chart');
    const totalRevenueEl = document.getElementById('stats-total-revenue');
    const totalLitersEl = document.getElementById('stats-total-liters');
    const servitoRatioEl = document.getElementById('stats-servito-ratio');
    const topProductEl = document.getElementById('stats-top-product');
    const topProductLabelEl = document.getElementById('stats-top-product-label');
    
    // Riferimenti DOM per i filtri nella toolbar
    const statsPeriodTabs = document.getElementById('stats-period-tabs');
    const statsValueFilter = document.getElementById('stats-value-filter');
    const importStatsBtn = document.getElementById('import-stats-btn');
    const exportStatsBtn = document.getElementById('export-stats-btn');
    const printStatsBtn = document.getElementById('print-stats-btn');

    // Stato globale
    let currentPeriod = 'giornata';
    let currentValue = null;
    let filteredTurns = [];

    // Funzioni di utilità 
    const formatCurrency = (num) => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(num || 0);
    const formatNumber = (num) => new Intl.NumberFormat('it-IT').format(num || 0);
    const parseItalianDate = (dateStr) => {
        const parts = dateStr.split('/');
        return dayjs(`${parts[2]}-${parts[1]}-${parts[0]}`);
    };

    // Funzione per filtrare i turni in base al periodo selezionato
    function filterTurnsByPeriod(allTurns, period, value) {
        const today = dayjs();
        let filtered = [];

        switch (period) {
            case 'giornata':
                // Turni del giorno corrente
                const todayStr = today.format('DD/MM/YYYY');
                filtered = allTurns.filter(turn => turn.date === todayStr);
                break;

            case 'settimana':
                // Dal lunedì al sabato della settimana selezionata
                const weekNum = value || today.isoWeek();
                const year = today.year();
                const startOfWeek = dayjs().year(year).isoWeek(weekNum).startOf('isoWeek');
                const endOfWeek = startOfWeek.add(5, 'day').endOf('day'); // Fino a sabato
                
                filtered = allTurns.filter(turn => {
                    const turnDate = parseItalianDate(turn.date);
                    return turnDate.isValid() && 
                           turnDate.isSameOrAfter(startOfWeek, 'day') && 
                           turnDate.isSameOrBefore(endOfWeek, 'day');
                });
                break;

            case 'mese':
                const month = value || today.month();
                const yearMonth = today.year();
                filtered = allTurns.filter(turn => {
                    const turnDate = parseItalianDate(turn.date);
                    return turnDate.isValid() && 
                           turnDate.month() === month && 
                           turnDate.year() === yearMonth;
                });
                break;

            case 'trimestre':
                const quarter = value || `Q${Math.floor(today.month() / 3) + 1}`;
                const qNum = parseInt(quarter.replace('Q', ''));
                const yearQ = today.year();
                const startMonth = (qNum - 1) * 3;
                const endMonth = startMonth + 2;
                
                filtered = allTurns.filter(turn => {
                    const turnDate = parseItalianDate(turn.date);
                    return turnDate.isValid() && 
                           turnDate.month() >= startMonth && 
                           turnDate.month() <= endMonth && 
                           turnDate.year() === yearQ;
                });
                break;

            case 'semestre':
                const semester = value || (today.month() < 6 ? 'S1' : 'S2');
                const yearS = today.year();
                const startMonthS = semester === 'S1' ? 0 : 6;
                const endMonthS = semester === 'S1' ? 5 : 11;
                
                filtered = allTurns.filter(turn => {
                    const turnDate = parseItalianDate(turn.date);
                    return turnDate.isValid() && 
                           turnDate.month() >= startMonthS && 
                           turnDate.month() <= endMonthS && 
                           turnDate.year() === yearS;
                });
                break;

            case 'anno':
                // Tutti i turni dell'anno corrente
                const currentYear = today.year();
                filtered = allTurns.filter(turn => {
                    const turnDate = parseItalianDate(turn.date);
                    return turnDate.isValid() && turnDate.year() === currentYear;
                });
                break;
        }

        return filtered;
    }

    // Calcola i totali per un singolo turno
    function calculateTurnTotals(turn, latestPriceEntry) {
        const totals = { 
            iperself: { liters: 0, amount: 0 }, 
            servito: { liters: 0, amount: 0 },
            products: {}
        };
        PRODUCTS.forEach(p => { totals.products[p.id] = { liters: 0, revenue: 0 }; });
        if (!latestPriceEntry || !latestPriceEntry.recommended) return totals;
        const { recommended, adblue: adbluePrice = 0 } = latestPriceEntry;
        const process = (source, target, mode) => {
            for (const productId in source) {
                const liters = source[productId] || 0;
                if (liters > 0) {
                    let price = 0;
                    if (mode === 'iperself') {
                        price = (recommended[productId] || 0) + IPERSELF_EXTRA_MARKUP;
                    } else {
                        price = (productId === 'adblue') ? adbluePrice : (recommended[productId] || 0) + SERVITO_MARKUP + SERVITO_EXTRA_MARKUP;
                    }
                    const amount = liters * price;
                    target.liters += liters;
                    target.amount += amount;
                    totals.products[productId].liters += liters;
                    totals.products[productId].revenue += amount;
                }
            }
        };
        process(turn.iperself, totals.iperself, 'iperself');
        process(turn.servito, totals.servito, 'servito');
        return totals;
    }

    // Calcola le statistiche basate sui turni filtrati
    function calculateStats(turnsToAnalyze) {
        const priceHistory = window.MemoriaStorage.loadPriceHistory();
        const latestPriceEntry = priceHistory.length > 0 ? priceHistory[0] : null;
        const globalStats = {
            totalRevenue: 0, totalLiters: 0, iperselfRevenue: 0, servitoRevenue: 0,
            iperselfLiters: 0, servitoLiters: 0, productSales: {}
        };
        PRODUCTS.forEach(p => { globalStats.productSales[p.id] = { name: p.name, liters: 0, revenue: 0 }; });
        
        turnsToAnalyze.forEach(turn => {
            const turnTotals = calculateTurnTotals(turn, latestPriceEntry);
            globalStats.iperselfLiters += turnTotals.iperself.liters;
            globalStats.servitoLiters += turnTotals.servito.liters;
            globalStats.iperselfRevenue += turnTotals.iperself.amount;
            globalStats.servitoRevenue += turnTotals.servito.amount;
            for (const productId in turnTotals.products) {
                globalStats.productSales[productId].liters += turnTotals.products[productId].liters;
                globalStats.productSales[productId].revenue += turnTotals.products[productId].revenue;
            }
        });
        globalStats.totalLiters = globalStats.iperselfLiters + globalStats.servitoLiters;
        globalStats.totalRevenue = globalStats.iperselfRevenue + globalStats.servitoRevenue;
        return globalStats;
    }

    // Rendering dei box di riepilogo
    function renderSummaryBoxes(stats) {
        if (totalRevenueEl) totalRevenueEl.textContent = formatCurrency(stats.totalRevenue);
        if (totalLitersEl) totalLitersEl.textContent = formatNumber(stats.totalLiters);
        
        // Terzo box: Solo percentuale servito
        if (servitoRatioEl && stats.totalLiters > 0) {
            const servitoRatio = (stats.servitoLiters / stats.totalLiters) * 100;
            servitoRatioEl.textContent = `${servitoRatio.toFixed(1)}%`;
        } else if (servitoRatioEl) {
            servitoRatioEl.textContent = "0%";
        }
        
        // Quarto box: Prodotto top con nome dinamico
        if (topProductEl && topProductLabelEl) {
            const topProduct = Object.values(stats.productSales)
                .filter(p => p.liters > 0)
                .reduce((max, current) => current.liters > max.liters ? current : max, { name: 'N/D', liters: 0 });
            
            if (topProduct.liters > 0) {
                topProductLabelEl.textContent = topProduct.name;
                topProductEl.textContent = formatNumber(topProduct.liters);
            } else {
                topProductLabelEl.textContent = "Prodotto Top";
                topProductEl.textContent = "0";
            }
        }
    }

    // Rendering dei grafici principali
    function renderTopCharts(stats) {
        // Grafico 1: Vendite per Prodotto
        if (productSalesCanvas) {
            const productData = Object.values(stats.productSales).filter(p => p.liters > 0);
            const chartData = {
                labels: productData.map(p => p.name),
                datasets: [{
                    label: 'Litri per Prodotto',
                    data: productData.map(p => p.liters),
                    backgroundColor: productData.map(p => PRODUCTS.find(prod => prod.name === p.name).color),
                }]
            };
            if (productSalesChart) productSalesChart.destroy();
            productSalesChart = new Chart(productSalesCanvas, { 
                type: 'bar', 
                data: chartData, 
                options: { 
                    responsive: true, 
                    plugins: { legend: { display: false } } 
                } 
            });
        }

        // Grafico 2: Modalità di Servizio
        if (serviceModeCanvas) {
            const chartData = {
                labels: ['Servito', 'Iperself'],
                datasets: [{
                    data: [stats.servitoLiters, stats.iperselfLiters],
                    backgroundColor: ['#ff3399', '#707ff5'],
                    borderWidth: 0
                }]
            };
            if (serviceModeChart) serviceModeChart.destroy();
            serviceModeChart = new Chart(serviceModeCanvas, { 
                type: 'pie', 
                data: chartData, 
                options: { 
                    responsive: true, 
                    plugins: { legend: { position: 'bottom' } } 
                } 
            });
        }
    }

    // Rendering del grafico andamento vendite
    function renderSalesTrendChart() {
        if (!salesTrendCanvas) return;

        // Raggruppa i dati in base al periodo
        let grouper;
        if (currentPeriod === 'giornata') {
            // Per giornata, mostra i turni come punti individuali
            grouper = (turn) => turn.shift || 'Turno';
        } else if (currentPeriod === 'settimana') {
            // Per settimana, raggruppa per giorno
            grouper = (turn) => parseItalianDate(turn.date).format('ddd DD/MM');
        } else if (currentPeriod === 'mese') {
            // Per mese, raggruppa per giorno
            grouper = (turn) => parseItalianDate(turn.date).format('DD');
        } else if (currentPeriod === 'trimestre' || currentPeriod === 'semestre') {
            // Per trimestre/semestre, raggruppa per mese
            grouper = (turn) => parseItalianDate(turn.date).format('MMM');
        } else if (currentPeriod === 'anno') {
            // Per anno, raggruppa per mese
            grouper = (turn) => parseItalianDate(turn.date).format('MMM');
        }

        const groupedData = {};
        const labelOrder = [];
        
        filteredTurns.forEach(turn => {
            const key = grouper(turn);
            if (!groupedData[key]) {
                groupedData[key] = {};
                PRODUCTS.forEach(p => groupedData[key][p.id] = 0);
                labelOrder.push({ key, date: parseItalianDate(turn.date), shift: turn.shift });
            }
            PRODUCTS.forEach(p => {
                groupedData[key][p.id] += (turn.iperself?.[p.id] || 0) + (turn.servito?.[p.id] || 0);
            });
        });

        // Ordina le etichette
        let sortedLabels;
        if (currentPeriod === 'giornata') {
            // Per giornata, mantieni l'ordine dei turni
            sortedLabels = labelOrder.map(item => item.key);
        } else {
            // Per altri periodi, ordina per data
            sortedLabels = labelOrder
                .sort((a, b) => a.date.valueOf() - b.date.valueOf())
                .map(item => item.key);
        }

        const datasets = PRODUCTS.map(product => ({
            label: product.name,
            data: sortedLabels.map(label => groupedData[label]?.[product.id] || 0),
            borderColor: product.color,
            backgroundColor: `${product.color}33`,
            fill: false,
            tension: 0.1
        }));

        if (salesTrendChart) salesTrendChart.destroy();
        salesTrendChart = new Chart(salesTrendCanvas, {
            type: 'line',
            data: { labels: sortedLabels, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: { y: { beginAtZero: true, ticks: { callback: value => `${value} L` } } }
            }
        });
    }

    // Aggiorna il selettore dei valori in base al periodo
    function updateStatsValueFilter(period) {
        statsValueFilter.innerHTML = '';
        const allTurns = window.MemoriaStorage.loadTurns();
        const today = dayjs();
        
        let options = [];
        switch (period) {
            case 'giornata':
            case 'anno':
                // Nessuna selezione per giornata e anno
                statsValueFilter.disabled = true;
                statsValueFilter.style.display = 'none';
                break;
                
            case 'settimana':
                // Mostra le settimane disponibili dell'anno corrente
                statsValueFilter.disabled = false;
                statsValueFilter.style.display = 'block';
                const weeks = [...new Set(allTurns
                    .filter(t => parseItalianDate(t.date).year() === today.year())
                    .map(t => parseItalianDate(t.date).isoWeek()))]
                    .sort((a, b) => a - b);
                    
                if (weeks.length === 0) weeks.push(today.isoWeek());
                const currentWeek = today.isoWeek();
                
                weeks.forEach(w => {
                    const option = document.createElement('option');
                    option.value = w;
                    option.textContent = `Settimana ${w}`;
                    if (w === currentWeek) option.selected = true;
                    statsValueFilter.appendChild(option);
                });
                break;
                
            case 'mese':
                statsValueFilter.disabled = false;
                statsValueFilter.style.display = 'block';
                const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", 
                                  "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
                const currentMonth = today.month();
                
                monthNames.forEach((m, i) => {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = m;
                    if (i === currentMonth) option.selected = true;
                    statsValueFilter.appendChild(option);
                });
                break;
                
            case 'trimestre':
                statsValueFilter.disabled = false;
                statsValueFilter.style.display = 'block';
                const quarters = ['1° Trimestre', '2° Trimestre', '3° Trimestre', '4° Trimestre'];
                const currentQuarter = Math.floor(today.month() / 3) + 1;
                
                quarters.forEach((q, i) => {
                    const option = document.createElement('option');
                    option.value = `Q${i + 1}`;
                    option.textContent = q;
                    if (i + 1 === currentQuarter) option.selected = true;
                    statsValueFilter.appendChild(option);
                });
                break;
                
            case 'semestre':
                statsValueFilter.disabled = false;
                statsValueFilter.style.display = 'block';
                const semesters = ['1° Semestre', '2° Semestre'];
                const currentSemester = today.month() < 6 ? 'S1' : 'S2';
                
                semesters.forEach((s, i) => {
                    const option = document.createElement('option');
                    option.value = `S${i + 1}`;
                    option.textContent = s;
                    if (`S${i + 1}` === currentSemester) option.selected = true;
                    statsValueFilter.appendChild(option);
                });
                break;
        }
        
        currentValue = (period === 'giornata' || period === 'anno') ? null : 
                      (period === 'settimana' ? today.isoWeek() : statsValueFilter.value);
    }

    // Aggiorna tutti i dati e grafici
    function updateAllStats() {
        const allTurns = window.MemoriaStorage.loadTurns();
        
        // Filtra i turni in base al periodo selezionato
        filteredTurns = filterTurnsByPeriod(allTurns, currentPeriod, currentValue);
        
        // Calcola le statistiche sui turni filtrati
        const stats = calculateStats(filteredTurns);
        
        // Aggiorna tutti i componenti della pagina
        renderSummaryBoxes(stats);
        renderTopCharts(stats);
        renderSalesTrendChart();
    }

    // Gestione import dati
    function importStats() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    // Verifica che sia un file di statistiche valido
                    if (!importedData.turni || !Array.isArray(importedData.turni)) {
                        throw new Error('Formato file non valido. Deve contenere un array di turni.');
                    }
                    
                    // Chiedi conferma all'utente
                    const msg = `Vuoi importare ${importedData.turni.length} turni dal file?\n` +
                               `Periodo: ${importedData.periodo || 'non specificato'}\n` +
                               `Data esportazione: ${importedData.dataEsportazione ? new Date(importedData.dataEsportazione).toLocaleDateString('it-IT') : 'non specificata'}`;
                    
                    if (confirm(msg)) {
                        // Importa i turni (aggiungi ai turni esistenti)
                        const existingTurns = window.MemoriaStorage.loadTurns();
                        const newTurns = [...existingTurns, ...importedData.turni];
                        
                        // Rimuovi eventuali duplicati basandosi sull'id
                        const uniqueTurns = Array.from(new Map(newTurns.map(t => [t.id, t])).values());
                        
                        // Salva i turni aggiornati
                        window.MemoriaStorage.saveTurns(uniqueTurns);
                        
                        // Aggiorna la visualizzazione
                        updateAllStats();
                        
                        const customAlertBox = document.getElementById('custom-alert-box');
                        if (customAlertBox) {
                            customAlertBox.textContent = `${importedData.turni.length} turni importati con successo`;
                            customAlertBox.classList.add('show');
                            setTimeout(() => customAlertBox.classList.remove('show'), 3000);
                        }
                    }
                } catch (error) {
                    const customAlertBox = document.getElementById('custom-alert-box');
                    if (customAlertBox) {
                        customAlertBox.textContent = 'Errore durante l\'importazione: ' + error.message;
                        customAlertBox.classList.add('show', 'danger');
                        setTimeout(() => {
                            customAlertBox.classList.remove('show', 'danger');
                        }, 3000);
                    }
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    // Gestione export dati
    function exportStats() {
        const stats = calculateStats(filteredTurns);
        let periodoDisplay = currentPeriod;
        
        // Aggiungi informazioni sul valore selezionato per l'export
        if (currentPeriod === 'giornata') {
            periodoDisplay = `${currentPeriod}_${dayjs().format('DD-MM-YYYY')}`;
        } else if (currentPeriod === 'anno') {
            periodoDisplay = `${currentPeriod}_${dayjs().year()}`;
        } else if (currentValue) {
            periodoDisplay = `${currentPeriod}_${currentValue}`;
        }
        
        const exportData = {
            periodo: currentPeriod,
            valore: currentValue || (currentPeriod === 'anno' ? dayjs().year() : currentPeriod === 'giornata' ? dayjs().format('DD/MM/YYYY') : null),
            dataEsportazione: new Date().toISOString(),
            riepilogo: {
                fatturatoTotale: stats.totalRevenue,
                litriTotali: stats.totalLiters,
                litriIperself: stats.iperselfLiters,
                litriServito: stats.servitoLiters
            },
            venditePerProdotto: stats.productSales,
            turni: filteredTurns
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `statistiche_${periodoDisplay}_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        const customAlertBox = document.getElementById('custom-alert-box');
        if (customAlertBox) {
            customAlertBox.textContent = 'Dati esportati con successo';
            customAlertBox.classList.add('show');
            setTimeout(() => customAlertBox.classList.remove('show'), 3000);
        }
    }

    // Gestione stampa report
    function printStats() {
        const stats = calculateStats(filteredTurns);
        const printWindow = window.open('', '_blank');
        
        let periodLabel = currentPeriod.charAt(0).toUpperCase() + currentPeriod.slice(1);
        if (currentValue && currentPeriod !== 'giornata' && currentPeriod !== 'anno') {
            if (currentPeriod === 'mese') {
                const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", 
                                  "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
                periodLabel += `: ${monthNames[currentValue]}`;
            } else {
                periodLabel += `: ${statsValueFilter.options[statsValueFilter.selectedIndex]?.text || currentValue}`;
            }
        } else if (currentPeriod === 'giornata') {
            periodLabel += `: ${dayjs().format('DD/MM/YYYY')}`;
        } else if (currentPeriod === 'anno') {
            periodLabel += `: ${dayjs().year()}`;
        }
        
        printWindow.document.write(`<html><head><title>Report Statistiche - ${periodLabel}</title>
            <style>
                @media print { @page { size: portrait; } }
                body { font-family: Arial, sans-serif; margin: 20px; }
                h1 { text-align: center; color: #333; }
                .summary { display: flex; justify-content: space-around; margin: 30px 0; }
                .summary-item { text-align: center; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
                .summary-label { font-size: 12px; color: #666; text-transform: uppercase; }
                .summary-value { font-size: 24px; font-weight: bold; color: #333; margin-top: 10px; }
                table { width: 100%; border-collapse: collapse; margin-top: 30px; }
                th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
                th { background-color: #f2f2f2; font-weight: bold; }
                .footer { margin-top: 30px; text-align: center; color: #666; font-size: 12px; }
            </style>
        </head><body>`);
        
        printWindow.document.write(`<h1>Report Statistiche - ${periodLabel}</h1>`);
        
        // Riepilogo
        printWindow.document.write('<div class="summary">');
        printWindow.document.write(`<div class="summary-item"><div class="summary-label">Fatturato</div><div class="summary-value">${formatCurrency(stats.totalRevenue)}</div></div>`);
        printWindow.document.write(`<div class="summary-item"><div class="summary-label">Litri Totali</div><div class="summary-value">${formatNumber(stats.totalLiters)}</div></div>`);
        const servitoRatio = stats.totalLiters > 0 ? (stats.servitoLiters / stats.totalLiters) * 100 : 0;
        printWindow.document.write(`<div class="summary-item"><div class="summary-label">Servito</div><div class="summary-value">${servitoRatio.toFixed(1)}%</div></div>`);
        
        // Prodotto top
        const topProduct = Object.values(stats.productSales)
            .filter(p => p.liters > 0)
            .reduce((max, current) => current.liters > max.liters ? current : max, { name: 'N/D', liters: 0 });
        printWindow.document.write(`<div class="summary-item"><div class="summary-label">${topProduct.name}</div><div class="summary-value">${formatNumber(topProduct.liters)}</div></div>`);
        printWindow.document.write('</div>');
        
        // Tabella vendite per prodotto
        printWindow.document.write('<h2>Vendite per Prodotto</h2>');
        printWindow.document.write('<table><thead><tr><th>Prodotto</th><th>Litri</th><th>Fatturato</th></tr></thead><tbody>');
        Object.values(stats.productSales).forEach(p => {
            if (p.liters > 0) {
                printWindow.document.write(`<tr><td>${p.name}</td><td>${formatNumber(p.liters)}</td><td>${formatCurrency(p.revenue)}</td></tr>`);
            }
        });
        printWindow.document.write('</tbody></table>');
        
        printWindow.document.write(`<div class="footer">Report generato il ${new Date().toLocaleDateString('it-IT')} alle ${new Date().toLocaleTimeString('it-IT')}</div>`);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        
        setTimeout(() => {
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }, 500);
    }

    // Funzione principale che inizializza la pagina
    window.initStatsPage = function() {
        // Setup dei filtri nella toolbar
        if (statsPeriodTabs && statsValueFilter) {
            statsPeriodTabs.addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-btn')) {
                    statsPeriodTabs.querySelector('.active')?.classList.remove('active');
                    e.target.classList.add('active');
                    currentPeriod = e.target.dataset.period;
                    updateStatsValueFilter(currentPeriod);
                    updateAllStats();
                }
            });
            
            statsValueFilter.addEventListener('change', () => {
                currentValue = currentPeriod === 'settimana' ? 
                              parseInt(statsValueFilter.value) : 
                              (currentPeriod === 'mese' ? parseInt(statsValueFilter.value) : statsValueFilter.value);
                updateAllStats();
            });
            
            // Event listeners per import, export e stampa
            if (importStatsBtn) importStatsBtn.addEventListener('click', importStats);
            if (exportStatsBtn) exportStatsBtn.addEventListener('click', exportStats);
            if (printStatsBtn) printStatsBtn.addEventListener('click', printStats);
            
            // Inizializzazione al primo caricamento
            currentPeriod = 'giornata';
            updateStatsValueFilter(currentPeriod);
            updateAllStats();
        }
    };
});

    </script>
</body>
</html>